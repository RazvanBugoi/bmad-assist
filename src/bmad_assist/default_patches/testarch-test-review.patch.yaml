# testarch-test-review.patch.yaml - Test review workflow patch
# Extends defaults-testarch.yaml (auto-merged by discovery)
#
# Features:
# - Review scope detection (single/directory/suite)
# - Test quality validation rules
# - Knowledge base integration for quality criteria

patch:
  name: "testarch-test-review-automation"
  version: "1.0.0"
  author: "BMad"
  description: "Test review workflow patch for bmad-assist automation"

compatibility:
  bmad_version: "6.0.0-alpha.22"
  workflow: "testarch-test-review"

git_intelligence:
  enabled: true
  embed_marker: "git-intelligence"
  no_git_message: |
    This project is not under git version control.
    Focus on test file analysis instead.
  commands:
    - name: "Test Directory History"
      command: "git log --oneline -5 -- tests/"
    - name: "Test Status"
      command: "git status --short -- tests/"

transforms:
  # === SCOPE INSTRUCTION ===
  - "Add ONE CRITICAL instruction at workflow start: 'SCOPE: You are the TEA (Test Engineer Architect) agent. Review test quality, coverage, and maintainability. The {review_scope} variable indicates review scope: single (one story), directory (subdirectory), or suite (full tests/).'"

  # === REVIEW SCOPE HANDLING ===
  - "Check {review_scope} variable to determine review scope: 'single' = review tests for current story only; 'directory' = review tests in specified subdirectory; 'suite' = review entire test suite."

  # === QUALITY CRITERIA ===
  - "Apply quality criteria from embedded knowledge fragments (test-quality, risk-governance, test-healing-patterns)."
  - "Check for: test isolation, fixture usage, assertion quality, naming conventions, coverage patterns."

  # === OUTPUT FORMAT ===
  - "Generate structured review report with: findings (severity: high/medium/low), recommendations, coverage gaps."

# Post-process rules extend defaults-testarch.yaml
post_process:
  # === REVIEW-SPECIFIC CLEANUP ===
  # Replace review_scope placeholder if unresolved
  - pattern: '\{review_scope\}'
    replacement: "suite"
    flags: ""

  # Normalize severity markers
  - pattern: '\[HIGH\]'
    replacement: "[high]"
    flags: "IGNORECASE"
  - pattern: '\[MEDIUM\]'
    replacement: "[medium]"
    flags: "IGNORECASE"
  - pattern: '\[LOW\]'
    replacement: "[low]"
    flags: "IGNORECASE"

validation:
  must_contain:
    - "/[Rr]eview/"
    - "/[Qq]uality/"
  must_not_contain:
    - "{installed_path}"
