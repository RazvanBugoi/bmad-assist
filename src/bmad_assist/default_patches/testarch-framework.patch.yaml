# testarch-framework.patch.yaml - Test framework setup workflow patch
# Extends defaults-testarch.yaml (auto-merged by discovery)
#
# Features:
# - Framework detection (Playwright/Cypress)
# - Configuration templates and fixture setup
# - Page Object Model scaffolding

patch:
  name: "testarch-framework-automation"
  version: "1.0.0"
  author: "BMad"
  description: "Test framework workflow patch for bmad-assist automation with framework detection"

compatibility:
  bmad_version: "6.0.0-alpha.22"
  workflow: "testarch-framework"

git_intelligence:
  enabled: true
  embed_marker: "git-intelligence"
  no_git_message: |
    This project is not under git version control.
    Focus on framework requirements instead.
  commands:
    - name: "Test Framework Config"
      command: "git log --oneline -5 -- playwright.config.* cypress.config.* vitest.config.* jest.config.*"
    - name: "Test Directory Structure"
      command: "git ls-tree -r --name-only HEAD -- tests/ test/ e2e/ cypress/ 2>/dev/null | head -20"
    - name: "Package Dependencies"
      command: "git diff --stat HEAD~5 -- package.json pyproject.toml requirements*.txt 2>/dev/null | head -10"

transforms:
  # === SCOPE INSTRUCTION ===
  - "Add ONE CRITICAL instruction at workflow start: 'SCOPE: You are the TEA (Test Engineer Architect) agent. Initialize production-ready test framework architecture. Detect framework from package.json/pyproject.toml: Playwright, Cypress, Vitest, Jest, or pytest.'"

  # === FRAMEWORK DETECTION ===
  - "Detect existing framework from project config: package.json (playwright, cypress, vitest, jest), pyproject.toml (pytest, playwright). If none detected, recommend based on project type."

  # === CONFIGURATION TEMPLATES ===
  - "Generate appropriate config file for detected framework with best practice defaults."
  - "Include: base URL configuration, timeout settings, reporter setup, parallel execution config."

  # === FIXTURE SCAFFOLDING ===
  - "Create fixture directory structure following framework conventions."
  - "For Playwright: fixtures/, page-objects/, helpers/"
  - "For Cypress: fixtures/, support/, e2e/"
  - "For pytest: conftest.py, fixtures/"

  # === PAGE OBJECT MODEL ===
  - "Scaffold Page Object Model base class if UI testing framework detected."
  - "Include common patterns from embedded knowledge fragments."

# Post-process rules extend defaults-testarch.yaml
post_process:
  # === FRAMEWORK-SPECIFIC CLEANUP ===
  # Replace framework placeholder if unresolved
  - pattern: '\{framework\}'
    replacement: "playwright"
    flags: ""

  # Normalize framework names
  - pattern: 'Playwright Test'
    replacement: "playwright"
    flags: "IGNORECASE"
  - pattern: 'Cypress.io'
    replacement: "cypress"
    flags: "IGNORECASE"

validation:
  must_contain:
    - "/[Ff]ramework|[Cc]onfig/"
    - "/[Tt]est/"
  must_not_contain:
    - "{installed_path}"
