# testarch-trace.patch.yaml - Requirements traceability workflow patch
# Extends defaults-testarch.yaml (auto-merged by discovery)
#
# Features:
# - Requirements-to-tests traceability matrix
# - Coverage analysis
# - Quality gate decision (PASS/CONCERNS/FAIL/WAIVED)

patch:
  name: "testarch-trace-automation"
  version: "1.0.0"
  author: "BMad"
  description: "Requirements traceability workflow patch for bmad-assist automation"

compatibility:
  bmad_version: "6.0.0-alpha.22"
  workflow: "testarch-trace"

git_intelligence:
  enabled: true
  embed_marker: "git-intelligence"
  no_git_message: |
    This project is not under git version control.
    Focus on requirements and test analysis instead.
  commands:
    - name: "Requirements Docs"
      command: "git log --oneline -5 -- docs/prd.md docs/epics/ docs/requirements/ 2>/dev/null"
    - name: "Test Changes"
      command: "git log --oneline -10 -- tests/ test/ 2>/dev/null"
    - name: "Story Files"
      command: "git log --oneline -5 -- _bmad-output/implementation-artifacts/stories/ 2>/dev/null"

transforms:
  # === SCOPE INSTRUCTION ===
  - "Add ONE CRITICAL instruction at workflow start: 'SCOPE: You are the TEA (Test Engineer Architect) agent. Generate requirements-to-tests traceability matrix and make quality gate decision.'"

  # === REQUIREMENTS EXTRACTION ===
  - "Extract requirements from: PRD (docs/prd.md), epics (docs/epics/), story acceptance criteria."
  - "Identify functional requirements (FR) and non-functional requirements (NFR)."

  # === TEST MAPPING ===
  - "Map each requirement to covering tests. Identify: fully covered, partially covered, not covered."
  - "Use test naming conventions and docstrings to establish traceability."

  # === COVERAGE ANALYSIS ===
  - "Calculate coverage metrics: requirements coverage %, critical path coverage, risk-weighted coverage."
  - "Identify coverage gaps and prioritize by business impact."

  # === QUALITY GATE ===
  - "Make quality gate decision based on coverage thresholds and risk assessment."
  - "PASS: All critical requirements covered, >80% overall coverage."
  - "CONCERNS: Critical requirements covered, 60-80% overall coverage."
  - "FAIL: Missing critical requirement coverage or <60% overall."
  - "WAIVED: Documented exceptions with risk acceptance."

  # === OUTPUT FORMAT ===
  - "Generate traceability matrix in markdown table format."
  - "Include summary with quality gate decision and recommendations."

# Post-process rules extend defaults-testarch.yaml
post_process:
  # === TRACE-SPECIFIC CLEANUP ===
  # Normalize coverage markers
  - pattern: '\[COVERED\]'
    replacement: "[covered]"
    flags: "IGNORECASE"
  - pattern: '\[PARTIAL\]'
    replacement: "[partial]"
    flags: "IGNORECASE"
  - pattern: '\[MISSING\]'
    replacement: "[missing]"
    flags: "IGNORECASE"

  # Normalize quality gate verdicts
  - pattern: '\[PASS\]'
    replacement: "[pass]"
    flags: "IGNORECASE"
  - pattern: '\[CONCERNS\]'
    replacement: "[concerns]"
    flags: "IGNORECASE"
  - pattern: '\[FAIL\]'
    replacement: "[fail]"
    flags: "IGNORECASE"
  - pattern: '\[WAIVED\]'
    replacement: "[waived]"
    flags: "IGNORECASE"

validation:
  must_contain:
    - "/[Tt]race|[Mm]atrix|[Cc]overage/"
    - "/[Rr]equirement/"
  must_not_contain:
    - "{installed_path}"
