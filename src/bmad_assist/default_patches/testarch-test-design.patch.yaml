# testarch-test-design.patch.yaml - Test design workflow patch
# Extends defaults-testarch.yaml (auto-merged by discovery)
#
# Features:
# - Level detection (system/epic)
# - Design document validation
# - Risk-based test prioritization

patch:
  name: "testarch-test-design-automation"
  version: "1.0.0"
  author: "BMad"
  description: "Test design workflow patch for bmad-assist automation"

compatibility:
  bmad_version: "6.0.0-alpha.22"
  workflow: "testarch-test-design"

git_intelligence:
  enabled: true
  embed_marker: "git-intelligence"
  no_git_message: |
    This project is not under git version control.
    Focus on design requirements instead.
  commands:
    - name: "Test Design Document History"
      command: "git log --oneline -5 -- docs/*test*.md"
    - name: "Architecture Changes"
      command: "git log --oneline -3 -- docs/architecture.md"

transforms:
  # === SCOPE INSTRUCTION ===
  - "Add ONE CRITICAL instruction at workflow start: 'SCOPE: You are the TEA (Test Engineer Architect) agent. Create or review test design documentation. Detect level from context: system-level (architecture phase) or epic-level (implementation phase).'"

  # === LEVEL DETECTION ===
  - "Detect design level from context: if architecture.md is primary input → system-level testability review; if epic or story is input → epic-level test planning."

  # === DESIGN CRITERIA ===
  - "Apply test design knowledge from embedded fragments (risk-governance, test-priorities-matrix, test-levels-framework)."
  - "Consider: test levels (unit/integration/e2e), risk areas, coverage strategy, resource allocation."

  # === OUTPUT FORMAT ===
  - "Generate test-design-system.md or update existing test design document."
  - "Include: scope, test levels, risk-based priorities, tooling recommendations."

# Post-process rules extend defaults-testarch.yaml
post_process:
  # === DESIGN-SPECIFIC CLEANUP ===
  # Remove level detection markers after processing
  - pattern: '<!-- LEVEL:.*?-->'
    replacement: ""
    flags: "DOTALL"

  # Normalize section headers
  - pattern: '## Test Levels'
    replacement: "## Test Level Strategy"
    flags: "IGNORECASE"

validation:
  must_contain:
    - "/[Dd]esign/"
    - "/[Tt]est/"
  must_not_contain:
    - "{installed_path}"
