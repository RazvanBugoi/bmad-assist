# testarch-atdd.patch.yaml - ATDD workflow patch with tri-modal handling
# Extends defaults-testarch.yaml (auto-merged by discovery)
#
# Features:
# - Tri-modal execution detection (generate/validate/refine)
# - Mode-specific prompt templates
# - Git intelligence for test file changes

patch:
  name: "testarch-atdd-automation"
  version: "1.0.0"
  author: "BMad"
  description: "ATDD workflow patch with tri-modal handling for bmad-assist automation"

compatibility:
  bmad_version: "6.0.0-alpha.22"
  workflow: "testarch-atdd"

git_intelligence:
  enabled: true
  embed_marker: "git-intelligence"
  no_git_message: |
    This project is not under git version control.
    Focus on story context and test requirements instead.
  commands:
    - name: "Recent Test Changes"
      command: "git log --oneline -5 -- tests/"
    - name: "Test Directory Status"
      command: "git status --short -- tests/"
    - name: "Test File Diff"
      command: "git diff --stat -- tests/"

transforms:
  # === SCOPE INSTRUCTION ===
  - "Add ONE CRITICAL instruction at workflow start: 'SCOPE: You are the TEA (Test Engineer Architect) agent. Generate, validate, or refine acceptance tests following ATDD methodology. Check story frontmatter for atdd_mode (generate/validate/refine) to determine execution path.'"

  # === TRI-MODAL DETECTION ===
  - "Add check at start to detect ATDD mode from story_file frontmatter: if atdd_mode='generate' → create new acceptance tests; if atdd_mode='validate' → validate existing tests against ACs; if atdd_mode='refine' → improve existing tests based on feedback."

  # === MODE-SPECIFIC BEHAVIOR ===
  - "For GENERATE mode: Create failing acceptance tests for each AC in the story. Focus on red phase of TDD."
  - "For VALIDATE mode: Compare existing tests to story ACs. Report missing coverage and suggestions."
  - "For REFINE mode: Update tests based on code review or synthesis feedback. Focus on test quality improvements."

  # === KNOWLEDGE BASE INTEGRATION ===
  - "Reference the embedded knowledge fragments for fixture patterns and test architecture guidance."

  # === OUTPUT FORMAT ===
  - "Ensure test files follow project conventions from project_context.md."
  - "Output test code with appropriate fixtures and page objects if UI tests."

# Post-process rules extend defaults-testarch.yaml
post_process:
  # === ATDD-SPECIFIC CLEANUP ===
  # Remove mode detection prompts from output (already processed)
  - pattern: 'atdd_mode\s*=\s*[''"][^''"]+[''"]'
    replacement: ""
    flags: ""

  # Clean up any remaining step navigation markers
  - pattern: '<!-- STEP:.*?-->'
    replacement: ""
    flags: "DOTALL"

validation:
  must_contain:
    - "/[Aa]cceptance/"
    - "/[Tt]est/"
    - "<step"
  must_not_contain:
    - "{installed_path}"
