# testarch-ci.patch.yaml - CI workflow patch with platform auto-detection
# Extends defaults-testarch.yaml (auto-merged by discovery)
#
# Features:
# - CI platform auto-detection (GitHub, GitLab, CircleCI, Azure, Jenkins)
# - Platform-specific pipeline templates
# - Test execution configuration

patch:
  name: "testarch-ci-automation"
  version: "1.0.0"
  author: "BMad"
  description: "CI workflow patch for bmad-assist automation with platform detection"

compatibility:
  bmad_version: "6.0.0-alpha.22"
  workflow: "testarch-ci"

git_intelligence:
  enabled: true
  embed_marker: "git-intelligence"
  no_git_message: |
    This project is not under git version control.
    Cannot determine CI configuration without git.
  commands:
    - name: "CI Configuration History"
      command: "git log --oneline -5 -- .github/ .gitlab-ci.yml .circleci/"
    - name: "CI File Status"
      command: "git status --short -- .github/ .gitlab-ci.yml .circleci/ azure-pipelines.yml Jenkinsfile"
    - name: "Workflow File Changes"
      command: "git diff --stat -- .github/workflows/*.yml .github/workflows/*.yaml"

transforms:
  # === SCOPE INSTRUCTION ===
  - "Add ONE CRITICAL instruction at workflow start: 'SCOPE: You are the TEA (Test Engineer Architect) agent. Configure CI/CD pipeline for test execution. The {ci_platform} variable indicates detected platform: github, gitlab, circleci, azure, jenkins, or unknown.'"

  # === CI PLATFORM HANDLING ===
  - "Use {ci_platform} variable to determine pipeline configuration. Generate appropriate workflow/pipeline file for the detected platform."

  # === PLATFORM-SPECIFIC TEMPLATES ===
  - "For github: Generate .github/workflows/*.yml with proper job structure, matrix testing if needed."
  - "For gitlab: Generate .gitlab-ci.yml with appropriate stages."
  - "For circleci: Generate .circleci/config.yml with proper orbs."
  - "For azure: Generate azure-pipelines.yml with pool configuration."
  - "For jenkins: Generate Jenkinsfile with declarative pipeline."
  - "For unknown: Provide generic CI configuration guidance."

  # === QUALITY GATES ===
  - "Include test execution steps with coverage thresholds."
  - "Add burn-in testing for flaky test detection if applicable."

# Post-process rules extend defaults-testarch.yaml
post_process:
  # === CI-SPECIFIC CLEANUP ===
  # Replace ci_platform placeholder if unresolved
  - pattern: '\{ci_platform\}'
    replacement: "unknown"
    flags: ""

  # Normalize platform names
  - pattern: 'GitHub Actions'
    replacement: "github"
    flags: "IGNORECASE"
  - pattern: 'GitLab CI'
    replacement: "gitlab"
    flags: "IGNORECASE"

validation:
  must_contain:
    - "/[Cc][Ii]|[Pp]ipeline/"
    - "/[Tt]est/"
  must_not_contain:
    - "{installed_path}"
