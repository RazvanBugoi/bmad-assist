# testarch-automate.patch.yaml - Test automation expansion workflow patch
# Extends defaults-testarch.yaml (auto-merged by discovery)
#
# Features:
# - Source code discovery for test generation
# - Coverage gap analysis
# - Test generation with appropriate granularity

patch:
  name: "testarch-automate-automation"
  version: "1.0.0"
  author: "BMad"
  description: "Test automation workflow patch for bmad-assist automation with source discovery"

compatibility:
  bmad_version: "6.0.0-alpha.22"
  workflow: "testarch-automate"

git_intelligence:
  enabled: true
  embed_marker: "git-intelligence"
  no_git_message: |
    This project is not under git version control.
    Focus on source code analysis instead.
  commands:
    - name: "Recent Source Changes"
      command: "git log --oneline -10 --name-only -- src/ lib/ app/ 2>/dev/null | head -30"
    - name: "Uncovered Files"
      command: "git diff --stat HEAD~10 -- src/ lib/ app/ 2>/dev/null | head -20"
    - name: "Test Coverage Status"
      command: "git log --oneline -5 -- tests/ test/ coverage/ 2>/dev/null"

transforms:
  # === SCOPE INSTRUCTION ===
  - "Add ONE CRITICAL instruction at workflow start: 'SCOPE: You are the TEA (Test Engineer Architect) agent. Expand test automation coverage by analyzing source code and generating tests. The {component} variable indicates target scope if provided.'"

  # === SOURCE DISCOVERY ===
  - "Analyze source files to identify untested or undertested code paths."
  - "Use story file's ## File List section for targeted file discovery if available."
  - "Check existing test coverage reports in coverage/ directory."

  # === TEST GENERATION STRATEGY ===
  - "Generate tests at appropriate granularity: unit tests for pure functions, integration tests for service interactions, e2e for user flows."
  - "Follow existing test patterns from the codebase when present."

  # === COVERAGE GAPS ===
  - "Identify and prioritize coverage gaps based on: code complexity, change frequency, business criticality."
  - "Reference risk-governance knowledge fragment for prioritization."

  # === OUTPUT FORMAT ===
  - "Generate test files following project conventions from project_context.md."
  - "Include appropriate fixtures and mocks."

# Post-process rules extend defaults-testarch.yaml
post_process:
  # === AUTOMATE-SPECIFIC CLEANUP ===
  # Replace component placeholder if unresolved
  - pattern: '\{component\}'
    replacement: ""
    flags: ""

  # Remove empty component markers
  - pattern: '<!-- COMPONENT:.*?-->'
    replacement: ""
    flags: "DOTALL"

validation:
  must_contain:
    - "/[Aa]utomat|[Gg]enerat/"
    - "/[Tt]est/"
  must_not_contain:
    - "{installed_path}"
