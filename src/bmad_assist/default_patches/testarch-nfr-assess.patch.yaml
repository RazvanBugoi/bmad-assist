# testarch-nfr-assess.patch.yaml - NFR assessment workflow patch
# Extends defaults-testarch.yaml (auto-merged by discovery)
#
# Features:
# - NFR category detection (performance, security, reliability, maintainability)
# - Evidence-based validation
# - Quality gate recommendations

patch:
  name: "testarch-nfr-assess-automation"
  version: "1.0.0"
  author: "BMad"
  description: "NFR assessment workflow patch for bmad-assist automation with category detection"

compatibility:
  bmad_version: "6.0.0-alpha.22"
  workflow: "testarch-nfr-assess"

git_intelligence:
  enabled: true
  embed_marker: "git-intelligence"
  no_git_message: |
    This project is not under git version control.
    Focus on NFR analysis instead.
  commands:
    - name: "Performance Config"
      command: "git log --oneline -5 -- **/performance*.* **/benchmark*.* k6/ locust/ 2>/dev/null"
    - name: "Security Config"
      command: "git log --oneline -5 -- .snyk .trivyignore SECURITY.md dependabot.yml 2>/dev/null"
    - name: "CI Pipeline Config"
      command: "git log --oneline -5 -- .github/workflows/ .gitlab-ci.yml Jenkinsfile 2>/dev/null"

transforms:
  # === SCOPE INSTRUCTION ===
  - "Add ONE CRITICAL instruction at workflow start: 'SCOPE: You are the TEA (Test Engineer Architect) agent. Assess non-functional requirements with evidence-based validation. The {category} variable indicates focus area: performance, security, reliability, maintainability, or all.'"

  # === CATEGORY HANDLING ===
  - "If {category} is specified, focus assessment on that NFR area. Otherwise, perform comprehensive assessment across all categories."

  # === EVIDENCE COLLECTION ===
  - "Collect evidence from: test results, coverage reports, performance benchmarks, security scans, code quality metrics."
  - "Reference evidence sources in assessment findings."

  # === ASSESSMENT CRITERIA ===
  - "For performance: response times, throughput, resource utilization, scalability patterns."
  - "For security: dependency vulnerabilities, authentication patterns, data protection, OWASP compliance."
  - "For reliability: error handling, retry patterns, graceful degradation, monitoring coverage."
  - "For maintainability: code complexity, test coverage, documentation, technical debt."

  # === QUALITY GATE ===
  - "Provide quality gate recommendation: PASS (ready for release), CONCERNS (acceptable with caveats), FAIL (blocking issues), WAIVED (known risks accepted)."

# Post-process rules extend defaults-testarch.yaml
post_process:
  # === NFR-SPECIFIC CLEANUP ===
  # Replace category placeholder if unresolved
  - pattern: '\{category\}'
    replacement: "all"
    flags: ""

  # Normalize quality gate verdicts
  - pattern: '\[PASS\]'
    replacement: "[pass]"
    flags: "IGNORECASE"
  - pattern: '\[CONCERNS\]'
    replacement: "[concerns]"
    flags: "IGNORECASE"
  - pattern: '\[FAIL\]'
    replacement: "[fail]"
    flags: "IGNORECASE"
  - pattern: '\[WAIVED\]'
    replacement: "[waived]"
    flags: "IGNORECASE"

validation:
  must_contain:
    - "/[Nn]on-[Ff]unctional|NFR|[Aa]ssess/"
    - "/[Qq]uality/"
  must_not_contain:
    - "{installed_path}"
