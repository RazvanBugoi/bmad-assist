    </div>

    <!-- Context Menu - Basecoat dropdown-menu -->
    <div class="dropdown-menu" x-show="contextMenu.show">
        <div data-popover
             x-ref="contextMenuEl"
             data-testid="context-menu"
             role="menu"
             tabindex="-1"
             aria-hidden="false"
             @click.away="contextMenu.show = false"
             @keydown.escape.window="contextMenu.show = false"
             class="fixed min-w-48 z-50"
             :class="contextMenu.ready ? 'opacity-100' : 'opacity-0'"
             :style="`left: ${contextMenu.x}px; top: ${contextMenu.y}px`">
            <template x-for="(action, index) in contextMenu.actions" :key="action.label">
                <div>
                    <hr x-show="action.danger && index > 0 && !contextMenu.actions[index-1]?.danger"
                        role="separator"
                        data-testid="context-menu-separator">
                    <div role="menuitem"
                         :data-testid="action.testId"
                         :class="{
                             'bg-accent text-accent-foreground': action.primary,
                             'text-destructive': action.danger && !action.primary
                         }"
                         @click="executeAction(action)">
                        <i :data-lucide="getActionIcon(action.icon)" class="w-4 h-4"></i>
                        <span x-text="action.label"></span>
                    </div>
                </div>
            </template>
        </div>
    </div>

    <!-- Toast Notification - Sonner style, top center -->
    <div x-show="toast.visible"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0 -translate-y-4"
         x-transition:enter-end="opacity-100 translate-y-0"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100 translate-y-0"
         x-transition:leave-end="opacity-0 -translate-y-4"
         class="fixed top-4 left-1/2 -translate-x-1/2 z-50 bg-popover border border-border px-4 py-3 rounded-lg shadow-2xl flex items-center gap-3 min-w-72"
         style="background-color: hsl(222 47% 16%);">
        <i data-lucide="check-circle" class="w-5 h-5 text-accent flex-shrink-0"></i>
        <span x-text="toast.message" class="text-sm"></span>
    </div>

    <!-- Busy State Modal -->
    <div x-show="busyModal.show"
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-150"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         @keydown.escape.window="if (busyModal.show && !contextMenu.show) busyModal.show = false"
         @keydown.tab="if (busyModal.show) trapFocus($event)"
         data-testid="busy-modal"
         aria-modal="true"
         role="dialog"
         aria-labelledby="busy-modal-title"
         class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <div x-show="busyModal.show"
             x-transition:enter="transition ease-out duration-200"
             x-transition:enter-start="opacity-0 scale-95"
             x-transition:enter-end="opacity-100 scale-100"
             x-transition:leave="transition ease-in duration-150"
             x-transition:leave-start="opacity-100 scale-100"
             x-transition:leave-end="opacity-0 scale-95"
             x-ref="busyModalContent"
             class="card p-6 max-w-md w-full mx-4">
            <h3 id="busy-modal-title" class="text-lg font-semibold mb-4 flex items-center gap-2">
                <i data-lucide="alert-triangle" class="w-5 h-5 text-bp-warning"></i>
                bmad-assist is currently busy
            </h3>

            <p class="text-muted-foreground mb-4">
                Current: <span x-text="queue.current?.workflow" class="text-foreground"></span>
                <span x-text="`${queue.current?.epic_num}.${queue.current?.story_num}`" class="text-foreground tabular-nums"></span>
                (<span x-text="formatElapsedTime(queue.current?.phase_started_at)" class="tabular-nums"></span>)
            </p>

            <p class="mb-4">What should happen with your new task?</p>

            <div class="space-y-3 mb-6">
                <label class="flex items-start gap-3 p-3 rounded border border-border hover:border-primary cursor-pointer"
                       :class="busyModal.priority === 'interrupt' ? 'border-primary bg-primary/10' : ''">
                    <input type="radio" name="priority" value="interrupt" x-model="busyModal.priority"
                           x-ref="priorityInterrupt"
                           data-testid="priority-interrupt"
                           class="input mt-1">
                    <div>
                        <div class="font-medium">Interrupt current and run NOW</div>
                        <div class="text-sm text-destructive flex items-center gap-1">
                            <i data-lucide="alert-triangle" class="w-3 h-3"></i> Current task will be killed!
                        </div>
                    </div>
                </label>

                <label class="flex items-start gap-3 p-3 rounded border border-border hover:border-primary cursor-pointer"
                       :class="busyModal.priority === 'next' ? 'border-primary bg-primary/10' : ''">
                    <input type="radio" name="priority" value="next" x-model="busyModal.priority"
                           data-testid="priority-next"
                           class="input mt-1">
                    <div>
                        <div class="font-medium">Run AFTER current task completes</div>
                        <div class="text-sm text-muted-foreground flex items-center gap-1">
                            <i data-lucide="clock" class="w-3 h-3"></i> Will start when current finishes
                        </div>
                    </div>
                </label>

                <label class="flex items-start gap-3 p-3 rounded border border-border hover:border-primary cursor-pointer"
                       :class="busyModal.priority === 'last' ? 'border-primary bg-primary/10' : ''">
                    <input type="radio" name="priority" value="last" x-model="busyModal.priority"
                           data-testid="priority-last"
                           class="input mt-1">
                    <div>
                        <div class="font-medium">Add to END of queue (default)</div>
                        <div class="text-sm text-muted-foreground flex items-center gap-1">
                            <i data-lucide="clock" class="w-3 h-3"></i>
                            <span x-text="`${queue.queue?.length || 0} tasks ahead`"></span>
                        </div>
                    </div>
                </label>
            </div>

            <!-- Queue Preview (AC: 5) -->
            <div x-show="(queue.queue || []).length > 0"
                 data-testid="queue-preview"
                 class="mb-4 p-3 bg-background rounded border border-border">
                <div class="text-sm text-muted-foreground mb-2">Queue:</div>
                <div class="flex flex-wrap gap-2">
                    <template x-for="task in (queue.queue || []).slice(0, 3)" :key="task.id">
                        <span class="badge-secondary"
                              data-testid="queue-preview-item">
                            [<span x-text="task.workflow"></span>
                            <span x-text="`${task.epic_num}.${task.story_num}`" class="tabular-nums"></span>]
                        </span>
                    </template>
                    <span x-show="(queue.queue || []).length > 3"
                          class="px-2 py-1 text-muted-foreground text-xs"
                          data-testid="queue-preview-overflow">
                        +<span x-text="(queue.queue || []).length - 3"></span> more
                    </span>
                </div>
            </div>

            <div class="flex justify-end gap-3">
                <button class="btn-outline"
                        data-testid="modal-cancel"
                        @click="busyModal.show = false">
                    Cancel
                </button>
                <button class="btn"
                        data-testid="modal-confirm"
                        x-ref="modalConfirm"
                        @click="confirmBusyAction">
                    Confirm
                </button>
            </div>
        </div>
    </div>

    <!-- Content Modal (Story 16.9 - AC 3, 4) -->
    <div x-show="contentModal.show"
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-150"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         @keydown.escape.window="if (contentModal.show && !busyModal.show) { contentModal.show = false; contentModal.browser = null; _cancelPendingShikiHighlights(); }"
         @keydown.tab="if (contentModal.show && !busyModal.show) trapFocus($event, 'contentModalContent')"
         class="fixed inset-0 z-50 flex items-center justify-center bg-black/50"
         data-testid="content-modal">

        <!-- Modal Content -->
        <div class="card shadow-xl p-0 gap-0 overflow-hidden w-4/5 max-h-[80vh] flex flex-col"
             x-show="contentModal.show"
             x-transition:enter="transition ease-out duration-200"
             x-transition:enter-start="opacity-0 scale-95"
             x-transition:enter-end="opacity-100 scale-100"
             x-transition:leave="transition ease-in duration-150"
             x-transition:leave-start="opacity-100 scale-100"
             x-transition:leave-end="opacity-0 scale-95"
             x-ref="contentModalContent"
             role="dialog"
             aria-modal="true"
             aria-labelledby="content-modal-title"
             @click.outside="contentModal.show = false; contentModal.browser = null; _cancelPendingShikiHighlights();">

            <!-- Header -->
            <div class="flex items-center justify-between px-4 py-2 border-b border-border">
                <h2 id="content-modal-title" x-text="contentModal.title" class="text-lg font-semibold"></h2>
                <div class="flex items-center gap-2">
                    <!-- Story 24.5: Raw/Rendered toggle (only shown when browser state is set) -->
                    <template x-if="contentModal.browser">
                        <div class="flex items-center border border-border rounded overflow-hidden mr-2"
                             data-testid="view-toggle">
                            <button @click="contentModal.browser.view = 'rendered'"
                                    class="px-3 py-1 text-xs"
                                    :class="contentModal.browser.view === 'rendered' ? 'bg-accent text-accent-foreground' : 'hover:bg-muted'"
                                    data-testid="view-rendered-btn">
                                Rendered
                            </button>
                            <button @click="contentModal.browser.view = 'raw'"
                                    class="px-3 py-1 text-xs"
                                    :class="contentModal.browser.view === 'raw' ? 'bg-accent text-accent-foreground' : 'hover:bg-muted'"
                                    data-testid="view-raw-btn">
                                Raw
                            </button>
                        </div>
                    </template>
                    <!-- Story 24.5: Copy button uses copyRawContent when browser state exists -->
                    <button @click="contentModal.browser ? window.contentBrowserComponent().copyRawContent(contentModal.content, showToast) : copyToClipboard(contentModal.content)"
                            class="btn-sm-icon-ghost"
                            data-testid="copy-content-btn"
                            :title="contentModal.browser ? 'Copies raw content' : 'Copy to clipboard'"
                            aria-label="Copy content to clipboard">
                        <i data-lucide="clipboard" class="w-4 h-4"></i>
                    </button>
                    <button @click="contentModal.show = false; contentModal.browser = null; _cancelPendingShikiHighlights();"
                            class="btn-sm-icon-ghost"
                            data-testid="close-modal-btn">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>
