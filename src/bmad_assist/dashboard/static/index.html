<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>bmad-assist</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">

    <!-- Tailwind CSS v4 -->
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <style type="text/tailwindcss">
        /* Enable class-based dark mode for Tailwind v4 CDN */
        @variant dark (&:where(.dark, .dark *));
    </style>

    <!-- Basecoat UI - shadcn components without React -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/basecoat-css@0.3.10-beta.2/dist/basecoat.cdn.min.css">
    <script src="https://cdn.jsdelivr.net/npm/basecoat-css@0.3.10-beta.2/dist/js/all.min.js" defer></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@0.562.0/dist/umd/lucide.min.js"></script>

    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.9/dist/cdn.min.js"></script>

    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10/dist/ext/sse.js"></script>

    <!-- Marked.js - Markdown parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked@15.0.6/marked.min.js" integrity="sha384-b5hg04N6F0rvyz1a/GVoPPY0JcqGTARCmEuFCqwQKX3zq7LsxhV+n+6Ykh2pQOCH" crossorigin="anonymous"></script>

    <!-- xterm.js - Terminal emulator -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css" />
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-web-links@0.9.0/lib/xterm-addon-web-links.min.js"></script>

    <link rel="stylesheet" href="/css/index.css">
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body class="bg-background text-foreground min-h-screen" x-data="dashboard()">
    <div class="flex h-screen">
        <!-- Sidebar with resize -->
        <aside class="bg-sidebar border-r border-sidebar-border flex flex-col relative flex-shrink-0"
               x-data="{ sidebarWidth: 256 }"
               :style="`width: ${sidebarWidth}px`">
            <!-- Header -->
            <header class="p-4 border-b border-sidebar-border">
                <h1 class="text-lg font-bold text-sidebar-primary flex items-center gap-2">
                    <a href="#" @click.prevent="resetDashboard()" class="flex items-center gap-2 group cursor-pointer">
                        <!-- Logo: outline by default, filled + outline on hover -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                             class="transition-all duration-200">
                            <!-- Blue - Plan -->
                            <rect width="7" height="9" x="3" y="3" rx="1.5" stroke="currentColor" stroke-width="1.5"
                                  class="fill-transparent stroke-sidebar-primary transition-all group-hover:fill-[#58a6ff] group-hover:stroke-[#58a6ff]"/>
                            <!-- Orange - Validate -->
                            <rect width="7" height="5" x="14" y="3" rx="1.5" stroke="currentColor" stroke-width="1.5"
                                  class="fill-transparent stroke-sidebar-primary transition-all group-hover:fill-[#d29922] group-hover:stroke-[#d29922]"/>
                            <!-- Green - Develop -->
                            <rect width="7" height="9" x="14" y="12" rx="1.5" stroke="currentColor" stroke-width="1.5"
                                  class="fill-transparent stroke-sidebar-primary transition-all group-hover:fill-[#3fb950] group-hover:stroke-[#3fb950]"/>
                            <!-- Red - Review -->
                            <rect width="7" height="5" x="3" y="16" rx="1.5" stroke="currentColor" stroke-width="1.5"
                                  class="fill-transparent stroke-sidebar-primary transition-all group-hover:fill-[#f85149] group-hover:stroke-[#f85149]"/>
                        </svg>
                        <span class="group-hover:text-accent transition-colors">bmad-assist</span>
                    </a>
                    <span class="text-xs font-normal text-muted-foreground/50 ml-auto" x-text="version ? 'v' + version : ''"></span>
                </h1>
                <div class="flex items-center gap-2 mt-2 text-sm">
                    <i :data-lucide="connected ? 'wifi' : 'wifi-off'"
                       :class="connected ? 'text-accent' : 'text-destructive'"
                       class="w-4 h-4"></i>
                    <span x-text="connected ? 'Connected' : 'Disconnected'" class="text-sidebar-foreground"></span>
                </div>
            </header>

            <!-- Tree View - Compact -->
            <nav class="flex-1 overflow-y-auto p-1 pb-4 text-sm" id="tree-view" data-testid="tree-view"
                 @click.self="selectedItem = { type: null, epic: null, story: null, phase: null }">
                <div id="tree-content">
                    <template x-if="stories.epics">
                        <div>
                            <template x-for="epic in stories.epics" :key="`${epic.id}-${epic.status}`">
                                <div class="group/epic">
                                    <!-- Epic -->
                                    <div class="flex items-center gap-1.5 py-0.5 cursor-pointer hover:bg-white/10 rounded-sm transition-colors"
                                         data-testid="epic-node"
                                         :data-status="epic.status"
                                         :class="{'bg-primary/10 ring-1 ring-primary/50': selectedItem.type === 'epic' && selectedItem.epic?.id === epic.id}"
                                         @click="selectItem('epic', epic); toggleEpic(epic.id)"
                                         @contextmenu.prevent="showContextMenu($event, 'epic', epic)">
                                        <i :data-lucide="expandedEpics.includes(epic.id) ? 'chevron-down' : 'chevron-right'"
                                           class="w-3 h-3 text-muted-foreground flex-shrink-0 opacity-60 group-hover/epic:opacity-100 transition-opacity"></i>
                                        <span :class="getEpicStatusColor(epic)" class="flex-shrink-0 opacity-60 group-hover/epic:opacity-100 transition-opacity">
                                            <i :data-lucide="getEpicStatusIcon(epic.status)" class="w-3 h-3"></i>
                                        </span>
                                        <span class="font-medium tabular-nums" x-text="'Epic ' + epic.id"></span>
                                        <span x-text="epic.title" class="truncate flex-1 text-muted-foreground"></span>
                                        <span class="badge-secondary text-xs" x-text="getEpicProgress(epic).split(' ')[0]"></span>
                                        <button class="opacity-0 group-hover/epic:opacity-100 p-0.5 hover:bg-muted rounded"
                                                data-testid="kebab-button"
                                                @click.stop="showContextMenu($event, 'epic', epic, null, null, 'kebab')">
                                            <i data-lucide="more-vertical" class="w-3 h-3"></i>
                                        </button>
                                    </div>

                                    <!-- Stories -->
                                    <div x-show="expandedEpics.includes(epic.id)" x-transition class="ml-4">
                                        <template x-for="story in epic.stories" :key="`${story.id}-${story.status}`">
                                            <div class="group/story">
                                                <div class="flex items-center gap-1.5 px-2 py-0.5 cursor-pointer hover:bg-white/10 rounded-sm transition-colors"
                                                     data-testid="story-node"
                                                     :data-status="story.status"
                                                     :class="{'bg-primary/10 ring-1 ring-primary/50': selectedItem.type === 'story' && selectedItem.story?.id === story.id && selectedItem.epic?.id === epic.id}"
                                                     @click="selectItem('story', epic, story); toggleStory(`${epic.id}-${story.id}`)"
                                                     @contextmenu.prevent="showContextMenu($event, 'story', story, epic)">
                                                    <i :data-lucide="expandedStories.includes(`${epic.id}-${story.id}`) ? 'chevron-down' : 'chevron-right'"
                                                       class="w-3 h-3 text-muted-foreground flex-shrink-0 opacity-60 group-hover/story:opacity-100 transition-opacity"></i>
                                                    <span :class="getStoryStatusColor(story.status)" class="flex-shrink-0 opacity-60 group-hover/story:opacity-100 transition-opacity">
                                                        <i :data-lucide="getStatusIcon(story.status)" class="w-3 h-3"></i>
                                                    </span>
                                                    <span x-text="`${epic.id}.${story.id}`" class="tabular-nums text-muted-foreground w-6"></span>
                                                    <span x-text="story.title" class="truncate flex-1"></span>
                                                    <button class="opacity-0 group-hover/story:opacity-100 p-0.5 hover:bg-muted rounded"
                                                            data-testid="kebab-button"
                                                            @click.stop="showContextMenu($event, 'story', story, epic, null, 'kebab')">
                                                        <i data-lucide="more-vertical" class="w-3 h-3"></i>
                                                    </button>
                                                </div>

                                                <!-- Phases -->
                                                <div x-show="expandedStories.includes(`${epic.id}-${story.id}`)" x-transition class="ml-7 text-xs">
                                                    <template x-for="phase in story.phases" :key="`${phase.id}-${phase.status}`">
                                                        <div class="group/phase flex items-center gap-1.5 px-2 py-0.5 cursor-pointer hover:bg-white/10 rounded-sm transition-colors"
                                                             data-testid="phase-node"
                                                             :data-phase="phase.id"
                                                             :class="{'bg-primary/10 ring-1 ring-primary/50': selectedItem.type === 'phase' && selectedItem.phase?.id === phase.id && selectedItem.story?.id === story.id && selectedItem.epic?.id === epic.id}"
                                                             @click="selectItem('phase', epic, story, phase)"
                                                             @contextmenu.prevent="showContextMenu($event, 'phase', phase, epic, story)">
                                                            <span :class="getPhaseTextColor(phase.status)" class="opacity-60 group-hover/phase:opacity-100 transition-opacity">
                                                                <i :data-lucide="getPhaseIcon(phase.status)" class="w-3 h-3"></i>
                                                            </span>
                                                            <span x-text="phase.name" class="text-muted-foreground"></span>
                                                            <button class="opacity-0 group-hover/phase:opacity-100 p-0.5 hover:bg-muted rounded ml-auto"
                                                                    data-testid="kebab-button"
                                                                    @click.stop="showContextMenu($event, 'phase', phase, epic, story, 'kebab')">
                                                                <i data-lucide="more-vertical" class="w-3 h-3"></i>
                                                            </button>
                                                        </div>
                                                    </template>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </template>
                        <!-- Loading Skeleton (Story 16.5) -->
                        <div x-show="loading" class="p-4 space-y-3">
                            <div class="animate-pulse flex items-center gap-2">
                                <div class="w-3 h-3 bg-border rounded"></div>
                                <div class="h-4 bg-border rounded w-3/4"></div>
                            </div>
                            <div class="animate-pulse flex items-center gap-2">
                                <div class="w-3 h-3 bg-border rounded"></div>
                                <div class="h-4 bg-border rounded w-2/3"></div>
                            </div>
                            <div class="animate-pulse flex items-center gap-2">
                                <div class="w-3 h-3 bg-border rounded"></div>
                                <div class="h-4 bg-border rounded w-1/2"></div>
                            </div>
                        </div>
                        <!-- Error State (Story 16.5) -->
                        <div x-show="loadError && !loading" class="text-destructive text-sm p-4 flex items-center gap-2">
                            <i data-lucide="alert-circle" class="w-4 h-4"></i>
                            <span x-text="loadError"></span>
                        </div>
                        <!-- Empty State -->
                        <div x-show="!loading && !loadError && !stories.epics" class="text-muted-foreground text-sm p-4">
                            No stories found
                        </div>
                    </div>
            </nav>

            <!-- Detail Panel (Story 16.5) -->
            <div x-show="selectedItem.type" x-transition class="p-4 border-t border-border bg-card/50">
                <!-- Epic Details -->
                <template x-if="selectedItem.type === 'epic'">
                    <div>
                        <h3 class="font-semibold text-foreground">Epic <span x-text="selectedItem.epic?.id" class="tabular-nums"></span></h3>
                        <p x-text="selectedItem.epic?.title" class="text-sm text-muted-foreground truncate"></p>
                        <div class="mt-2 flex items-center gap-2">
                            <span :class="getEpicStatusColor(selectedItem.epic)">
                                <i :data-lucide="getEpicStatusIcon(selectedItem.epic?.status)" class="w-4 h-4"></i>
                            </span>
                            <span x-text="selectedItem.epic?.status" class="text-xs text-muted-foreground"></span>
                        </div>
                        <div class="mt-1 text-xs text-muted-foreground">
                            Progress: <span x-text="getEpicProgress(selectedItem.epic)"></span>
                        </div>
                    </div>
                </template>
                <!-- Story Details -->
                <template x-if="selectedItem.type === 'story'">
                    <div>
                        <h3 class="font-semibold text-foreground tabular-nums">
                            <span x-text="`${selectedItem.epic?.id}.${selectedItem.story?.id}`"></span>
                        </h3>
                        <p x-text="selectedItem.story?.title" class="text-sm text-muted-foreground truncate"></p>
                        <div class="mt-2 flex items-center gap-2">
                            <span :class="getStoryStatusColor(selectedItem.story?.status)">
                                <i :data-lucide="getStatusIcon(selectedItem.story?.status)" class="w-4 h-4"></i>
                            </span>
                            <span x-text="selectedItem.story?.status" class="text-xs text-muted-foreground"></span>
                        </div>
                        <div class="mt-1 text-xs text-muted-foreground">
                            Phases: <span x-text="selectedItem.story?.phases?.length || 0"></span>
                        </div>
                    </div>
                </template>
                <!-- Phase Details -->
                <template x-if="selectedItem.type === 'phase'">
                    <div>
                        <h3 class="font-semibold text-foreground" x-text="selectedItem.phase?.name"></h3>
                        <div class="mt-2 flex items-center gap-2">
                            <span :class="getPhaseTextColor(selectedItem.phase?.status)">
                                <i :data-lucide="getPhaseIcon(selectedItem.phase?.status)" class="w-4 h-4"></i>
                            </span>
                            <span x-text="selectedItem.phase?.status" class="text-xs text-muted-foreground"></span>
                        </div>
                        <div class="mt-1 text-xs text-muted-foreground">
                            Story: <span x-text="`${selectedItem.epic?.id}.${selectedItem.story?.id}`" class="tabular-nums"></span>
                        </div>
                    </div>
                </template>
            </div>

            <!-- Status Bar -->
            <footer class="p-4 border-t border-border text-xs text-muted-foreground">
                <div x-show="queue.current">
                    Current: <span x-text="queue.current?.workflow" class="text-primary"></span>
                    <span x-text="`${queue.current?.epic_num}.${queue.current?.story_num}`" class="tabular-nums"></span>
                </div>
                <div x-show="queue.queue?.length">
                    Queue: <span x-text="queue.queue?.length"></span> pending
                </div>
            </footer>

            <!-- Resize Handle -->
            <div class="absolute top-0 right-0 w-1 h-full cursor-col-resize bg-transparent hover:bg-primary/50 transition-colors"
                 @mousedown.prevent="
                     const startX = $event.clientX;
                     const startWidth = sidebarWidth;
                     const onMove = (e) => {
                         const newWidth = startWidth + (e.clientX - startX);
                         sidebarWidth = Math.min(400, Math.max(200, newWidth));
                     };
                     const onUp = () => {
                         document.removeEventListener('mousemove', onMove);
                         document.removeEventListener('mouseup', onUp);
                     };
                     document.addEventListener('mousemove', onMove);
                     document.addEventListener('mouseup', onUp);
                 "></div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col"
              @click="if (!$event.target.closest('[data-testid]')) selectedItem = { type: null, epic: null, story: null, phase: null }">
            <!-- Current Task Header -->
            <header class="bg-card border-b border-border p-4">
                <div x-show="queue.current" class="flex items-center justify-between">
                    <div>
                        <h2 class="text-lg font-semibold tabular-nums">
                            Epic <span x-text="queue.current?.epic_num"></span> / Story <span x-text="queue.current?.story_num"></span>
                        </h2>
                        <div class="flex items-center gap-2 text-sm text-muted-foreground">
                            <span>Phase:</span>
                            <span x-text="queue.current?.workflow" class="text-primary"></span>
                            <!-- Running badge: show when running and no pause requested -->
                            <span x-show="loopRunning && !pauseRequested"
                                  x-transition
                                  class="badge bg-accent/20 text-accent flex items-center gap-1">
                                <i data-lucide="play" class="w-3 h-3"></i> RUNNING
                            </span>
                            <!-- Pausing badge: show when running with pause requested -->
                            <span x-show="loopRunning && pauseRequested"
                                  x-transition
                                  class="badge bg-yellow-100/20 text-yellow-700 dark:text-yellow-400 flex items-center gap-1">
                                <i data-lucide="loader" class="w-3 h-3 animate-spin"></i> PAUSING
                            </span>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <span x-text="formatElapsedTime(queue.current?.phase_started_at)" class="text-sm text-muted-foreground tabular-nums"></span>
                    </div>
                </div>
                <div x-show="!queue.current" class="text-muted-foreground">
                    No task running
                </div>
            </header>

            <!-- Terminal Output (hidden when settings or experiments panel is open) -->
            <div x-show="!settingsView.open && !experimentsView.open"
                 class="flex-1 flex flex-col bg-background overflow-hidden relative">
                <!-- Terminal Header - Controls + Log level filter -->
                <div class="w-full px-4 py-2 border-b border-border">
                    <div class="flex items-center justify-between w-full">
                        <!-- Left: Loop controls -->
                        <div class="flex items-center gap-2">
                            <button class="btn btn-sm"
                                    @click="startLoop"
                                    :disabled="loopRunning || isPaused">
                                <i data-lucide="play" class="w-3.5 h-3.5"></i> Start
                            </button>
                            <!-- Pause button (hidden when paused) -->
                            <button class="btn btn-sm bg-bp-warning text-background hover:bg-bp-warning/80"
                                    @click="pauseLoop"
                                    x-show="!isPaused"
                                    :disabled="!loopRunning"
                                    :class="{ 'opacity-50 cursor-not-allowed': !loopRunning }">
                                <i data-lucide="pause" class="w-3.5 h-3.5"></i> Pause
                            </button>
                            <!-- Resume button (shown when paused) -->
                            <button class="btn btn-sm bg-green-600 text-white hover:bg-green-700"
                                    @click="resumeLoop"
                                    x-show="isPaused"
                                    x-transition
                                    :disabled="!isPaused">
                                <i data-lucide="play" class="w-3.5 h-3.5"></i> Resume
                            </button>
                            <button class="btn btn-sm bg-destructive text-destructive-foreground hover:bg-destructive/80"
                                    @click="stopLoop"
                                    :disabled="!loopRunning">
                                <i data-lucide="square" class="w-3.5 h-3.5"></i> Stop
                            </button>

                            <div class="w-px h-6 bg-border mx-1"></div>

                            <button class="btn-outline btn-sm"
                                    @click="openExperiments()"
                                    :class="{'ring-2 ring-primary': experimentsView.open}"
                                    data-testid="experiments-button">
                                <i data-lucide="flask-conical" class="w-3.5 h-3.5"></i> Experiments
                            </button>
                            <button class="btn-outline btn-sm"
                                    x-ref="settingsBtn"
                                    @click="openSettings()"
                                    :class="{'ring-2 ring-primary': settingsView.open}"
                                    data-testid="settings-button">
                                <i data-lucide="settings" class="w-3.5 h-3.5"></i> Settings
                            </button>
                        </div>

                        <!-- Right: Log level dropdown + Validator progress + Output count -->
                        <div class="flex items-center gap-3">
                            <!-- Output line count -->
                            <span class="text-xs text-muted-foreground tabular-nums"
                                  x-text="`${output.length} lines`"></span>

                            <!-- Log Level Dropdown (state in parent scope to fix reactivity) -->
                            <div class="relative">
                                <button class="flex items-center gap-1 px-2 py-1 text-xs rounded border border-border hover:bg-muted"
                                        @click="logLevelDropdownOpen = !logLevelDropdownOpen"
                                        @click.outside="logLevelDropdownOpen = false"
                                        data-testid="log-level-btn">
                                    <i data-lucide="filter" class="w-3 h-3"></i>
                                    <span x-text="logLevel.toUpperCase()" class="font-mono"></span>
                                    <i data-lucide="chevron-down" class="w-3 h-3"></i>
                                </button>
                                <div x-show="logLevelDropdownOpen"
                                     x-transition:enter="transition ease-out duration-100"
                                     x-transition:enter-start="opacity-0 scale-95"
                                     x-transition:enter-end="opacity-100 scale-100"
                                     x-transition:leave="transition ease-in duration-75"
                                     x-transition:leave-start="opacity-100 scale-100"
                                     x-transition:leave-end="opacity-0 scale-95"
                                     class="absolute top-full right-0 mt-1 w-28 bg-card border border-border rounded-md shadow-lg py-1 z-50"
                                     data-testid="log-level-dropdown">
                                    <button @click="setLogLevel('debug'); logLevelDropdownOpen = false"
                                            class="w-full text-left px-3 py-1 text-xs hover:bg-muted flex items-center justify-between"
                                            :class="{ 'text-primary font-medium': logLevel === 'debug' }">
                                        DEBUG
                                        <i x-show="logLevel === 'debug'" data-lucide="check" class="w-3 h-3"></i>
                                    </button>
                                    <button @click="setLogLevel('info'); logLevelDropdownOpen = false"
                                            class="w-full text-left px-3 py-1 text-xs hover:bg-muted flex items-center justify-between"
                                            :class="{ 'text-primary font-medium': logLevel === 'info' }">
                                        INFO
                                        <i x-show="logLevel === 'info'" data-lucide="check" class="w-3 h-3"></i>
                                    </button>
                                    <button @click="setLogLevel('warning'); logLevelDropdownOpen = false"
                                            class="w-full text-left px-3 py-1 text-xs hover:bg-muted flex items-center justify-between"
                                            :class="{ 'text-primary font-medium': logLevel === 'warning' }">
                                        WARNING
                                        <i x-show="logLevel === 'warning'" data-lucide="check" class="w-3 h-3"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Validator progress indicator -->
                            <div x-show="validatorProgress.total > 0"
                                 x-transition
                                 class="flex items-center gap-2 text-sm text-muted-foreground">
                                <span class="text-xs">Validators:</span>
                                <div class="flex items-center gap-1">
                                    <span x-text="`${validatorProgress.completed + validatorProgress.failed}/${validatorProgress.total}`"
                                          class="tabular-nums"></span>
                                    <span x-show="validatorProgress.failed > 0"
                                          class="text-destructive"
                                          x-text="`(${validatorProgress.failed} failed)`"></span>
                                </div>
                                <div class="w-16 h-1.5 bg-border rounded-full overflow-hidden">
                                    <div class="h-full bg-primary transition-all duration-300"
                                         :style="`width: ${validatorProgressPercent}%`"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- xterm.js Terminal Container -->
                <div class="flex-1 overflow-hidden relative"
                     id="xterm-container"
                     x-ref="xtermContainer"
                     tabindex="0"
                     @wheel="handleTerminalWheel($event)"
                     @keydown="handleTerminalKeydown($event)">
                </div>

                <!-- Auto-scroll indicator -->
                <div x-show="!autoScroll"
                     x-transition:enter="transition ease-out duration-200"
                     x-transition:leave="transition ease-in duration-150"
                     class="absolute bottom-4 right-4 bg-primary text-primary-foreground px-3 py-1 rounded-full text-sm cursor-pointer shadow-lg flex items-center gap-1"
                     title="Click or press End to scroll"
                     @click="autoScroll = true; scrollToBottom()">
                    <i data-lucide="arrow-down" class="w-4 h-4"></i> New output
                </div>
            </div>


            <!-- Settings Panel (Story 17.4) -->
            <div x-show="settingsView.open"
                 x-transition:enter="transition ease-out duration-200"
                 x-transition:enter-start="opacity-0"
                 x-transition:enter-end="opacity-100"
                 x-transition:leave="transition ease-in duration-150"
                 x-transition:leave-start="opacity-100"
                 x-transition:leave-end="opacity-0"
                 @keydown.escape.window="handleSettingsEscape($event)"
                 class="flex-1 flex flex-col bg-background overflow-hidden"
                 data-testid="settings-panel">

                <!-- Settings Header -->
                <div class="flex items-center justify-between px-4 py-3 border-b border-border bg-card">
                    <div class="flex items-center gap-4">
                        <h2 class="text-lg font-semibold flex items-center gap-2">
                            <i data-lucide="settings" class="w-5 h-5"></i>
                            Settings
                        </h2>

                        <!-- Scope Toggle (AC2) -->
                        <div class="flex items-center gap-1 bg-muted rounded-lg p-1" data-testid="scope-toggle">
                            <button @click="toggleScope('project')"
                                    :class="settingsView.scope === 'project' ? 'bg-background shadow-sm' : 'hover:bg-background/50'"
                                    class="px-3 py-1 rounded text-sm font-medium transition-colors"
                                    data-testid="scope-project">
                                Project
                            </button>
                            <button @click="toggleScope('global')"
                                    :class="settingsView.scope === 'global' ? 'bg-background shadow-sm' : 'hover:bg-background/50'"
                                    class="px-3 py-1 rounded text-sm font-medium transition-colors"
                                    data-testid="scope-global">
                                Global
                            </button>
                        </div>
                    </div>

                    <div class="flex items-center gap-2">
                        <!-- Export Button with Dropdown (Story 17.12 AC2) -->
                        <div class="relative" @click.away="exportView.dropdownOpen = false">
                            <button @click="exportView.dropdownOpen = !exportView.dropdownOpen"
                                    :disabled="exportView.loading"
                                    class="btn-outline flex items-center gap-1"
                                    data-testid="export-button">
                                <template x-if="exportView.loading">
                                    <i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i>
                                </template>
                                <template x-if="!exportView.loading">
                                    <i data-lucide="download" class="w-4 h-4"></i>
                                </template>
                                Export
                                <i data-lucide="chevron-down" class="w-3 h-3"></i>
                            </button>
                            <!-- Export Dropdown Menu -->
                            <div x-show="exportView.dropdownOpen"
                                 x-transition:enter="transition ease-out duration-100"
                                 x-transition:enter-start="opacity-0 scale-95"
                                 x-transition:enter-end="opacity-100 scale-100"
                                 class="absolute right-0 mt-1 w-48 bg-card border border-border rounded shadow-lg z-50"
                                 data-testid="export-dropdown">
                                <button @click="exportConfig('merged')"
                                        class="w-full px-4 py-2 text-left text-sm hover:bg-muted/50 flex items-center gap-2"
                                        data-testid="export-merged">
                                    <i data-lucide="layers" class="w-4 h-4"></i>
                                    Merged (All Settings)
                                </button>
                                <button @click="exportConfig('global')"
                                        class="w-full px-4 py-2 text-left text-sm hover:bg-muted/50 flex items-center gap-2"
                                        data-testid="export-global">
                                    <i data-lucide="globe" class="w-4 h-4"></i>
                                    Global Only
                                </button>
                                <button @click="exportConfig('project')"
                                        class="w-full px-4 py-2 text-left text-sm hover:bg-muted/50 flex items-center gap-2"
                                        data-testid="export-project">
                                    <i data-lucide="folder" class="w-4 h-4"></i>
                                    Project Only
                                </button>
                            </div>
                        </div>

                        <!-- Import Button (Story 17.12 AC5) -->
                        <button @click="openImportFilePicker()"
                                :disabled="importView.loading"
                                class="btn-outline flex items-center gap-1"
                                data-testid="import-button">
                            <template x-if="importView.loading">
                                <i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i>
                            </template>
                            <template x-if="!importView.loading">
                                <i data-lucide="upload" class="w-4 h-4"></i>
                            </template>
                            Import
                        </button>

                        <!-- Apply Button (AC4) - Story 17.5: also check validation errors -->
                        <button @click="applyConfig()"
                                :disabled="!settingsView.hasChanges || settingsView.applying || hasValidationErrors()"
                                :class="(settingsView.hasChanges && !hasValidationErrors()) ? 'btn' : 'btn-outline opacity-50 cursor-not-allowed'"
                                class="flex items-center gap-2"
                                data-testid="apply-button">
                            <template x-if="settingsView.applying">
                                <i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i>
                            </template>
                            <template x-if="!settingsView.applying">
                                <i data-lucide="check" class="w-4 h-4"></i>
                            </template>
                            Apply
                        </button>

                        <!-- Close Button -->
                        <button @click="closeSettings()"
                                x-ref="settingsCloseBtn"
                                class="btn-outline p-2"
                                title="Close settings (Esc)"
                                data-testid="settings-close-button">
                            <i data-lucide="x" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>

                <!-- Stale Data Warning (AC8) -->
                <div x-show="settingsView.staleData"
                     class="px-4 py-2 bg-bp-warning/20 border-b border-bp-warning/50 flex items-center justify-between"
                     data-testid="stale-data-warning">
                    <div class="flex items-center gap-2 text-sm">
                        <i data-lucide="alert-triangle" class="w-4 h-4 text-bp-warning"></i>
                        <span>Configuration was reloaded elsewhere. Your view may be stale.</span>
                    </div>
                    <button @click="reloadConfigData()"
                            class="btn-sm text-xs"
                            data-testid="reload-config-button">
                        <i data-lucide="refresh-cw" class="w-3 h-3"></i> Reload
                    </button>
                </div>

                <!-- Settings Tabs (AC3, AC7 responsive) -->
                <div class="tabs w-full px-4 py-2 border-b border-border">
                    <nav role="tablist" aria-orientation="horizontal" class="flex flex-col sm:flex-row gap-1" data-testid="settings-tabs">
                        <template x-for="tab in ['testing', 'benchmarking', 'providers']" :key="tab">
                            <button type="button"
                                    role="tab"
                                    :aria-selected="settingsView.activeTab === tab"
                                    :tabindex="settingsView.activeTab === tab ? 0 : -1"
                                    @click="setSettingsTab(tab)"
                                    @keydown.arrow-left="setSettingsTab(tab === 'testing' ? 'providers' : tab === 'benchmarking' ? 'testing' : 'benchmarking')"
                                    @keydown.arrow-right="setSettingsTab(tab === 'testing' ? 'benchmarking' : tab === 'benchmarking' ? 'providers' : 'testing')"
                                    :data-testid="'tab-' + tab">
                                <span x-text="tab.charAt(0).toUpperCase() + tab.slice(1)"></span>
                            </button>
                        </template>
                    </nav>
                </div>

                <!-- Settings Content -->
                <div class="flex-1 overflow-y-auto p-4">
                    <!-- Loading State (AC5) -->
                    <div x-show="settingsView.loading" class="flex items-center justify-center h-full" data-testid="settings-loading">
                        <div class="flex flex-col items-center gap-3">
                            <i data-lucide="loader-2" class="w-8 h-8 animate-spin text-primary"></i>
                            <span class="text-muted-foreground">Loading configuration...</span>
                        </div>
                    </div>

                    <!-- Error State (AC5) -->
                    <div x-show="settingsView.error && !settingsView.loading"
                         class="flex items-center justify-center h-full"
                         data-testid="settings-error">
                        <div class="flex flex-col items-center gap-3 text-center">
                            <i data-lucide="alert-circle" class="w-8 h-8 text-destructive"></i>
                            <span class="text-destructive" x-text="settingsView.error"></span>
                            <button @click="retryFetchConfig()" class="btn-outline" data-testid="retry-button">
                                <i data-lucide="refresh-cw" class="w-4 h-4"></i> Retry
                            </button>
                        </div>
                    </div>

                    <!-- Tab Content (AC3) -->
                    <div x-show="!settingsView.loading && !settingsView.error">
                        <!-- Testing Tab Content (Story 17.5) -->
                        <div x-show="settingsView.activeTab === 'testing'"
                             data-testid="tab-content-testing">

                            <!-- Playwright Section Card (AC1) (Story 17.11: Status integration) -->
                            <div class="card p-6">
                                <!-- Story 17.11 AC2: Playwright header with status badge and refresh button -->
                                <h3 class="text-lg font-medium mb-4 flex items-center gap-2 flex-wrap">
                                    <i data-lucide="flask-conical" class="w-5 h-5"></i>
                                    Playwright

                                    <!-- Story 17.11 AC2: Status Badge -->
                                    <span :class="getPlaywrightStatusBadge().class"
                                          class="inline-flex items-center gap-1 px-2 py-0.5 rounded text-xs font-medium ml-auto"
                                          data-testid="playwright-status-badge">
                                        <i :data-lucide="getPlaywrightStatusBadge().icon"
                                           :class="getPlaywrightStatusBadge().icon === 'loader-2' ? 'w-3 h-3 animate-spin' : 'w-3 h-3'"></i>
                                        <span x-text="getPlaywrightStatusBadge().text"></span>
                                    </span>

                                    <!-- Story 17.11 AC5: Refresh Button -->
                                    <button @click="refreshPlaywrightStatus()"
                                            :disabled="playwrightStatus.loading"
                                            class="p-1 rounded hover:bg-muted text-muted-foreground hover:text-foreground transition-colors"
                                            title="Refresh Playwright status"
                                            data-testid="playwright-refresh-btn">
                                        <i :data-lucide="playwrightStatus.loading ? 'loader-2' : 'refresh-cw'"
                                           :class="playwrightStatus.loading ? 'w-4 h-4 animate-spin' : 'w-4 h-4'"></i>
                                    </button>
                                </h3>

                                <!-- Story 17.11 AC3: Playwright Info (version and browsers) -->
                                <template x-if="playwrightStatus.data && !playwrightStatus.error">
                                    <div class="text-sm text-muted-foreground mb-4 space-y-1">
                                        <div x-show="playwrightStatus.data.version">
                                            Playwright v<span x-text="playwrightStatus.data.version"></span>
                                        </div>
                                        <div>
                                            Browsers: <span x-text="getInstalledBrowsersList()" data-testid="playwright-browsers-list"></span>
                                        </div>
                                    </div>
                                </template>

                                <!-- Story 17.11 AC7: Error State -->
                                <template x-if="playwrightStatus.error">
                                    <div class="bg-destructive/10 border border-destructive/30 rounded p-3 mb-4 flex items-center justify-between"
                                         data-testid="playwright-error-state">
                                        <div class="flex items-center gap-2 text-sm text-destructive">
                                            <i data-lucide="alert-circle" class="w-4 h-4"></i>
                                            <span x-text="playwrightStatus.error || 'Unable to check Playwright status'"></span>
                                        </div>
                                        <button @click="refreshPlaywrightStatus()"
                                                :disabled="playwrightStatus.loading"
                                                class="btn-sm text-xs"
                                                data-testid="playwright-retry-btn">
                                            Retry
                                        </button>
                                    </div>
                                </template>

                                <!-- Story 17.11 AC4: Install Commands Section -->
                                <template x-if="playwrightStatus.data && !playwrightStatus.data.ready && playwrightStatus.data.install_commands?.length > 0">
                                    <div class="mb-4 border border-border rounded" data-testid="playwright-install-commands">
                                        <button @click="playwrightStatus.showCommands = !playwrightStatus.showCommands"
                                                class="w-full flex items-center justify-between px-3 py-2 text-sm hover:bg-muted/50 transition-colors"
                                                data-testid="playwright-install-toggle">
                                            <span class="flex items-center gap-2">
                                                <i data-lucide="terminal" class="w-4 h-4"></i>
                                                <span x-text="playwrightStatus.showCommands ? 'Hide Install Commands' : 'Show Install Commands'"></span>
                                            </span>
                                            <i :data-lucide="playwrightStatus.showCommands ? 'chevron-up' : 'chevron-down'" class="w-4 h-4"></i>
                                        </button>

                                        <div x-show="playwrightStatus.showCommands" x-transition class="border-t border-border">
                                            <div class="p-3 bg-muted/30">
                                                <div class="flex items-center justify-between mb-2">
                                                    <span class="text-xs text-muted-foreground">Run these commands to set up Playwright:</span>
                                                    <button @click="copyInstallCommands()"
                                                            class="text-xs flex items-center gap-1 px-2 py-1 rounded hover:bg-muted text-muted-foreground hover:text-foreground"
                                                            data-testid="playwright-copy-commands">
                                                        <i data-lucide="copy" class="w-3 h-3"></i>
                                                        Copy All
                                                    </button>
                                                </div>
                                                <pre class="font-mono text-sm bg-background p-3 rounded border border-border overflow-x-auto"><template x-for="(cmd, idx) in playwrightStatus.data.install_commands" :key="idx"><code x-text="cmd" class="block"></code></template></pre>
                                            </div>
                                        </div>
                                    </div>
                                </template>

                                <!-- Missing config message (AC1) -->
                                <template x-if="!hasPlaywrightConfig()">
                                    <p class="text-muted-foreground">
                                        Playwright configuration not enabled. Add <code class="bg-muted px-1 py-0.5 rounded text-sm">testarch.playwright</code> to your config to enable browser testing settings.
                                    </p>
                                </template>

                                <!-- Playwright controls (AC2-AC5) -->
                                <template x-if="hasPlaywrightConfig()">
                                    <div class="space-y-6">

                                        <!-- Browsers Checkbox Group (AC2) (Story 17.8: override indicator + reset buttons) -->
                                        <div class="space-y-2"
                                             :class="hasProjectOverride('testarch.playwright.browsers') ? 'border-l-2 border-primary pl-3 bg-primary/5 py-2 rounded-r' : ''">
                                            <div class="flex items-center justify-between flex-wrap gap-2">
                                                <label class="font-medium">Browsers</label>
                                                <div class="flex items-center gap-2">
                                                    <span class="badge-secondary text-xs">
                                                        from: <span x-text="getFieldSource('testarch.playwright.browsers')"></span>
                                                    </span>
                                                    <!-- Story 17.8 AC2: Reset to default button -->
                                                    <button x-show="canResetToDefault('testarch.playwright.browsers')"
                                                            @click="resetToDefault('testarch.playwright.browsers', 'Browsers')"
                                                            :disabled="settingsView.applying"
                                                            class="text-xs text-muted-foreground hover:text-foreground flex items-center gap-1 px-1.5 py-0.5 rounded hover:bg-muted"
                                                            data-testid="reset-browsers-default">
                                                        <i data-lucide="rotate-ccw" class="w-3 h-3"></i>
                                                        Reset to default
                                                    </button>
                                                    <!-- Story 17.8 AC3: Reset to global button (project scope only) -->
                                                    <button x-show="canResetToGlobal('testarch.playwright.browsers')"
                                                            @click="resetToGlobal('testarch.playwright.browsers', 'Browsers')"
                                                            :disabled="settingsView.applying"
                                                            class="text-xs text-muted-foreground hover:text-foreground flex items-center gap-1 px-1.5 py-0.5 rounded hover:bg-muted"
                                                            :title="'Will use: ' + formatValueForDisplay(getGlobalValue('testarch.playwright.browsers') ?? getDefaultValue('testarch.playwright.browsers'))"
                                                            data-testid="reset-browsers-global">
                                                        <i data-lucide="rotate-ccw" class="w-3 h-3"></i>
                                                        Reset to global
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="flex flex-wrap gap-4">
                                                <template x-for="browser in ['chromium', 'firefox', 'webkit']" :key="browser">
                                                    <label class="flex items-center gap-2 cursor-pointer">
                                                        <input type="checkbox"
                                                               class="input"
                                                               :checked="isBrowserSelected(browser)"
                                                               @change="toggleBrowser(browser)"
                                                               :data-testid="'browser-' + browser">
                                                        <span class="capitalize" x-text="browser"></span>
                                                    </label>
                                                </template>
                                            </div>
                                        </div>

                                        <!-- Headless Toggle (AC3) (Story 17.8: override indicator + reset buttons) -->
                                        <div class="space-y-2"
                                             :class="hasProjectOverride('testarch.playwright.headless') ? 'border-l-2 border-primary pl-3 bg-primary/5 py-2 rounded-r' : ''">
                                            <div class="flex items-center justify-between flex-wrap gap-2">
                                                <div>
                                                    <label class="font-medium">Headless Mode</label>
                                                    <p class="text-sm text-muted-foreground">Run browsers without visible UI</p>
                                                </div>
                                                <div class="flex items-center gap-2">
                                                    <span class="badge-secondary text-xs">
                                                        from: <span x-text="getFieldSource('testarch.playwright.headless')"></span>
                                                    </span>
                                                    <!-- Story 17.8 AC2: Reset to default button -->
                                                    <button x-show="canResetToDefault('testarch.playwright.headless')"
                                                            @click="resetToDefault('testarch.playwright.headless', 'Headless Mode')"
                                                            :disabled="settingsView.applying"
                                                            class="text-xs text-muted-foreground hover:text-foreground flex items-center gap-1 px-1.5 py-0.5 rounded hover:bg-muted"
                                                            data-testid="reset-headless-default">
                                                        <i data-lucide="rotate-ccw" class="w-3 h-3"></i>
                                                        Reset to default
                                                    </button>
                                                    <!-- Story 17.8 AC3: Reset to global button (project scope only) -->
                                                    <button x-show="canResetToGlobal('testarch.playwright.headless')"
                                                            @click="resetToGlobal('testarch.playwright.headless', 'Headless Mode')"
                                                            :disabled="settingsView.applying"
                                                            class="text-xs text-muted-foreground hover:text-foreground flex items-center gap-1 px-1.5 py-0.5 rounded hover:bg-muted"
                                                            :title="'Will use: ' + formatValueForDisplay(getGlobalValue('testarch.playwright.headless') ?? getDefaultValue('testarch.playwright.headless'))"
                                                            data-testid="reset-headless-global">
                                                        <i data-lucide="rotate-ccw" class="w-3 h-3"></i>
                                                        Reset to global
                                                    </button>
                                                </div>
                                            </div>
                                            <label class="flex items-center gap-3 cursor-pointer">
                                                <input type="checkbox"
                                                       role="switch"
                                                       class="input"
                                                       :checked="getFieldValue('testarch.playwright.headless') ?? true"
                                                       @change="addPendingUpdate('testarch.playwright.headless', $event.target.checked)"
                                                       data-testid="headless-toggle">
                                                <span x-text="(getFieldValue('testarch.playwright.headless') ?? true) ? 'Enabled' : 'Disabled'"
                                                      class="text-sm text-muted-foreground"></span>
                                            </label>
                                        </div>

                                        <!-- Timeout and Workers Row (AC4, AC5) (Story 17.8: override indicators + reset buttons) -->
                                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">

                                            <!-- Timeout Input (AC4) -->
                                            <div class="space-y-2"
                                                 :class="hasProjectOverride('testarch.playwright.timeout') ? 'border-l-2 border-primary pl-3 bg-primary/5 py-2 rounded-r' : ''">
                                                <div class="flex items-center justify-between flex-wrap gap-2">
                                                    <label class="font-medium">Timeout</label>
                                                    <div class="flex items-center gap-2">
                                                        <span class="badge-secondary text-xs">
                                                            from: <span x-text="getFieldSource('testarch.playwright.timeout')"></span>
                                                        </span>
                                                        <!-- Story 17.8 AC2: Reset to default button -->
                                                        <button x-show="canResetToDefault('testarch.playwright.timeout')"
                                                                @click="resetToDefault('testarch.playwright.timeout', 'Timeout')"
                                                                :disabled="settingsView.applying"
                                                                class="text-xs text-muted-foreground hover:text-foreground flex items-center gap-1 px-1.5 py-0.5 rounded hover:bg-muted"
                                                                data-testid="reset-timeout-default">
                                                            <i data-lucide="rotate-ccw" class="w-3 h-3"></i>
                                                            Reset to default
                                                        </button>
                                                        <!-- Story 17.8 AC3: Reset to global button (project scope only) -->
                                                        <button x-show="canResetToGlobal('testarch.playwright.timeout')"
                                                                @click="resetToGlobal('testarch.playwright.timeout', 'Timeout')"
                                                                :disabled="settingsView.applying"
                                                                class="text-xs text-muted-foreground hover:text-foreground flex items-center gap-1 px-1.5 py-0.5 rounded hover:bg-muted"
                                                                :title="'Will use: ' + formatValueForDisplay(getGlobalValue('testarch.playwright.timeout') ?? getDefaultValue('testarch.playwright.timeout'))"
                                                                data-testid="reset-timeout-global">
                                                            <i data-lucide="rotate-ccw" class="w-3 h-3"></i>
                                                            Reset to global
                                                        </button>
                                                    </div>
                                                </div>
                                                <div class="flex items-center gap-2">
                                                    <input type="number"
                                                           class="input w-28"
                                                           :class="validationErrors['testarch.playwright.timeout'] ? 'border-destructive' : ''"
                                                           :value="getFieldValue('testarch.playwright.timeout') ?? 30000"
                                                           min="1000"
                                                           max="300000"
                                                           @input="validateAndUpdateNumber('testarch.playwright.timeout', $event.target.value, 1000, 300000)"
                                                           data-testid="timeout-input">
                                                    <span class="text-muted-foreground text-sm">ms</span>
                                                </div>
                                                <p x-show="validationErrors['testarch.playwright.timeout']"
                                                   x-text="validationErrors['testarch.playwright.timeout']"
                                                   class="text-destructive text-sm"
                                                   data-testid="timeout-error"></p>
                                            </div>

                                            <!-- Workers Input (AC5) -->
                                            <div class="space-y-2"
                                                 :class="hasProjectOverride('testarch.playwright.workers') ? 'border-l-2 border-primary pl-3 bg-primary/5 py-2 rounded-r' : ''">
                                                <div class="flex items-center justify-between flex-wrap gap-2">
                                                    <label class="font-medium">Workers</label>
                                                    <div class="flex items-center gap-2">
                                                        <span class="badge-secondary text-xs">
                                                            from: <span x-text="getFieldSource('testarch.playwright.workers')"></span>
                                                        </span>
                                                        <!-- Story 17.8 AC2: Reset to default button -->
                                                        <button x-show="canResetToDefault('testarch.playwright.workers')"
                                                                @click="resetToDefault('testarch.playwright.workers', 'Workers')"
                                                                :disabled="settingsView.applying"
                                                                class="text-xs text-muted-foreground hover:text-foreground flex items-center gap-1 px-1.5 py-0.5 rounded hover:bg-muted"
                                                                data-testid="reset-workers-default">
                                                            <i data-lucide="rotate-ccw" class="w-3 h-3"></i>
                                                            Reset to default
                                                        </button>
                                                        <!-- Story 17.8 AC3: Reset to global button (project scope only) -->
                                                        <button x-show="canResetToGlobal('testarch.playwright.workers')"
                                                                @click="resetToGlobal('testarch.playwright.workers', 'Workers')"
                                                                :disabled="settingsView.applying"
                                                                class="text-xs text-muted-foreground hover:text-foreground flex items-center gap-1 px-1.5 py-0.5 rounded hover:bg-muted"
                                                                :title="'Will use: ' + formatValueForDisplay(getGlobalValue('testarch.playwright.workers') ?? getDefaultValue('testarch.playwright.workers'))"
                                                                data-testid="reset-workers-global">
                                                            <i data-lucide="rotate-ccw" class="w-3 h-3"></i>
                                                            Reset to global
                                                        </button>
                                                    </div>
                                                </div>
                                                <div class="flex items-center gap-2">
                                                    <input type="number"
                                                           class="input w-20"
                                                           :class="validationErrors['testarch.playwright.workers'] ? 'border-destructive' : ''"
                                                           :value="getFieldValue('testarch.playwright.workers') ?? 1"
                                                           min="1"
                                                           max="16"
                                                           @input="validateAndUpdateNumber('testarch.playwright.workers', $event.target.value, 1, 16)"
                                                           data-testid="workers-input">
                                                    <span class="text-muted-foreground text-sm">parallel</span>
                                                </div>
                                                <p x-show="validationErrors['testarch.playwright.workers']"
                                                   x-text="validationErrors['testarch.playwright.workers']"
                                                   class="text-destructive text-sm"
                                                   data-testid="workers-error"></p>
                                            </div>

                                        </div>

                                    </div>
                                </template>
                            </div>
                        </div>

                        <!-- Benchmarking Tab Content (Story 17.6) -->
                        <div x-show="settingsView.activeTab === 'benchmarking'"
                             x-init="$nextTick(() => refreshIcons())"
                             data-testid="tab-content-benchmarking">
                            <div class="card p-6">
                                <h3 class="text-lg font-medium mb-4 flex items-center gap-2">
                                    <i data-lucide="bar-chart-2" class="w-5 h-5"></i>
                                    Benchmarking
                                </h3>

                                <!-- Missing config message (AC1) -->
                                <template x-if="!hasBenchmarkingConfig()">
                                    <p class="text-muted-foreground">
                                        Benchmarking configuration not found. Add <code class="bg-muted px-1 py-0.5 rounded text-sm">benchmarking</code> section to your config to enable metrics collection settings.
                                    </p>
                                </template>

                                <!-- Benchmarking controls (AC2-AC4) (Story 17.8: override indicators + reset buttons) -->
                                <template x-if="hasBenchmarkingConfig()">
                                    <div class="space-y-6">

                                        <!-- Enabled Toggle (AC2) -->
                                        <div class="space-y-2"
                                             :class="hasProjectOverride('benchmarking.enabled') ? 'border-l-2 border-primary pl-3 bg-primary/5 py-2 rounded-r' : ''">
                                            <div class="flex items-center justify-between flex-wrap gap-2">
                                                <div>
                                                    <label class="font-medium">Enabled</label>
                                                    <p class="text-sm text-muted-foreground">Collect metrics during validation and code review phases</p>
                                                </div>
                                                <div class="flex items-center gap-2">
                                                    <span class="badge-secondary text-xs">
                                                        from: <span x-text="getFieldSource('benchmarking.enabled')"></span>
                                                    </span>
                                                    <!-- Story 17.8 AC2: Reset to default button -->
                                                    <button x-show="canResetToDefault('benchmarking.enabled')"
                                                            @click="resetToDefault('benchmarking.enabled', 'Benchmarking')"
                                                            :disabled="settingsView.applying"
                                                            class="text-xs text-muted-foreground hover:text-foreground flex items-center gap-1 px-1.5 py-0.5 rounded hover:bg-muted"
                                                            data-testid="reset-benchmarking-enabled-default">
                                                        <i data-lucide="rotate-ccw" class="w-3 h-3"></i>
                                                        Reset to default
                                                    </button>
                                                    <!-- Story 17.8 AC3: Reset to global button (project scope only) -->
                                                    <button x-show="canResetToGlobal('benchmarking.enabled')"
                                                            @click="resetToGlobal('benchmarking.enabled', 'Benchmarking')"
                                                            :disabled="settingsView.applying"
                                                            class="text-xs text-muted-foreground hover:text-foreground flex items-center gap-1 px-1.5 py-0.5 rounded hover:bg-muted"
                                                            :title="'Will use: ' + formatValueForDisplay(getGlobalValue('benchmarking.enabled') ?? getDefaultValue('benchmarking.enabled'))"
                                                            data-testid="reset-benchmarking-enabled-global">
                                                        <i data-lucide="rotate-ccw" class="w-3 h-3"></i>
                                                        Reset to global
                                                    </button>
                                                </div>
                                            </div>
                                            <label class="flex items-center gap-3 cursor-pointer">
                                                <input type="checkbox"
                                                       role="switch"
                                                       class="input"
                                                       :checked="getFieldValue('benchmarking.enabled') ?? true"
                                                       @change="addPendingUpdate('benchmarking.enabled', $event.target.checked)"
                                                       data-testid="benchmarking-enabled-toggle">
                                                <span x-text="(getFieldValue('benchmarking.enabled') ?? true) ? 'Enabled' : 'Disabled'"
                                                      class="text-sm text-muted-foreground"></span>
                                            </label>
                                        </div>

                                        <!-- Extraction Provider Dropdown (AC3) (Story 17.8: override indicator + reset buttons) -->
                                        <div class="space-y-2"
                                             :class="hasProjectOverride('benchmarking.extraction_provider') ? 'border-l-2 border-primary pl-3 bg-primary/5 py-2 rounded-r' : ''">
                                            <div class="flex items-center justify-between flex-wrap gap-2">
                                                <div class="flex items-center gap-2">
                                                    <label class="font-medium">Extraction Provider</label>
                                                    <span class="badge-outline text-xs text-bp-warning border-bp-warning"> risky</span>
                                                </div>
                                                <div class="flex items-center gap-2">
                                                    <span class="badge-secondary text-xs">
                                                        from: <span x-text="getFieldSource('benchmarking.extraction_provider')"></span>
                                                    </span>
                                                    <!-- Story 17.8 AC2: Reset to default button -->
                                                    <button x-show="canResetToDefault('benchmarking.extraction_provider')"
                                                            @click="resetToDefault('benchmarking.extraction_provider', 'Extraction Provider')"
                                                            :disabled="settingsView.applying"
                                                            class="text-xs text-muted-foreground hover:text-foreground flex items-center gap-1 px-1.5 py-0.5 rounded hover:bg-muted"
                                                            data-testid="reset-extraction-provider-default">
                                                        <i data-lucide="rotate-ccw" class="w-3 h-3"></i>
                                                        Reset to default
                                                    </button>
                                                    <!-- Story 17.8 AC3: Reset to global button (project scope only) -->
                                                    <button x-show="canResetToGlobal('benchmarking.extraction_provider')"
                                                            @click="resetToGlobal('benchmarking.extraction_provider', 'Extraction Provider')"
                                                            :disabled="settingsView.applying"
                                                            class="text-xs text-muted-foreground hover:text-foreground flex items-center gap-1 px-1.5 py-0.5 rounded hover:bg-muted"
                                                            :title="'Will use: ' + formatValueForDisplay(getGlobalValue('benchmarking.extraction_provider') ?? getDefaultValue('benchmarking.extraction_provider'))"
                                                            data-testid="reset-extraction-provider-global">
                                                        <i data-lucide="rotate-ccw" class="w-3 h-3"></i>
                                                        Reset to global
                                                    </button>
                                                </div>
                                            </div>
                                            <p class="text-sm text-muted-foreground">LLM provider used for metrics extraction</p>
                                            <div class="flex items-center gap-2">
                                                <input type="text"
                                                       class="input w-48"
                                                       :class="validationErrors['benchmarking.extraction_provider'] ? 'border-destructive' : ''"
                                                       list="benchmarking-provider-options"
                                                       :value="getFieldValue('benchmarking.extraction_provider') ?? 'claude'"
                                                       @input="validateDropdownField('benchmarking.extraction_provider', $event.target.value); if ($event.target.value.trim()) addPendingUpdate('benchmarking.extraction_provider', $event.target.value.trim())"
                                                       @blur="validateDropdownField('benchmarking.extraction_provider', $event.target.value)"
                                                       data-testid="extraction-provider-input">
                                                <datalist id="benchmarking-provider-options">
                                                    <option value="claude"></option>
                                                    <option value="claude-subprocess"></option>
                                                    <option value="gemini"></option>
                                                    <option value="codex"></option>
                                                </datalist>
                                            </div>
                                            <p x-show="validationErrors['benchmarking.extraction_provider']"
                                               x-text="validationErrors['benchmarking.extraction_provider']"
                                               class="text-destructive text-sm"
                                               data-testid="extraction-provider-error"></p>
                                        </div>

                                        <!-- Extraction Model Dropdown (AC4) (Story 17.8: override indicator + reset buttons) -->
                                        <div class="space-y-2"
                                             :class="hasProjectOverride('benchmarking.extraction_model') ? 'border-l-2 border-primary pl-3 bg-primary/5 py-2 rounded-r' : ''">
                                            <div class="flex items-center justify-between flex-wrap gap-2">
                                                <div class="flex items-center gap-2">
                                                    <label class="font-medium">Extraction Model</label>
                                                    <span class="badge-outline text-xs text-bp-warning border-bp-warning"> risky</span>
                                                </div>
                                                <div class="flex items-center gap-2">
                                                    <span class="badge-secondary text-xs">
                                                        from: <span x-text="getFieldSource('benchmarking.extraction_model')"></span>
                                                    </span>
                                                    <!-- Story 17.8 AC2: Reset to default button -->
                                                    <button x-show="canResetToDefault('benchmarking.extraction_model')"
                                                            @click="resetToDefault('benchmarking.extraction_model', 'Extraction Model')"
                                                            :disabled="settingsView.applying"
                                                            class="text-xs text-muted-foreground hover:text-foreground flex items-center gap-1 px-1.5 py-0.5 rounded hover:bg-muted"
                                                            data-testid="reset-extraction-model-default">
                                                        <i data-lucide="rotate-ccw" class="w-3 h-3"></i>
                                                        Reset to default
                                                    </button>
                                                    <!-- Story 17.8 AC3: Reset to global button (project scope only) -->
                                                    <button x-show="canResetToGlobal('benchmarking.extraction_model')"
                                                            @click="resetToGlobal('benchmarking.extraction_model', 'Extraction Model')"
                                                            :disabled="settingsView.applying"
                                                            class="text-xs text-muted-foreground hover:text-foreground flex items-center gap-1 px-1.5 py-0.5 rounded hover:bg-muted"
                                                            :title="'Will use: ' + formatValueForDisplay(getGlobalValue('benchmarking.extraction_model') ?? getDefaultValue('benchmarking.extraction_model'))"
                                                            data-testid="reset-extraction-model-global">
                                                        <i data-lucide="rotate-ccw" class="w-3 h-3"></i>
                                                        Reset to global
                                                    </button>
                                                </div>
                                            </div>
                                            <p class="text-sm text-muted-foreground">Model used for metrics extraction (prefer fast/cheap)</p>
                                            <div class="flex items-center gap-2">
                                                <input type="text"
                                                       class="input w-48"
                                                       :class="validationErrors['benchmarking.extraction_model'] ? 'border-destructive' : ''"
                                                       list="benchmarking-model-options"
                                                       :value="getFieldValue('benchmarking.extraction_model') ?? 'haiku'"
                                                       @input="validateDropdownField('benchmarking.extraction_model', $event.target.value); if ($event.target.value.trim()) addPendingUpdate('benchmarking.extraction_model', $event.target.value.trim())"
                                                       @blur="validateDropdownField('benchmarking.extraction_model', $event.target.value)"
                                                       data-testid="extraction-model-input">
                                                <datalist id="benchmarking-model-options">
                                                    <option value="haiku"></option>
                                                    <option value="sonnet"></option>
                                                    <option value="opus"></option>
                                                    <option value="claude-3-5-haiku-latest"></option>
                                                    <option value="gemini-2.5-flash"></option>
                                                </datalist>
                                            </div>
                                            <p x-show="validationErrors['benchmarking.extraction_model']"
                                               x-text="validationErrors['benchmarking.extraction_model']"
                                               class="text-destructive text-sm"
                                               data-testid="extraction-model-error"></p>
                                        </div>

                                    </div>
                                </template>
                            </div>
                        </div>

                        <!-- Providers Tab Content (Story 17.7) -->
                        <div x-show="settingsView.activeTab === 'providers'" data-testid="tab-content-providers">
                            <div class="card p-6">
                                <h3 class="text-lg font-medium mb-4 flex items-center gap-2">
                                    <i data-lucide="server" class="w-5 h-5"></i>
                                    Providers
                                </h3>

                                <!-- Missing config message (AC1) -->
                                <template x-if="!hasProvidersConfig()">
                                    <p class="text-muted-foreground">
                                        Provider configuration not found. The <code class="bg-muted px-1 py-0.5 rounded text-sm">providers</code> section is required in your config.
                                    </p>
                                </template>

                                <!-- Providers controls (AC2-AC4) -->
                                <template x-if="hasProvidersConfig()">
                                    <div class="space-y-8">

                                        <!-- Master Provider Section (AC2, AC3) -->
                                        <div class="space-y-4">
                                            <div class="flex items-center gap-3">
                                                <h4 class="text-base font-medium">Master Provider</h4>
                                                <span class="badge bg-primary/20 text-primary text-xs font-medium">MASTER</span>
                                            </div>

                                            <div class="p-4 border border-border rounded-lg bg-muted/30 space-y-5"
                                                 :class="(hasProjectOverride('providers.master.provider') || hasProjectOverride('providers.master.model') || hasProjectOverride('providers.master.model_name')) ? 'border-l-4 border-l-primary' : ''">
                                                <!-- Warning message about workflow impact -->
                                                <div class="flex items-center gap-2 text-sm text-muted-foreground">
                                                    <i data-lucide="alert-triangle" class="w-4 h-4 text-bp-warning"></i>
                                                    <span>Changes affect all workflow executions</span>
                                                </div>

                                                <!-- Provider Input (AC2, AC3) (Story 17.8: override indicator + reset buttons) -->
                                                <div class="space-y-2"
                                                     :class="hasProjectOverride('providers.master.provider') ? 'border-l-2 border-primary pl-3 bg-primary/5 py-2 rounded-r' : ''">
                                                    <div class="flex items-center justify-between flex-wrap gap-2">
                                                        <div class="flex items-center gap-2">
                                                            <label class="font-medium">Provider</label>
                                                            <span class="badge-outline text-xs text-bp-warning border-bp-warning"> risky</span>
                                                        </div>
                                                        <div class="flex items-center gap-2">
                                                            <span class="badge-secondary text-xs">
                                                                from: <span x-text="getMasterFieldSource('provider')"></span>
                                                            </span>
                                                            <!-- Story 17.8 AC2: Reset to default button -->
                                                            <button x-show="canResetToDefault('providers.master.provider')"
                                                                    @click="resetToDefault('providers.master.provider', 'Provider')"
                                                                    :disabled="settingsView.applying"
                                                                    class="text-xs text-muted-foreground hover:text-foreground flex items-center gap-1 px-1.5 py-0.5 rounded hover:bg-muted"
                                                                    data-testid="reset-master-provider-default">
                                                                <i data-lucide="rotate-ccw" class="w-3 h-3"></i>
                                                                Reset to default
                                                            </button>
                                                            <!-- Story 17.8 AC3: Reset to global button (project scope only) -->
                                                            <button x-show="canResetToGlobal('providers.master.provider')"
                                                                    @click="resetToGlobal('providers.master.provider', 'Provider')"
                                                                    :disabled="settingsView.applying"
                                                                    class="text-xs text-muted-foreground hover:text-foreground flex items-center gap-1 px-1.5 py-0.5 rounded hover:bg-muted"
                                                                    :title="'Will use: ' + formatValueForDisplay(getGlobalValue('providers.master.provider') ?? getDefaultValue('providers.master.provider'))"
                                                                    data-testid="reset-master-provider-global">
                                                                <i data-lucide="rotate-ccw" class="w-3 h-3"></i>
                                                                Reset to global
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <div class="flex items-center gap-2">
                                                        <input type="text"
                                                               class="input w-48"
                                                               :class="validationErrors['providers.master.provider'] ? 'border-destructive' : ''"
                                                               list="master-provider-options"
                                                               :value="getMasterField('provider') ?? ''"
                                                               @input="validateDropdownField('providers.master.provider', $event.target.value); addPendingUpdate('providers.master.provider', $event.target.value.trim() || null)"
                                                               @blur="validateDropdownField('providers.master.provider', $event.target.value)"
                                                               data-testid="master-provider-input">
                                                        <datalist id="master-provider-options">
                                                            <option value="claude"></option>
                                                            <option value="claude-subprocess"></option>
                                                            <option value="gemini"></option>
                                                            <option value="codex"></option>
                                                        </datalist>
                                                    </div>
                                                    <p x-show="validationErrors['providers.master.provider']"
                                                       x-text="validationErrors['providers.master.provider']"
                                                       class="text-destructive text-sm"
                                                       data-testid="master-provider-error"></p>
                                                </div>

                                                <!-- Model Input (AC2, AC3) (Story 17.8: override indicator + reset buttons) -->
                                                <div class="space-y-2"
                                                     :class="hasProjectOverride('providers.master.model') ? 'border-l-2 border-primary pl-3 bg-primary/5 py-2 rounded-r' : ''">
                                                    <div class="flex items-center justify-between flex-wrap gap-2">
                                                        <div class="flex items-center gap-2">
                                                            <label class="font-medium">Model</label>
                                                            <span class="badge-outline text-xs text-bp-warning border-bp-warning"> risky</span>
                                                        </div>
                                                        <div class="flex items-center gap-2">
                                                            <span class="badge-secondary text-xs">
                                                                from: <span x-text="getMasterFieldSource('model')"></span>
                                                            </span>
                                                            <!-- Story 17.8 AC2: Reset to default button -->
                                                            <button x-show="canResetToDefault('providers.master.model')"
                                                                    @click="resetToDefault('providers.master.model', 'Model')"
                                                                    :disabled="settingsView.applying"
                                                                    class="text-xs text-muted-foreground hover:text-foreground flex items-center gap-1 px-1.5 py-0.5 rounded hover:bg-muted"
                                                                    data-testid="reset-master-model-default">
                                                                <i data-lucide="rotate-ccw" class="w-3 h-3"></i>
                                                                Reset to default
                                                            </button>
                                                            <!-- Story 17.8 AC3: Reset to global button (project scope only) -->
                                                            <button x-show="canResetToGlobal('providers.master.model')"
                                                                    @click="resetToGlobal('providers.master.model', 'Model')"
                                                                    :disabled="settingsView.applying"
                                                                    class="text-xs text-muted-foreground hover:text-foreground flex items-center gap-1 px-1.5 py-0.5 rounded hover:bg-muted"
                                                                    :title="'Will use: ' + formatValueForDisplay(getGlobalValue('providers.master.model') ?? getDefaultValue('providers.master.model'))"
                                                                    data-testid="reset-master-model-global">
                                                                <i data-lucide="rotate-ccw" class="w-3 h-3"></i>
                                                                Reset to global
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <div class="flex items-center gap-2">
                                                        <input type="text"
                                                               class="input w-48"
                                                               :class="validationErrors['providers.master.model'] ? 'border-destructive' : ''"
                                                               list="master-model-options"
                                                               :value="getMasterField('model') ?? ''"
                                                               @input="validateDropdownField('providers.master.model', $event.target.value); addPendingUpdate('providers.master.model', $event.target.value.trim() || null)"
                                                               @blur="validateDropdownField('providers.master.model', $event.target.value)"
                                                               data-testid="master-model-input">
                                                        <datalist id="master-model-options">
                                                            <option value="opus"></option>
                                                            <option value="sonnet"></option>
                                                            <option value="haiku"></option>
                                                            <option value="gemini-2.5-flash"></option>
                                                            <option value="gpt-4o"></option>
                                                        </datalist>
                                                    </div>
                                                    <p x-show="validationErrors['providers.master.model']"
                                                       x-text="validationErrors['providers.master.model']"
                                                       class="text-destructive text-sm"
                                                       data-testid="master-model-error"></p>
                                                </div>

                                                <!-- Display Name Input (AC2, AC3 - SAFE field) (Story 17.8: override indicator + reset buttons) -->
                                                <div class="space-y-2"
                                                     :class="hasProjectOverride('providers.master.model_name') ? 'border-l-2 border-primary pl-3 bg-primary/5 py-2 rounded-r' : ''">
                                                    <div class="flex items-center justify-between flex-wrap gap-2">
                                                        <label class="font-medium">Display Name</label>
                                                        <div class="flex items-center gap-2">
                                                            <span class="badge-secondary text-xs">
                                                                from: <span x-text="getMasterFieldSource('model_name')"></span>
                                                            </span>
                                                            <!-- Story 17.8 AC2: Reset to default button -->
                                                            <button x-show="canResetToDefault('providers.master.model_name')"
                                                                    @click="resetToDefault('providers.master.model_name', 'Display Name')"
                                                                    :disabled="settingsView.applying"
                                                                    class="text-xs text-muted-foreground hover:text-foreground flex items-center gap-1 px-1.5 py-0.5 rounded hover:bg-muted"
                                                                    data-testid="reset-master-model-name-default">
                                                                <i data-lucide="rotate-ccw" class="w-3 h-3"></i>
                                                                Reset to default
                                                            </button>
                                                            <!-- Story 17.8 AC3: Reset to global button (project scope only) -->
                                                            <button x-show="canResetToGlobal('providers.master.model_name')"
                                                                    @click="resetToGlobal('providers.master.model_name', 'Display Name')"
                                                                    :disabled="settingsView.applying"
                                                                    class="text-xs text-muted-foreground hover:text-foreground flex items-center gap-1 px-1.5 py-0.5 rounded hover:bg-muted"
                                                                    :title="'Will use: ' + formatValueForDisplay(getGlobalValue('providers.master.model_name') ?? getDefaultValue('providers.master.model_name'))"
                                                                    data-testid="reset-master-model-name-global">
                                                                <i data-lucide="rotate-ccw" class="w-3 h-3"></i>
                                                                Reset to global
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <p class="text-sm text-muted-foreground">Optional name shown in logs/reports instead of model</p>
                                                    <div class="flex items-center gap-2">
                                                        <input type="text"
                                                               class="input w-48"
                                                               :value="getMasterField('model_name') ?? ''"
                                                               @input="addPendingUpdate('providers.master.model_name', $event.target.value.trim() || null)"
                                                               placeholder="e.g., glm-4.7"
                                                               data-testid="master-model-name-input">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Multi Validators Section (AC4) -->
                                        <div class="space-y-4">
                                            <div class="flex items-center gap-3">
                                                <h4 class="text-base font-medium">Multi Validators</h4>
                                                <span class="badge-secondary text-xs">
                                                    (<span x-text="getMultiValidators().length"></span>)
                                                </span>
                                            </div>

                                            <!-- Empty state -->
                                            <div x-show="getMultiValidators().length === 0"
                                                 class="text-muted-foreground text-sm py-4"
                                                 data-testid="multi-validators-empty">
                                                No multi validators configured
                                            </div>

                                            <!-- Validators list (read-only display) -->
                                            <div x-show="getMultiValidators().length > 0" class="space-y-2">
                                                <template x-for="(validator, index) in getMultiValidators()" :key="index">
                                                    <div class="flex items-center gap-4 p-3 bg-muted/50 rounded-lg border border-border"
                                                         data-testid="multi-validator-row">
                                                        <span class="badge bg-accent/20 text-accent text-xs font-medium flex-shrink-0">MULTI</span>
                                                        <div class="flex-1 grid grid-cols-1 sm:grid-cols-3 gap-2 text-sm">
                                                            <div>
                                                                <span class="text-muted-foreground">Provider:</span>
                                                                <span class="ml-1" x-text="validator.provider || 'Unknown'"></span>
                                                            </div>
                                                            <div>
                                                                <span class="text-muted-foreground">Model:</span>
                                                                <span class="ml-1" x-text="validator.model || 'Unknown'"></span>
                                                            </div>
                                                            <div>
                                                                <span class="text-muted-foreground">Display:</span>
                                                                <span class="ml-1" x-text="getMultiDisplayName(validator)"></span>
                                                            </div>
                                                        </div>
                                                        <span class="badge-secondary text-xs flex-shrink-0">
                                                            from: <span x-text="getMultiValidatorsSource()"></span>
                                                        </span>
                                                    </div>
                                                </template>
                                            </div>
                                        </div>

                                    </div>
                                </template>
                            </div>
                        </div>

                        <!-- Backups Section (Story 17.10 AC4-AC7) -->
                        <div class="mt-6 card" data-testid="backups-section">
                            <!-- Collapsible header (AC7) -->
                            <button @click="toggleBackupsSection()"
                                    class="w-full flex items-center justify-between p-4 hover:bg-muted/50 rounded-lg transition-colors"
                                    data-testid="backups-toggle">
                                <div class="flex items-center gap-2">
                                    <i data-lucide="archive" class="w-5 h-5"></i>
                                    <h3 class="text-lg font-medium">Configuration Backups</h3>
                                </div>
                                <i :data-lucide="backupsView.expanded ? 'chevron-up' : 'chevron-down'" class="w-5 h-5 text-muted-foreground"></i>
                            </button>

                            <!-- Collapsible content -->
                            <div x-show="backupsView.expanded"
                                 x-transition:enter="transition ease-out duration-200"
                                 x-transition:enter-start="opacity-0 -translate-y-2"
                                 x-transition:enter-end="opacity-100 translate-y-0"
                                 x-transition:leave="transition ease-in duration-150"
                                 x-transition:leave-start="opacity-100 translate-y-0"
                                 x-transition:leave-end="opacity-0 -translate-y-2"
                                 class="px-4 pb-4"
                                 data-testid="backups-content">

                                <!-- Loading state -->
                                <div x-show="backupsView.loading" class="flex items-center justify-center py-8">
                                    <i data-lucide="loader-2" class="w-6 h-6 animate-spin text-primary"></i>
                                </div>

                                <!-- Backup lists -->
                                <div x-show="!backupsView.loading" class="space-y-6">

                                    <!-- Global Backups (AC4) -->
                                    <div class="space-y-3">
                                        <h4 class="text-sm font-medium text-muted-foreground flex items-center gap-2">
                                            <i data-lucide="globe" class="w-4 h-4"></i>
                                            Global Backups
                                        </h4>

                                        <div x-show="backupsView.globalBackups.length === 0"
                                             class="text-sm text-muted-foreground py-2">
                                            No global backups available
                                        </div>

                                        <template x-for="backup in backupsView.globalBackups" :key="backup.version">
                                            <div class="flex items-center justify-between p-3 bg-muted/30 rounded-lg border border-border"
                                                 data-testid="global-backup-row">
                                                <div class="flex items-center gap-3">
                                                    <span class="badge-secondary text-xs">v<span x-text="backup.version"></span></span>
                                                    <span class="text-sm text-muted-foreground" x-text="formatBackupTime(backup.modified)"></span>
                                                </div>
                                                <div class="flex items-center gap-2">
                                                    <!-- View button (AC6) -->
                                                    <button @click="viewBackup('global', backup)"
                                                            class="btn-sm-icon-ghost"
                                                            title="View backup content"
                                                            data-testid="view-global-backup">
                                                        <i data-lucide="eye" class="w-4 h-4"></i>
                                                    </button>
                                                    <!-- Restore button (AC5) -->
                                                    <button @click="restoreBackup('global', backup.version)"
                                                            :disabled="backupsView.restoring"
                                                            class="btn-sm text-xs"
                                                            data-testid="restore-global-backup">
                                                        <template x-if="backupsView.restoring">
                                                            <i data-lucide="loader-2" class="w-3 h-3 animate-spin"></i>
                                                        </template>
                                                        <template x-if="!backupsView.restoring">
                                                            <i data-lucide="rotate-ccw" class="w-3 h-3"></i>
                                                        </template>
                                                        Restore
                                                    </button>
                                                </div>
                                            </div>
                                        </template>
                                    </div>

                                    <!-- Project Backups (AC4) -->
                                    <div class="space-y-3">
                                        <h4 class="text-sm font-medium text-muted-foreground flex items-center gap-2">
                                            <i data-lucide="folder" class="w-4 h-4"></i>
                                            Project Backups
                                        </h4>

                                        <div x-show="backupsView.projectBackups.length === 0"
                                             class="text-sm text-muted-foreground py-2">
                                            No project backups available
                                        </div>

                                        <template x-for="backup in backupsView.projectBackups" :key="backup.version">
                                            <div class="flex items-center justify-between p-3 bg-muted/30 rounded-lg border border-border"
                                                 data-testid="project-backup-row">
                                                <div class="flex items-center gap-3">
                                                    <span class="badge-secondary text-xs">v<span x-text="backup.version"></span></span>
                                                    <span class="text-sm text-muted-foreground" x-text="formatBackupTime(backup.modified)"></span>
                                                </div>
                                                <div class="flex items-center gap-2">
                                                    <!-- View button (AC6) -->
                                                    <button @click="viewBackup('project', backup)"
                                                            class="btn-sm-icon-ghost"
                                                            title="View backup content"
                                                            data-testid="view-project-backup">
                                                        <i data-lucide="eye" class="w-4 h-4"></i>
                                                    </button>
                                                    <!-- Restore button (AC5) -->
                                                    <button @click="restoreBackup('project', backup.version)"
                                                            :disabled="backupsView.restoring"
                                                            class="btn-sm text-xs"
                                                            data-testid="restore-project-backup">
                                                        <template x-if="backupsView.restoring">
                                                            <i data-lucide="loader-2" class="w-3 h-3 animate-spin"></i>
                                                        </template>
                                                        <template x-if="!backupsView.restoring">
                                                            <i data-lucide="rotate-ccw" class="w-3 h-3"></i>
                                                        </template>
                                                        Restore
                                                    </button>
                                                </div>
                                            </div>
                                        </template>
                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Experiments Panel (Story 19.1) -->
            <div x-show="experimentsView.open"
                 x-transition:enter="transition ease-out duration-200"
                 x-transition:enter-start="opacity-0"
                 x-transition:enter-end="opacity-100"
                 x-transition:leave="transition ease-in duration-150"
                 x-transition:leave-start="opacity-100"
                 x-transition:leave-end="opacity-0"
                 @keydown.escape.window="if (experimentsView.open && !settingsView.open && !contextMenu.show) closeExperiments()"
                 class="flex-1 flex flex-col bg-background overflow-hidden"
                 data-testid="experiments-panel">

                <!-- Experiments Header -->
                <div class="flex items-center justify-between px-4 py-3 border-b border-border bg-card">
                    <div class="flex items-center gap-4">
                        <h2 class="text-lg font-semibold flex items-center gap-2">
                            <i data-lucide="flask-conical" class="w-5 h-5"></i>
                            Experiments
                        </h2>
                        <!-- Tabs (Story 19.3) -->
                        <div class="flex items-center gap-1 ml-2">
                            <button @click="switchExperimentsTab('runs')"
                                    :class="experimentsView.activeTab === 'runs' ? 'bg-muted text-foreground' : 'text-muted-foreground hover:text-foreground'"
                                    class="px-3 py-1.5 text-sm font-medium rounded-md transition-colors"
                                    data-testid="tab-runs">
                                <i data-lucide="play-circle" class="w-4 h-4 inline-block mr-1"></i>
                                Runs
                                <span x-show="experimentsView.pagination.total > 0"
                                      class="ml-1 text-xs opacity-60"
                                      x-text="`(${experimentsView.pagination.total})`"></span>
                            </button>
                            <button @click="switchExperimentsTab('fixtures')"
                                    :class="experimentsView.activeTab === 'fixtures' ? 'bg-muted text-foreground' : 'text-muted-foreground hover:text-foreground'"
                                    class="px-3 py-1.5 text-sm font-medium rounded-md transition-colors"
                                    data-testid="tab-fixtures">
                                <i data-lucide="box" class="w-4 h-4 inline-block mr-1"></i>
                                Fixtures
                                <span x-show="fixturesView.total > 0"
                                      class="ml-1 text-xs opacity-60"
                                      x-text="`(${fixturesView.total})`"></span>
                            </button>
                            <button @click="switchExperimentsTab('templates')"
                                    :class="experimentsView.activeTab === 'templates' ? 'bg-muted text-foreground' : 'text-muted-foreground hover:text-foreground'"
                                    class="px-3 py-1.5 text-sm font-medium rounded-md transition-colors"
                                    data-testid="tab-templates">
                                <i data-lucide="settings-2" class="w-4 h-4 inline-block mr-1"></i>
                                Templates
                                <span x-show="getTemplatesTotal() > 0"
                                      class="ml-1 text-xs opacity-60"
                                      x-text="`(${getTemplatesTotal()})`"></span>
                            </button>
                        </div>
                    </div>

                    <div class="flex items-center gap-2">
                        <!-- Selection count and Compare button (runs tab only) -->
                        <template x-if="experimentsView.activeTab === 'runs' && experimentsView.selected.length > 0">
                            <div class="flex items-center gap-2 mr-2">
                                <span class="text-sm text-muted-foreground"
                                      x-text="`${experimentsView.selected.length} selected`"></span>
                                <button class="btn-outline text-sm"
                                        :disabled="experimentsView.selected.length < 2 || experimentsView.selected.length > 10"
                                        @click="compareSelectedRuns()"
                                        :title="experimentsView.selected.length > 10 ? 'Maximum 10 runs allowed' : ''"
                                        data-testid="compare-button">
                                    <i data-lucide="diff" class="w-4 h-4"></i>
                                    Compare
                                </button>
                            </div>
                        </template>

                        <!-- New Run button (Story 19.6) -->
                        <button @click="openRunTriggerModal()"
                                :disabled="hasActiveExperiment()"
                                class="btn text-sm"
                                :title="hasActiveExperiment() ? 'An experiment is already running' : 'Start a new experiment run'"
                                data-testid="new-run-button">
                            <i data-lucide="play" class="w-4 h-4"></i>
                            New Run
                        </button>

                        <!-- Refresh button -->
                        <button @click="experimentsView.activeTab === 'runs' ? fetchExperimentRuns() : (experimentsView.activeTab === 'fixtures' ? fetchFixtures() : fetchTemplates())"
                                :disabled="experimentsView.loading || fixturesView.loading || templatesView.loading"
                                class="btn-outline"
                                data-testid="refresh-experiments">
                            <i data-lucide="refresh-cw" class="w-4 h-4" :class="{'animate-spin': experimentsView.loading || fixturesView.loading}"></i>
                        </button>

                        <!-- Close button -->
                        <button @click="closeExperiments()" class="btn-ghost" data-testid="close-experiments">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>

                <!-- Runs Tab Content -->
                <div x-show="experimentsView.activeTab === 'runs'" class="flex-1 flex flex-col overflow-hidden">
                <!-- Filters Row -->
                <div class="px-4 py-2 border-b border-border bg-card/50 flex flex-wrap items-center gap-2">
                    <!-- Status filter -->
                    <select x-model="experimentsView.filters.status"
                            @change="applyExperimentFilters()"
                            class="input h-8 text-sm w-32"
                            data-testid="filter-status">
                        <option value="">All Status</option>
                        <option value="completed">Completed</option>
                        <option value="running">Running</option>
                        <option value="failed">Failed</option>
                        <option value="cancelled">Cancelled</option>
                    </select>

                    <!-- Fixture filter -->
                    <input type="text"
                           x-model="experimentsView.filters.fixture"
                           @keydown.enter="applyExperimentFilters()"
                           placeholder="Fixture"
                           class="input h-8 text-sm w-28"
                           data-testid="filter-fixture">

                    <!-- Config filter -->
                    <input type="text"
                           x-model="experimentsView.filters.config"
                           @keydown.enter="applyExperimentFilters()"
                           placeholder="Config"
                           class="input h-8 text-sm w-28"
                           data-testid="filter-config">

                    <!-- Date range -->
                    <input type="date"
                           x-model="experimentsView.filters.start_date"
                           @change="applyExperimentFilters()"
                           class="input h-8 text-sm"
                           data-testid="filter-start-date">
                    <span class="text-muted-foreground">to</span>
                    <input type="date"
                           x-model="experimentsView.filters.end_date"
                           @change="applyExperimentFilters()"
                           class="input h-8 text-sm"
                           data-testid="filter-end-date">

                    <!-- Apply/Clear buttons -->
                    <button @click="applyExperimentFilters()"
                            class="btn-outline h-8 text-sm"
                            data-testid="apply-filters">
                        <i data-lucide="search" class="w-3 h-3"></i> Apply
                    </button>
                    <button @click="clearExperimentFilters()"
                            class="btn-ghost h-8 text-sm text-muted-foreground"
                            data-testid="clear-filters">
                        Clear
                    </button>
                </div>

                <!-- Experiments Table -->
                <div class="flex-1 overflow-auto">
                    <!-- Loading State -->
                    <div x-show="experimentsView.loading" class="flex items-center justify-center h-32">
                        <i data-lucide="loader-2" class="w-6 h-6 animate-spin text-primary"></i>
                    </div>

                    <!-- Error State -->
                    <div x-show="experimentsView.error && !experimentsView.loading"
                         class="text-destructive text-sm p-4 flex items-center gap-2">
                        <i data-lucide="alert-circle" class="w-4 h-4"></i>
                        <span x-text="experimentsView.error"></span>
                    </div>

                    <!-- Empty State -->
                    <div x-show="!experimentsView.loading && !experimentsView.error && experimentsView.runs.length === 0"
                         class="text-muted-foreground text-sm p-8 text-center">
                        <i data-lucide="inbox" class="w-12 h-12 mx-auto mb-2 opacity-50"></i>
                        <p>No experiment runs found</p>
                        <p class="text-xs mt-1">Try adjusting your filters or run an experiment</p>
                    </div>

                    <!-- Table -->
                    <table x-show="!experimentsView.loading && !experimentsView.error && experimentsView.runs.length > 0"
                           class="w-full text-sm">
                        <thead class="bg-muted/50 sticky top-0">
                            <tr>
                                <th class="px-3 py-2 text-left w-8">
                                    <input type="checkbox" class="checkbox" disabled title="Select all">
                                </th>
                                <th class="px-3 py-2 text-left cursor-pointer hover:bg-muted/80"
                                    @click="sortExperimentsBy('started')">
                                    <div class="flex items-center gap-1">
                                        Started
                                        <i :data-lucide="getSortIcon('started')" class="w-3 h-3"></i>
                                    </div>
                                </th>
                                <th class="px-3 py-2 text-left cursor-pointer hover:bg-muted/80"
                                    @click="sortExperimentsBy('status')">
                                    <div class="flex items-center gap-1">
                                        Status
                                        <i :data-lucide="getSortIcon('status')" class="w-3 h-3"></i>
                                    </div>
                                </th>
                                <th class="px-3 py-2 text-left cursor-pointer hover:bg-muted/80"
                                    @click="sortExperimentsBy('duration')">
                                    <div class="flex items-center gap-1">
                                        Duration
                                        <i :data-lucide="getSortIcon('duration')" class="w-3 h-3"></i>
                                    </div>
                                </th>
                                <th class="px-3 py-2 text-left">Fixture</th>
                                <th class="px-3 py-2 text-left">Config</th>
                                <th class="px-3 py-2 text-left">Results</th>
                                <th class="px-3 py-2 text-left w-20">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="run in experimentsView.runs" :key="run.run_id">
                                <tr class="border-b border-border hover:bg-muted/30 transition-colors"
                                    :class="{'bg-primary/10': isRunSelected(run.run_id)}">
                                    <td class="px-3 py-2">
                                        <input type="checkbox"
                                               class="checkbox"
                                               :checked="isRunSelected(run.run_id)"
                                               @change="toggleRunSelection(run.run_id)">
                                    </td>
                                    <td class="px-3 py-2">
                                        <div class="font-mono text-xs" x-text="run.run_id"></div>
                                        <div class="text-muted-foreground text-xs" x-text="formatDateTime(run.started)"></div>
                                    </td>
                                    <td class="px-3 py-2">
                                        <span class="badge" :class="getExperimentStatusClass(run.status)" x-text="run.status"></span>
                                    </td>
                                    <td class="px-3 py-2 tabular-nums" x-text="formatDuration(run.duration_seconds)"></td>
                                    <td class="px-3 py-2" x-text="run.input.fixture"></td>
                                    <td class="px-3 py-2" x-text="run.input.config"></td>
                                    <td class="px-3 py-2">
                                        <template x-if="run.results">
                                            <div class="text-xs">
                                                <span class="text-accent" x-text="run.results.stories_completed"></span>/<span x-text="run.results.stories_attempted"></span>
                                                <span x-show="run.results.stories_failed > 0" class="text-destructive ml-1" x-text="`(${run.results.stories_failed} failed)`"></span>
                                            </div>
                                        </template>
                                        <template x-if="!run.results">
                                            <span class="text-muted-foreground">-</span>
                                        </template>
                                    </td>
                                    <td class="px-3 py-2">
                                        <button class="btn-ghost p-1" title="View details"
                                                @click="openExperimentDetails(run.run_id)"
                                                data-testid="view-run-details">
                                            <i data-lucide="eye" class="w-4 h-4"></i>
                                        </button>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>

                <!-- Pagination Footer -->
                <div x-show="experimentsView.pagination.total > 0"
                     class="px-4 py-2 border-t border-border bg-card flex items-center justify-between">
                    <div class="text-sm text-muted-foreground">
                        Showing <span x-text="experimentsView.pagination.offset + 1"></span>-<span x-text="Math.min(experimentsView.pagination.offset + experimentsView.runs.length, experimentsView.pagination.total)"></span>
                        of <span x-text="experimentsView.pagination.total"></span>
                    </div>
                    <div class="flex items-center gap-2">
                        <button @click="goToExperimentPage(Math.max(0, experimentsView.pagination.offset - experimentsView.pagination.limit))"
                                :disabled="experimentsView.pagination.offset === 0"
                                class="btn-ghost p-1"
                                data-testid="prev-page">
                            <i data-lucide="chevron-left" class="w-4 h-4"></i>
                        </button>
                        <span class="text-sm text-muted-foreground">
                            Page <span x-text="Math.floor(experimentsView.pagination.offset / experimentsView.pagination.limit) + 1"></span>
                            of <span x-text="Math.ceil(experimentsView.pagination.total / experimentsView.pagination.limit)"></span>
                        </span>
                        <button @click="goToExperimentPage(experimentsView.pagination.offset + experimentsView.pagination.limit)"
                                :disabled="!experimentsView.pagination.has_more"
                                class="btn-ghost p-1"
                                data-testid="next-page">
                            <i data-lucide="chevron-right" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Fixtures Tab Content (Story 19.3) -->
            <div x-show="experimentsView.activeTab === 'fixtures'" class="flex-1 flex flex-col overflow-hidden">
                <!-- Fixtures Filters Row -->
                <div class="px-4 py-2 border-b border-border bg-card/50 flex flex-wrap items-center gap-2">
                    <!-- Difficulty filter -->
                    <select x-model="fixturesView.filters.difficulty"
                            @change="applyFixtureFilters()"
                            class="input h-8 text-sm w-32"
                            data-testid="filter-difficulty">
                        <option value="">All Difficulties</option>
                        <option value="trivial">Trivial</option>
                        <option value="simple">Simple</option>
                        <option value="medium">Medium</option>
                        <option value="complex">Complex</option>
                        <option value="expert">Expert</option>
                    </select>

                    <!-- Tags filter -->
                    <input type="text"
                           x-model="fixturesView.filters.tags"
                           @keydown.enter="applyFixtureFilters()"
                           placeholder="Tags (comma-separated)"
                           class="input h-8 text-sm w-48"
                           data-testid="filter-tags">

                    <!-- Apply/Clear buttons -->
                    <button @click="applyFixtureFilters()"
                            class="btn-outline h-8 text-sm"
                            data-testid="apply-fixture-filters">
                        <i data-lucide="search" class="w-3 h-3"></i> Apply
                    </button>
                    <button @click="clearFixtureFilters()"
                            class="btn-ghost h-8 text-sm text-muted-foreground"
                            data-testid="clear-fixture-filters">
                        Clear
                    </button>

                    <!-- Sort controls -->
                    <div class="ml-auto flex items-center gap-2">
                        <span class="text-sm text-muted-foreground">Sort by:</span>
                        <select x-model="fixturesView.sort.by"
                                @change="sortFixturesBy(fixturesView.sort.by)"
                                class="input h-8 text-sm w-32"
                                data-testid="sort-fixtures-by">
                            <option value="name">Name</option>
                            <option value="difficulty">Difficulty</option>
                            <option value="run_count">Run Count</option>
                            <option value="last_run">Last Run</option>
                            <option value="estimated_cost">Est. Cost</option>
                        </select>
                        <button @click="fixturesView.sort.order = fixturesView.sort.order === 'asc' ? 'desc' : 'asc'; applyFixtureFilters()"
                                class="btn-ghost p-1"
                                :title="fixturesView.sort.order === 'asc' ? 'Ascending' : 'Descending'"
                                data-testid="sort-order-toggle">
                            <i x-show="fixturesView.sort.order === 'asc'" data-lucide="arrow-up" class="w-4 h-4"></i>
                            <i x-show="fixturesView.sort.order === 'desc'" data-lucide="arrow-down" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>

                <!-- Fixtures Content -->
                <div class="flex-1 overflow-auto p-4">
                    <!-- Loading State -->
                    <div x-show="fixturesView.loading" class="flex items-center justify-center h-32">
                        <i data-lucide="loader-2" class="w-6 h-6 animate-spin text-primary"></i>
                    </div>

                    <!-- Error State -->
                    <div x-show="fixturesView.error && !fixturesView.loading"
                         class="text-destructive text-sm p-4 flex items-center gap-2">
                        <i data-lucide="alert-circle" class="w-4 h-4"></i>
                        <span x-text="fixturesView.error"></span>
                    </div>

                    <!-- Empty State -->
                    <div x-show="!fixturesView.loading && !fixturesView.error && fixturesView.fixtures.length === 0"
                         class="flex flex-col items-center justify-center h-32 text-muted-foreground">
                        <i data-lucide="package" class="w-8 h-8 mb-2"></i>
                        <p>No fixtures found</p>
                    </div>

                    <!-- Fixtures Grid -->
                    <div x-show="!fixturesView.loading && fixturesView.fixtures.length > 0"
                         class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <template x-for="fixture in fixturesView.fixtures" :key="fixture.id">
                            <div class="bg-card border border-border rounded-lg p-4 hover:border-primary/50 cursor-pointer transition-colors"
                                 @click="openFixtureDetails(fixture.id)"
                                 data-testid="fixture-card">
                                <!-- Fixture Header -->
                                <div class="flex items-start justify-between mb-2">
                                    <div class="flex-1 min-w-0">
                                        <h3 class="font-semibold text-sm truncate" x-text="fixture.name"></h3>
                                        <p class="text-xs text-muted-foreground font-mono truncate" x-text="fixture.id"></p>
                                    </div>
                                    <span class="badge ml-2 text-xs"
                                          :class="getDifficultyClass(fixture.difficulty)"
                                          x-text="fixture.difficulty"></span>
                                </div>

                                <!-- Description -->
                                <p x-show="fixture.description"
                                   class="text-sm text-muted-foreground mb-3 line-clamp-2"
                                   x-text="fixture.description"></p>

                                <!-- Tags -->
                                <div x-show="fixture.tags && fixture.tags.length > 0" class="flex flex-wrap gap-1 mb-3">
                                    <template x-for="tag in fixture.tags.slice(0, 4)" :key="tag">
                                        <span class="badge badge-secondary text-xs" x-text="tag"></span>
                                    </template>
                                    <span x-show="fixture.tags.length > 4"
                                          class="badge badge-secondary text-xs"
                                          x-text="`+${fixture.tags.length - 4}`"></span>
                                </div>

                                <!-- Stats -->
                                <div class="flex items-center justify-between text-xs text-muted-foreground border-t border-border pt-2 mt-2">
                                    <div class="flex items-center gap-1">
                                        <i data-lucide="play" class="w-3 h-3"></i>
                                        <span x-text="`${fixture.run_count} runs`"></span>
                                    </div>
                                    <div class="flex items-center gap-1">
                                        <i data-lucide="dollar-sign" class="w-3 h-3"></i>
                                        <span x-text="fixture.estimated_cost"></span>
                                    </div>
                                    <div x-show="fixture.last_run" class="flex items-center gap-1">
                                        <i data-lucide="clock" class="w-3 h-3"></i>
                                        <span x-text="formatFixtureDate(fixture.last_run)"></span>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Fixtures Summary Footer -->
                <div x-show="fixturesView.total > 0"
                     class="px-4 py-2 border-t border-border bg-card flex items-center justify-between">
                    <div class="text-sm text-muted-foreground">
                        Showing <span x-text="fixturesView.fixtures.length"></span>
                        of <span x-text="fixturesView.total"></span> fixtures
                    </div>
                </div>
            </div>

            <!-- Templates Tab Content (Story 19.5) -->
            <div x-show="experimentsView.activeTab === 'templates'" class="flex-1 flex flex-col overflow-hidden">
                <!-- Sub-tabs Row -->
                <div class="px-4 py-2 border-b border-border bg-card/50 flex flex-wrap items-center gap-2">
                    <div class="flex items-center gap-1 mr-4">
                        <button @click="switchTemplatesSubTab('configs')"
                                :class="templatesView.activeSubTab === 'configs' ? 'bg-primary/10 text-primary border-primary' : 'text-muted-foreground hover:text-foreground border-transparent'"
                                class="px-3 py-1.5 text-sm font-medium rounded-md transition-colors border"
                                data-testid="subtab-configs">
                            Configs
                            <span x-show="templatesView.configsTotal > 0"
                                  class="ml-1 text-xs opacity-60"
                                  x-text="`(${templatesView.configsTotal})`"></span>
                        </button>
                        <button @click="switchTemplatesSubTab('loops')"
                                :class="templatesView.activeSubTab === 'loops' ? 'bg-primary/10 text-primary border-primary' : 'text-muted-foreground hover:text-foreground border-transparent'"
                                class="px-3 py-1.5 text-sm font-medium rounded-md transition-colors border"
                                data-testid="subtab-loops">
                            Loops
                            <span x-show="templatesView.loopsTotal > 0"
                                  class="ml-1 text-xs opacity-60"
                                  x-text="`(${templatesView.loopsTotal})`"></span>
                        </button>
                        <button @click="switchTemplatesSubTab('patch-sets')"
                                :class="templatesView.activeSubTab === 'patch-sets' ? 'bg-primary/10 text-primary border-primary' : 'text-muted-foreground hover:text-foreground border-transparent'"
                                class="px-3 py-1.5 text-sm font-medium rounded-md transition-colors border"
                                data-testid="subtab-patchsets">
                            Patch-Sets
                            <span x-show="templatesView.patchSetsTotal > 0"
                                  class="ml-1 text-xs opacity-60"
                                  x-text="`(${templatesView.patchSetsTotal})`"></span>
                        </button>
                    </div>

                    <!-- Sort controls -->
                    <div class="flex items-center gap-2 ml-auto">
                        <span class="text-sm text-muted-foreground">Sort by:</span>
                        <select x-model="templatesView.sort.by"
                                @change="sortTemplatesBy(templatesView.sort.by)"
                                class="input h-8 text-sm w-32"
                                data-testid="sort-templates-by">
                            <option value="name">Name</option>
                            <option value="run_count">Run Count</option>
                            <option value="last_run">Last Run</option>
                        </select>
                        <button @click="templatesView.sort.order = templatesView.sort.order === 'asc' ? 'desc' : 'asc'; fetchTemplates()"
                                class="btn-outline h-8 px-2"
                                :title="templatesView.sort.order === 'asc' ? 'Ascending' : 'Descending'">
                            <i :data-lucide="templatesView.sort.order === 'asc' ? 'sort-asc' : 'sort-desc'" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>

                <!-- Templates Content -->
                <div class="flex-1 overflow-auto p-4">
                    <!-- Loading State -->
                    <div x-show="templatesView.loading" class="flex items-center justify-center py-12">
                        <i data-lucide="loader-2" class="w-8 h-8 animate-spin text-primary"></i>
                    </div>

                    <!-- Error State -->
                    <div x-show="!templatesView.loading && templatesView.error"
                         class="text-center py-12">
                        <i data-lucide="alert-circle" class="w-12 h-12 mx-auto text-destructive mb-4"></i>
                        <div class="text-destructive" x-text="templatesView.error"></div>
                        <button @click="fetchTemplates()" class="btn-outline mt-4">Retry</button>
                    </div>

                    <!-- Configs Table -->
                    <div x-show="!templatesView.loading && !templatesView.error && templatesView.activeSubTab === 'configs'">
                        <!-- Empty State -->
                        <div x-show="templatesView.configs.length === 0" class="text-center py-12 text-muted-foreground">
                            <i data-lucide="settings" class="w-12 h-12 mx-auto mb-4 opacity-40"></i>
                            <p>No config templates found in experiments/configs/</p>
                        </div>

                        <!-- Configs Grid -->
                        <div x-show="templatesView.configs.length > 0" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <template x-for="config in templatesView.configs" :key="config.name">
                                <div @click="openConfigDetails(config.name)"
                                     class="bg-card border border-border rounded-lg p-4 hover:border-primary/50 cursor-pointer transition-colors">
                                    <div class="flex items-start justify-between mb-2">
                                        <h3 class="font-mono font-medium" x-text="config.name"></h3>
                                        <span class="badge badge-secondary text-xs" x-text="`${config.run_count} runs`"></span>
                                    </div>
                                    <p class="text-sm text-muted-foreground line-clamp-2 mb-2"
                                       x-text="config.description || 'No description'"></p>
                                    <div class="flex items-center justify-between text-xs text-muted-foreground">
                                        <span>Last run: <span x-text="formatTemplateDate(config.last_run)"></span></span>
                                        <span x-show="config.providers?.master" x-text="config.providers.master?.model || ''"></span>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- Loops Table -->
                    <div x-show="!templatesView.loading && !templatesView.error && templatesView.activeSubTab === 'loops'">
                        <!-- Empty State -->
                        <div x-show="templatesView.loops.length === 0" class="text-center py-12 text-muted-foreground">
                            <i data-lucide="repeat" class="w-12 h-12 mx-auto mb-4 opacity-40"></i>
                            <p>No loop templates found in experiments/loops/</p>
                        </div>

                        <!-- Loops Grid -->
                        <div x-show="templatesView.loops.length > 0" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <template x-for="loop in templatesView.loops" :key="loop.name">
                                <div @click="openLoopDetails(loop.name)"
                                     class="bg-card border border-border rounded-lg p-4 hover:border-primary/50 cursor-pointer transition-colors">
                                    <div class="flex items-start justify-between mb-2">
                                        <h3 class="font-mono font-medium" x-text="loop.name"></h3>
                                        <span class="badge badge-secondary text-xs" x-text="`${loop.run_count} runs`"></span>
                                    </div>
                                    <p class="text-sm text-muted-foreground line-clamp-2 mb-2"
                                       x-text="loop.description || 'No description'"></p>
                                    <div class="flex items-center justify-between text-xs text-muted-foreground">
                                        <span><span x-text="loop.step_count"></span> steps</span>
                                        <span>Last run: <span x-text="formatTemplateDate(loop.last_run)"></span></span>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- Patch-Sets Table -->
                    <div x-show="!templatesView.loading && !templatesView.error && templatesView.activeSubTab === 'patch-sets'">
                        <!-- Empty State -->
                        <div x-show="templatesView.patchSets.length === 0" class="text-center py-12 text-muted-foreground">
                            <i data-lucide="file-diff" class="w-12 h-12 mx-auto mb-4 opacity-40"></i>
                            <p>No patch-set manifests found in experiments/patch-sets/</p>
                        </div>

                        <!-- Patch-Sets Grid -->
                        <div x-show="templatesView.patchSets.length > 0" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <template x-for="patchSet in templatesView.patchSets" :key="patchSet.name">
                                <div @click="openPatchSetDetails(patchSet.name)"
                                     class="bg-card border border-border rounded-lg p-4 hover:border-primary/50 cursor-pointer transition-colors">
                                    <div class="flex items-start justify-between mb-2">
                                        <h3 class="font-mono font-medium" x-text="patchSet.name"></h3>
                                        <span class="badge badge-secondary text-xs" x-text="`${patchSet.run_count} runs`"></span>
                                    </div>
                                    <p class="text-sm text-muted-foreground line-clamp-2 mb-2"
                                       x-text="patchSet.description || 'No description'"></p>
                                    <div class="flex items-center justify-between text-xs text-muted-foreground">
                                        <span><span x-text="patchSet.patch_count"></span> patches, <span x-text="patchSet.override_count"></span> overrides</span>
                                        <span>Last run: <span x-text="formatTemplateDate(patchSet.last_run)"></span></span>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>

                <!-- Templates Summary Footer -->
                <div x-show="getTemplatesTotal() > 0"
                     class="px-4 py-2 border-t border-border bg-card flex items-center justify-between">
                    <div class="text-sm text-muted-foreground">
                        <span x-show="templatesView.activeSubTab === 'configs'">
                            Showing <span x-text="templatesView.configs.length"></span>
                            of <span x-text="templatesView.configsTotal"></span> configs
                        </span>
                        <span x-show="templatesView.activeSubTab === 'loops'">
                            Showing <span x-text="templatesView.loops.length"></span>
                            of <span x-text="templatesView.loopsTotal"></span> loops
                        </span>
                        <span x-show="templatesView.activeSubTab === 'patch-sets'">
                            Showing <span x-text="templatesView.patchSets.length"></span>
                            of <span x-text="templatesView.patchSetsTotal"></span> patch-sets
                        </span>
                    </div>
                </div>
            </div>

            <!-- Template Details Modal (Story 19.5) -->
            <div x-show="templatesView.selectedTemplate"
                 x-transition:enter="transition ease-out duration-200"
                 x-transition:enter-start="opacity-0"
                 x-transition:enter-end="opacity-100"
                 x-transition:leave="transition ease-in duration-150"
                 x-transition:leave-start="opacity-100"
                 x-transition:leave-end="opacity-0"
                 @keydown.escape.window="if (templatesView.selectedTemplate && !contextMenu.show) closeTemplateDetails()"
                 class="absolute inset-0 bg-background/80 z-40 flex items-center justify-center p-4"
                 data-testid="template-details-modal">
                <div class="bg-card border border-border rounded-lg shadow-lg w-full max-w-3xl max-h-[80vh] overflow-hidden flex flex-col"
                     @click.stop>
                    <!-- Modal Header -->
                    <header class="flex items-center justify-between p-4 border-b border-border">
                        <div class="flex items-center gap-3">
                            <i :data-lucide="templatesView.selectedTemplate?.type === 'config' ? 'settings' : (templatesView.selectedTemplate?.type === 'loop' ? 'repeat' : 'file-diff')"
                               class="w-5 h-5 text-primary"></i>
                            <h2 class="text-lg font-semibold" x-text="templatesView.selectedTemplate?.name"></h2>
                            <span class="badge badge-secondary text-xs capitalize" x-text="templatesView.selectedTemplate?.type"></span>
                        </div>
                        <button @click="closeTemplateDetails()" class="btn-ghost p-1" data-testid="close-template-details">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                    </header>

                    <!-- Modal Content -->
                    <div class="flex-1 overflow-auto p-4 space-y-4">
                        <!-- Description -->
                        <div x-show="templatesView.selectedTemplate?.description">
                            <div class="text-sm text-muted-foreground mb-1">Description</div>
                            <p x-text="templatesView.selectedTemplate?.description"></p>
                        </div>

                        <!-- Config-specific: Providers -->
                        <div x-show="templatesView.selectedTemplate?.type === 'config' && templatesView.selectedTemplate?.providers">
                            <div class="text-sm text-muted-foreground mb-1">Providers</div>
                            <div class="bg-muted rounded p-3 text-sm">
                                <div x-show="templatesView.selectedTemplate?.providers?.master">
                                    <strong>Master:</strong>
                                    <span x-text="templatesView.selectedTemplate?.providers?.master?.provider || 'N/A'"></span>
                                    (<span x-text="templatesView.selectedTemplate?.providers?.master?.model || 'N/A'"></span>)
                                </div>
                                <div x-show="templatesView.selectedTemplate?.providers?.multi?.length > 0">
                                    <strong>Multi:</strong>
                                    <span x-text="templatesView.selectedTemplate?.providers?.multi?.length || 0"></span> validator(s)
                                </div>
                            </div>
                        </div>

                        <!-- Loop-specific: Sequence -->
                        <div x-show="templatesView.selectedTemplate?.type === 'loop' && templatesView.selectedTemplate?.sequence">
                            <div class="text-sm text-muted-foreground mb-1">
                                Sequence (<span x-text="templatesView.selectedTemplate?.step_count || 0"></span> steps)
                            </div>
                            <div class="bg-muted rounded p-3 space-y-1">
                                <template x-for="(step, idx) in templatesView.selectedTemplate?.sequence || []" :key="idx">
                                    <div class="flex items-center gap-2 text-sm">
                                        <span class="text-muted-foreground" x-text="`${idx + 1}.`"></span>
                                        <span class="font-mono" x-text="step.workflow"></span>
                                        <span x-show="step.required" class="badge badge-success text-xs">required</span>
                                        <span x-show="!step.required" class="badge badge-secondary text-xs">optional</span>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <!-- Patch-Set-specific: Patches & Overrides -->
                        <div x-show="templatesView.selectedTemplate?.type === 'patch-set'">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <div class="text-sm text-muted-foreground mb-1">
                                        Patches (<span x-text="templatesView.selectedTemplate?.patch_count || 0"></span>)
                                    </div>
                                    <div class="bg-muted rounded p-3 text-sm font-mono">
                                        <template x-for="(value, key) in templatesView.selectedTemplate?.patches || {}" :key="key">
                                            <div x-show="value" class="truncate" :title="value">
                                                <span class="text-muted-foreground" x-text="key"></span>:
                                                <span x-text="value || 'none'"></span>
                                            </div>
                                        </template>
                                        <div x-show="templatesView.selectedTemplate?.patch_count === 0" class="text-muted-foreground">
                                            No patches configured
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <div class="text-sm text-muted-foreground mb-1">
                                        Overrides (<span x-text="templatesView.selectedTemplate?.override_count || 0"></span>)
                                    </div>
                                    <div class="bg-muted rounded p-3 text-sm font-mono">
                                        <template x-for="(value, key) in templatesView.selectedTemplate?.workflow_overrides || {}" :key="key">
                                            <div class="truncate" :title="value">
                                                <span class="text-muted-foreground" x-text="key"></span>:
                                                <span x-text="value"></span>
                                            </div>
                                        </template>
                                        <div x-show="templatesView.selectedTemplate?.override_count === 0" class="text-muted-foreground">
                                            No overrides configured
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- YAML Content -->
                        <div x-show="templatesView.selectedTemplate?.yaml_content">
                            <div class="text-sm text-muted-foreground mb-1">Configuration (YAML)</div>
                            <pre class="bg-muted p-4 rounded overflow-auto max-h-64 text-sm font-mono"><code x-text="templatesView.selectedTemplate?.yaml_content || 'Content not available'"></code></pre>
                        </div>

                        <!-- Run Statistics -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <div class="text-sm text-muted-foreground">Run Count</div>
                                <div class="font-semibold" x-text="templatesView.selectedTemplate?.run_count || 0"></div>
                            </div>
                            <div>
                                <div class="text-sm text-muted-foreground">Last Run</div>
                                <div class="font-semibold" x-text="formatTemplateDate(templatesView.selectedTemplate?.last_run)"></div>
                            </div>
                        </div>

                        <!-- Recent Runs -->
                        <div x-show="templatesView.selectedTemplate?.recent_runs?.length > 0">
                            <div class="text-sm text-muted-foreground mb-2">Recent Runs</div>
                            <div class="space-y-2">
                                <template x-for="run in templatesView.selectedTemplate?.recent_runs || []" :key="run.run_id">
                                    <div class="flex items-center justify-between p-2 bg-muted rounded">
                                        <div class="flex items-center gap-2">
                                            <span :class="{
                                                'badge-success': run.status === 'completed',
                                                'badge-warning': run.status === 'running',
                                                'badge-destructive': run.status === 'failed' || run.status === 'cancelled'
                                            }" class="badge text-xs" x-text="run.status"></span>
                                            <span class="font-mono text-sm cursor-pointer hover:text-primary"
                                                  @click="closeTemplateDetails(); openExperimentDetails(run.run_id)"
                                                  x-text="run.run_id"></span>
                                        </div>
                                        <div class="flex items-center gap-3 text-muted-foreground text-xs">
                                            <span x-text="run.fixture || run.config"></span>
                                            <span x-text="formatTemplateDate(run.started)"></span>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>

                    <!-- Modal Footer -->
                    <footer class="flex items-center justify-end gap-2 p-4 border-t border-border">
                        <button @click="closeTemplateDetails()" class="btn-outline">
                            Close
                        </button>
                    </footer>
                </div>
            </div>

            <!-- Fixture Details Modal (Story 19.3) -->
            <div x-show="fixturesView.selectedFixture"
                 x-transition:enter="transition ease-out duration-200"
                 x-transition:enter-start="opacity-0"
                 x-transition:enter-end="opacity-100"
                 x-transition:leave="transition ease-in duration-150"
                 x-transition:leave-start="opacity-100"
                 x-transition:leave-end="opacity-0"
                 @keydown.escape.window="if (fixturesView.selectedFixture && !contextMenu.show) closeFixtureDetails()"
                 class="absolute inset-0 bg-background/80 z-40 flex items-center justify-center p-4"
                 data-testid="fixture-details-modal">
                <div class="bg-card border border-border rounded-lg shadow-lg w-full max-w-2xl max-h-[80vh] overflow-hidden flex flex-col"
                     @click.stop>
                    <!-- Modal Header -->
                    <header class="flex items-center justify-between p-4 border-b border-border">
                        <div class="flex items-center gap-3">
                            <i data-lucide="package" class="w-5 h-5 text-primary"></i>
                            <h2 class="text-lg font-semibold" x-text="fixturesView.selectedFixture?.name"></h2>
                        </div>
                        <button @click="closeFixtureDetails()" class="btn-ghost p-1" data-testid="close-fixture-details">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                    </header>

                    <!-- Modal Content -->
                    <div class="flex-1 overflow-auto p-4 space-y-4">
                        <!-- Basic Info -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <div class="text-sm text-muted-foreground">ID</div>
                                <div class="font-mono text-sm" x-text="fixturesView.selectedFixture?.id"></div>
                            </div>
                            <div>
                                <div class="text-sm text-muted-foreground">Difficulty</div>
                                <span class="badge"
                                      :class="getDifficultyClass(fixturesView.selectedFixture?.difficulty)"
                                      x-text="fixturesView.selectedFixture?.difficulty"></span>
                            </div>
                            <div>
                                <div class="text-sm text-muted-foreground">Estimated Cost</div>
                                <div class="font-mono text-sm" x-text="fixturesView.selectedFixture?.estimated_cost"></div>
                            </div>
                            <div>
                                <div class="text-sm text-muted-foreground">Run Count</div>
                                <div class="font-mono text-sm" x-text="fixturesView.selectedFixture?.run_count"></div>
                            </div>
                        </div>

                        <!-- Description -->
                        <div x-show="fixturesView.selectedFixture?.description">
                            <div class="text-sm text-muted-foreground mb-1">Description</div>
                            <p class="text-sm" x-text="fixturesView.selectedFixture?.description"></p>
                        </div>

                        <!-- Path -->
                        <div>
                            <div class="text-sm text-muted-foreground mb-1">Path</div>
                            <code class="text-xs bg-muted px-2 py-1 rounded block overflow-x-auto"
                                  x-text="fixturesView.selectedFixture?.resolved_path || fixturesView.selectedFixture?.path"></code>
                        </div>

                        <!-- Tags -->
                        <div x-show="fixturesView.selectedFixture?.tags?.length > 0">
                            <div class="text-sm text-muted-foreground mb-1">Tags</div>
                            <div class="flex flex-wrap gap-1">
                                <template x-for="tag in fixturesView.selectedFixture?.tags || []" :key="tag">
                                    <span class="badge badge-secondary text-xs" x-text="tag"></span>
                                </template>
                            </div>
                        </div>

                        <!-- Recent Runs -->
                        <div x-show="fixturesView.selectedFixture?.recent_runs?.length > 0">
                            <div class="text-sm text-muted-foreground mb-2">Recent Runs</div>
                            <div class="space-y-2">
                                <template x-for="run in fixturesView.selectedFixture?.recent_runs || []" :key="run.run_id">
                                    <div class="flex items-center justify-between p-2 bg-muted/50 rounded text-sm">
                                        <div class="flex items-center gap-2">
                                            <span class="badge text-xs"
                                                  :class="getExperimentStatusClass(run.status)"
                                                  x-text="run.status"></span>
                                            <span class="font-mono text-xs" x-text="run.run_id"></span>
                                        </div>
                                        <div class="flex items-center gap-3 text-muted-foreground text-xs">
                                            <span x-text="run.config"></span>
                                            <span x-text="formatFixtureDate(run.started)"></span>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>

                    <!-- Modal Footer -->
                    <footer class="flex items-center justify-end gap-2 p-4 border-t border-border">
                        <button @click="closeFixtureDetails()" class="btn-outline">
                            Close
                        </button>
                    </footer>
                </div>
            </div>
            <!-- End of Fixture Details Modal -->

            </div>
            <!-- End of Experiments Panel (opened in 06-experiments-panel.html) -->

            <!-- Experiment Details Panel (Story 19.2) -->
            <div x-show="experimentDetails.open"
                 x-transition:enter="transition ease-out duration-200"
                 x-transition:enter-start="opacity-0"
                 x-transition:enter-end="opacity-100"
                 x-transition:leave="transition ease-in duration-150"
                 x-transition:leave-start="opacity-100"
                 x-transition:leave-end="opacity-0"
                 @keydown.escape.window="if (experimentDetails.open && !contextMenu.show) closeExperimentDetails()"
                 class="absolute inset-0 bg-card z-30 flex flex-col overflow-hidden"
                 data-testid="experiment-details-panel">
                <!-- Header -->
                <header class="flex items-center justify-between p-4 border-b border-border bg-card">
                    <div class="flex items-center gap-3">
                        <button @click="closeExperimentDetails()" class="btn-ghost p-1" title="Back to list">
                            <i data-lucide="arrow-left" class="w-5 h-5"></i>
                        </button>
                        <h2 class="text-xl font-semibold">Run Details</h2>
                        <span class="font-mono text-sm text-muted-foreground" x-text="experimentDetails.runId"></span>
                    </div>
                    <div class="flex items-center gap-2">
                        <button class="btn-outline text-sm"
                                @click="closeExperimentDetails(); fetchComparison([experimentDetails.runId])"
                                title="Compare this run with others"
                                data-testid="compare-run-btn">
                            <i data-lucide="diff" class="w-4 h-4 mr-1"></i>
                            Compare
                        </button>
                        <button class="btn-ghost p-2"
                                @click="refreshExperimentDetails()"
                                :disabled="experimentDetails.loading"
                                title="Refresh"
                                data-testid="refresh-details">
                            <i data-lucide="refresh-cw" class="w-4 h-4" :class="{'animate-spin': experimentDetails.loading}"></i>
                        </button>
                        <button @click="closeExperimentDetails()" class="btn-ghost p-2" data-testid="close-details">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                    </div>
                </header>

                <!-- Content -->
                <div class="flex-1 overflow-auto p-4">
                    <!-- Loading State -->
                    <div x-show="experimentDetails.loading" class="flex items-center justify-center h-32">
                        <i data-lucide="loader-2" class="w-8 h-8 animate-spin text-muted-foreground"></i>
                    </div>

                    <!-- Error State -->
                    <div x-show="experimentDetails.error && !experimentDetails.loading"
                         class="bg-destructive/10 text-destructive p-4 rounded-lg">
                        <span x-text="experimentDetails.error"></span>
                    </div>

                    <!-- Details Content -->
                    <template x-if="experimentDetails.data && !experimentDetails.loading">
                        <div class="space-y-6">
                            <!-- Status & Timing Card -->
                            <div class="bg-card border border-border rounded-lg p-4">
                                <h3 class="text-lg font-semibold mb-3">Overview</h3>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                    <div>
                                        <div class="text-sm text-muted-foreground">Status</div>
                                        <span class="badge" :class="getExperimentStatusClass(experimentDetails.data.status)"
                                              x-text="experimentDetails.data.status"></span>
                                    </div>
                                    <div>
                                        <div class="text-sm text-muted-foreground">Duration</div>
                                        <div class="font-mono" x-text="experimentDetails.data.duration_formatted || '-'"></div>
                                    </div>
                                    <div>
                                        <div class="text-sm text-muted-foreground">Started</div>
                                        <div class="text-sm" x-text="formatDateTime(experimentDetails.data.started)"></div>
                                    </div>
                                    <div>
                                        <div class="text-sm text-muted-foreground">Completed</div>
                                        <div class="text-sm" x-text="experimentDetails.data.completed ? formatDateTime(experimentDetails.data.completed) : '-'"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Input Configuration Card -->
                            <div class="bg-card border border-border rounded-lg p-4">
                                <h3 class="text-lg font-semibold mb-3">Input Configuration</h3>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                    <div>
                                        <div class="text-sm text-muted-foreground">Fixture</div>
                                        <div class="font-mono text-sm" x-text="experimentDetails.data.input.fixture"></div>
                                    </div>
                                    <div>
                                        <div class="text-sm text-muted-foreground">Config</div>
                                        <div class="font-mono text-sm" x-text="experimentDetails.data.input.config"></div>
                                    </div>
                                    <div>
                                        <div class="text-sm text-muted-foreground">Patch Set</div>
                                        <div class="font-mono text-sm" x-text="experimentDetails.data.input.patch_set || 'baseline'"></div>
                                    </div>
                                    <div>
                                        <div class="text-sm text-muted-foreground">Loop</div>
                                        <div class="font-mono text-sm" x-text="experimentDetails.data.input.loop || 'standard'"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Results Card (if available) -->
                            <template x-if="experimentDetails.data.results">
                                <div class="bg-card border border-border rounded-lg p-4">
                                    <h3 class="text-lg font-semibold mb-3">Results</h3>
                                    <div class="grid grid-cols-3 md:grid-cols-5 gap-4">
                                        <div>
                                            <div class="text-sm text-muted-foreground">Stories Attempted</div>
                                            <div class="text-2xl font-bold" x-text="experimentDetails.data.results.stories_attempted"></div>
                                        </div>
                                        <div>
                                            <div class="text-sm text-muted-foreground">Completed</div>
                                            <div class="text-2xl font-bold text-accent" x-text="experimentDetails.data.results.stories_completed"></div>
                                        </div>
                                        <div>
                                            <div class="text-sm text-muted-foreground">Failed</div>
                                            <div class="text-2xl font-bold" :class="experimentDetails.data.results.stories_failed > 0 ? 'text-destructive' : 'text-muted-foreground'"
                                                 x-text="experimentDetails.data.results.stories_failed"></div>
                                        </div>
                                        <template x-if="experimentDetails.data.results.validation_passed !== undefined">
                                            <div>
                                                <div class="text-sm text-muted-foreground">Validation Passed</div>
                                                <div class="text-2xl font-bold text-accent" x-text="experimentDetails.data.results.validation_passed"></div>
                                            </div>
                                        </template>
                                        <template x-if="experimentDetails.data.results.code_review_passed !== undefined">
                                            <div>
                                                <div class="text-sm text-muted-foreground">Code Review Passed</div>
                                                <div class="text-2xl font-bold text-accent" x-text="experimentDetails.data.results.code_review_passed"></div>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </template>

                            <!-- Metrics Card (if available) -->
                            <template x-if="experimentDetails.data.metrics">
                                <div class="bg-card border border-border rounded-lg p-4">
                                    <h3 class="text-lg font-semibold mb-3">Metrics</h3>
                                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                        <template x-if="experimentDetails.data.metrics.total_tokens !== undefined">
                                            <div>
                                                <div class="text-sm text-muted-foreground">Total Tokens</div>
                                                <div class="font-mono" x-text="experimentDetails.data.metrics.total_tokens?.toLocaleString() || '-'"></div>
                                            </div>
                                        </template>
                                        <template x-if="experimentDetails.data.metrics.total_cost !== undefined">
                                            <div>
                                                <div class="text-sm text-muted-foreground">Total Cost</div>
                                                <div class="font-mono" x-text="experimentDetails.data.metrics.total_cost !== null ? '$' + experimentDetails.data.metrics.total_cost.toFixed(4) : '-'"></div>
                                            </div>
                                        </template>
                                        <template x-if="experimentDetails.data.metrics.avg_phase_duration !== undefined">
                                            <div>
                                                <div class="text-sm text-muted-foreground">Avg Phase Duration</div>
                                                <div class="font-mono" x-text="formatDuration(experimentDetails.data.metrics.avg_phase_duration)"></div>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </template>

                            <!-- Phases Table -->
                            <div class="bg-card border border-border rounded-lg p-4">
                                <h3 class="text-lg font-semibold mb-3">Phases</h3>
                                <template x-if="experimentDetails.data.phases && experimentDetails.data.phases.length > 0">
                                    <div class="overflow-x-auto">
                                        <table class="w-full text-sm">
                                            <thead>
                                                <tr class="border-b border-border">
                                                    <th class="px-3 py-2 text-left">Phase</th>
                                                    <th class="px-3 py-2 text-left">Story</th>
                                                    <th class="px-3 py-2 text-left">Status</th>
                                                    <th class="px-3 py-2 text-left">Duration</th>
                                                    <th class="px-3 py-2 text-left">Tokens</th>
                                                    <th class="px-3 py-2 text-left">Cost</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <template x-for="phase in experimentDetails.data.phases" :key="phase.phase + (phase.story || '')">
                                                    <tr class="border-b border-border hover:bg-muted/30">
                                                        <td class="px-3 py-2 font-mono" x-text="phase.phase"></td>
                                                        <td class="px-3 py-2" x-text="phase.story || '-'"></td>
                                                        <td class="px-3 py-2">
                                                            <span class="badge" :class="getPhaseStatusClass(phase.status)" x-text="phase.status"></span>
                                                        </td>
                                                        <td class="px-3 py-2 font-mono" x-text="phase.duration_formatted"></td>
                                                        <td class="px-3 py-2 font-mono" x-text="phase.tokens?.toLocaleString() || '-'"></td>
                                                        <td class="px-3 py-2 font-mono" x-text="phase.cost !== null && phase.cost !== undefined ? '$' + phase.cost.toFixed(4) : '-'"></td>
                                                    </tr>
                                                </template>
                                            </tbody>
                                        </table>
                                    </div>
                                </template>
                                <template x-if="!experimentDetails.data.phases || experimentDetails.data.phases.length === 0">
                                    <div class="text-muted-foreground text-center py-4">No phase data available</div>
                                </template>
                            </div>

                            <!-- Resolved Configuration (Collapsible) -->
                            <details class="bg-card border border-border rounded-lg">
                                <summary class="p-4 cursor-pointer hover:bg-muted/30 font-semibold">
                                    Resolved Configuration
                                </summary>
                                <div class="p-4 pt-0 space-y-4">
                                    <template x-if="experimentDetails.data.resolved">
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div>
                                                <h4 class="text-sm font-semibold text-muted-foreground mb-2">Fixture</h4>
                                                <pre class="text-xs bg-muted p-2 rounded overflow-x-auto" x-text="JSON.stringify(experimentDetails.data.resolved.fixture, null, 2)"></pre>
                                            </div>
                                            <div>
                                                <h4 class="text-sm font-semibold text-muted-foreground mb-2">Config</h4>
                                                <pre class="text-xs bg-muted p-2 rounded overflow-x-auto" x-text="JSON.stringify(experimentDetails.data.resolved.config, null, 2)"></pre>
                                            </div>
                                            <div>
                                                <h4 class="text-sm font-semibold text-muted-foreground mb-2">Patch Set</h4>
                                                <pre class="text-xs bg-muted p-2 rounded overflow-x-auto" x-text="JSON.stringify(experimentDetails.data.resolved.patch_set, null, 2)"></pre>
                                            </div>
                                            <div>
                                                <h4 class="text-sm font-semibold text-muted-foreground mb-2">Loop</h4>
                                                <pre class="text-xs bg-muted p-2 rounded overflow-x-auto" x-text="JSON.stringify(experimentDetails.data.resolved.loop, null, 2)"></pre>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </details>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Comparison View Modal (Story 19.4) -->
            <div x-show="comparisonView.open"
                 x-transition:enter="transition ease-out duration-200"
                 x-transition:enter-start="opacity-0"
                 x-transition:enter-end="opacity-100"
                 x-transition:leave="transition ease-in duration-150"
                 x-transition:leave-start="opacity-100"
                 x-transition:leave-end="opacity-0"
                 @keydown.escape.window="if (comparisonView.open && !contextMenu.show) closeComparison()"
                 class="absolute inset-0 bg-card z-30 flex flex-col overflow-hidden"
                 data-testid="comparison-view-modal">
                <!-- Header -->
                <header class="flex items-center justify-between p-4 border-b border-border bg-card">
                    <div class="flex items-center gap-3">
                        <button @click="closeComparison()" class="btn-ghost p-1" title="Back to list">
                            <i data-lucide="arrow-left" class="w-5 h-5"></i>
                        </button>
                        <h2 class="text-xl font-semibold">Run Comparison</h2>
                        <span class="text-sm text-muted-foreground"
                              x-text="`Comparing ${comparisonView.runIds.length} runs`"></span>
                    </div>
                    <div class="flex items-center gap-2">
                        <!-- Export button -->
                        <button class="btn-outline"
                                @click="exportComparison()"
                                :disabled="comparisonView.exporting || !comparisonView.report"
                                data-testid="export-comparison">
                            <i data-lucide="download" class="w-4 h-4" :class="{'animate-spin': comparisonView.exporting}"></i>
                            Export MD
                        </button>
                        <button @click="closeComparison()" class="btn-ghost p-2" data-testid="close-comparison">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                    </div>
                </header>

                <!-- Content -->
                <div class="flex-1 overflow-auto p-4">
                    <!-- Loading State -->
                    <div x-show="comparisonView.loading" class="flex items-center justify-center h-32">
                        <i data-lucide="loader-2" class="w-8 h-8 animate-spin text-muted-foreground"></i>
                    </div>

                    <!-- Error State -->
                    <div x-show="comparisonView.error && !comparisonView.loading"
                         class="bg-destructive/10 text-destructive p-4 rounded-lg flex items-center gap-2">
                        <i data-lucide="alert-circle" class="w-5 h-5"></i>
                        <span x-text="comparisonView.error"></span>
                    </div>

                    <!-- Comparison Content -->
                    <template x-if="comparisonView.report && !comparisonView.loading">
                        <div class="space-y-6">
                            <!-- Summary -->
                            <div class="bg-card border border-border rounded-lg p-4">
                                <h3 class="text-lg font-semibold mb-3">Summary</h3>
                                <p class="text-muted-foreground" x-text="comparisonView.report.summary"></p>
                            </div>

                            <!-- Configuration Diff Table (AC4) -->
                            <div class="bg-card border border-border rounded-lg p-4">
                                <h3 class="text-lg font-semibold mb-3">Configuration Differences</h3>
                                <template x-if="comparisonView.report.config_diff">
                                    <div class="overflow-x-auto">
                                        <table class="w-full text-sm">
                                            <thead>
                                                <tr class="border-b border-border">
                                                    <th class="px-3 py-2 text-left sticky left-0 bg-card z-10">Axis</th>
                                                    <template x-for="runId in comparisonView.report.run_ids" :key="runId">
                                                        <th class="px-3 py-2 text-left font-mono text-xs" x-text="runId"></th>
                                                    </template>
                                                    <th class="px-3 py-2 text-left">Same?</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <template x-for="axis in ['fixture', 'config', 'patch_set', 'loop']" :key="axis">
                                                    <tr class="border-b border-border hover:bg-muted/30">
                                                        <td class="px-3 py-2 font-medium sticky left-0 bg-card z-10" x-text="getAxisDisplayName(axis)"></td>
                                                        <template x-for="runId in comparisonView.report.run_ids" :key="runId">
                                                            <td class="px-3 py-2 font-mono text-xs"
                                                                :class="{'font-bold text-accent': !comparisonView.report.config_diff[axis]?.is_same}"
                                                                x-text="comparisonView.report.config_diff[axis]?.values[runId] || '-'"></td>
                                                        </template>
                                                        <td class="px-3 py-2">
                                                            <span x-show="comparisonView.report.config_diff[axis]?.is_same" class="text-green-600"></span>
                                                            <span x-show="!comparisonView.report.config_diff[axis]?.is_same" class="font-bold text-amber-600">DIFFERENT</span>
                                                        </td>
                                                    </tr>
                                                </template>
                                            </tbody>
                                        </table>
                                    </div>
                                </template>
                                <template x-if="!comparisonView.report.config_diff">
                                    <p class="text-muted-foreground text-center py-4">All configurations are identical</p>
                                </template>
                            </div>

                            <!-- Results Comparison Table (AC5) -->
                            <div class="bg-card border border-border rounded-lg p-4">
                                <h3 class="text-lg font-semibold mb-3">Results Comparison</h3>
                                <template x-if="comparisonView.report.runs && comparisonView.report.runs.length > 0">
                                    <div class="overflow-x-auto">
                                        <table class="w-full text-sm">
                                            <thead>
                                                <tr class="border-b border-border">
                                                    <th class="px-3 py-2 text-left">Run ID</th>
                                                    <th class="px-3 py-2 text-left">Status</th>
                                                    <th class="px-3 py-2 text-right">Duration</th>
                                                    <th class="px-3 py-2 text-right">Stories</th>
                                                    <th class="px-3 py-2 text-right">Completed</th>
                                                    <th class="px-3 py-2 text-right">Failed</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <template x-for="run in comparisonView.report.runs" :key="run.run_id">
                                                    <tr class="border-b border-border hover:bg-muted/30">
                                                        <td class="px-3 py-2 font-mono text-xs" x-text="run.run_id"></td>
                                                        <td class="px-3 py-2">
                                                            <span class="badge" :class="getExperimentStatusClass(run.status)" x-text="run.status"></span>
                                                        </td>
                                                        <td class="px-3 py-2 text-right font-mono" x-text="run.duration_formatted || '-'"></td>
                                                        <td class="px-3 py-2 text-right" x-text="run.stories_attempted || '-'"></td>
                                                        <td class="px-3 py-2 text-right text-accent" x-text="run.stories_completed || '-'"></td>
                                                        <td class="px-3 py-2 text-right" :class="run.stories_failed > 0 ? 'text-destructive' : ''"
                                                            x-text="run.stories_failed ?? '-'"></td>
                                                    </tr>
                                                </template>
                                            </tbody>
                                        </table>
                                    </div>
                                </template>
                            </div>

                            <!-- Metrics Comparison Table (AC5) -->
                            <div class="bg-card border border-border rounded-lg p-4">
                                <h3 class="text-lg font-semibold mb-3">Metrics Comparison</h3>
                                <template x-if="comparisonView.report.metrics && comparisonView.report.metrics.length > 0">
                                    <div class="overflow-x-auto">
                                        <table class="w-full text-sm">
                                            <thead>
                                                <tr class="border-b border-border">
                                                    <th class="px-3 py-2 text-left sticky left-0 bg-card z-10">Metric</th>
                                                    <template x-for="runId in comparisonView.report.run_ids" :key="runId">
                                                        <th class="px-3 py-2 text-right font-mono text-xs" x-text="runId"></th>
                                                    </template>
                                                    <th class="px-3 py-2 text-right">Delta</th>
                                                    <th class="px-3 py-2 text-center">Winner</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <template x-for="metric in comparisonView.report.metrics" :key="metric.metric_name">
                                                    <tr class="border-b border-border hover:bg-muted/30">
                                                        <td class="px-3 py-2 font-medium sticky left-0 bg-card z-10" x-text="getMetricDisplayName(metric.metric_name)"></td>
                                                        <template x-for="runId in comparisonView.report.run_ids" :key="runId">
                                                            <td class="px-3 py-2 text-right font-mono" x-text="formatMetricValue(metric.metric_name, metric.values[runId])"></td>
                                                        </template>
                                                        <td class="px-3 py-2 text-right font-mono"
                                                            :class="getDeltaClass(metric)"
                                                            x-text="formatDelta(metric.deltas[comparisonView.report.run_ids[1]])"></td>
                                                        <td class="px-3 py-2 text-center">
                                                            <span x-show="metric.winner" x-text="' ' + metric.winner" class="text-xs font-mono"></span>
                                                            <span x-show="!metric.winner && Object.values(metric.values).some(v => v !== null)" class="text-muted-foreground">TIE</span>
                                                            <span x-show="!metric.winner && Object.values(metric.values).every(v => v === null)" class="text-muted-foreground">N/A</span>
                                                        </td>
                                                    </tr>
                                                </template>
                                            </tbody>
                                        </table>
                                    </div>
                                </template>
                                <template x-if="!comparisonView.report.metrics || comparisonView.report.metrics.length === 0">
                                    <p class="text-muted-foreground text-center py-4">No metrics data available</p>
                                </template>
                            </div>

                            <!-- Cost Visualization Bar Chart (AC6) -->
                            <div class="bg-card border border-border rounded-lg p-4">
                                <h3 class="text-lg font-semibold mb-3">Cost Comparison</h3>
                                <template x-if="!hasNoCostData()">
                                    <div class="space-y-3">
                                        <template x-for="runId in comparisonView.report.run_ids" :key="runId">
                                            <div class="flex items-center gap-3">
                                                <span class="font-mono text-xs w-40 truncate" x-text="runId"></span>
                                                <div class="flex-1 bg-muted rounded h-6 overflow-hidden">
                                                    <div class="bg-primary h-full transition-all duration-300"
                                                         :style="`width: ${getCostBarWidth(runId)}%`"></div>
                                                </div>
                                                <span class="font-mono text-sm w-20 text-right" x-text="formatCost(getCostValue(runId))"></span>
                                            </div>
                                        </template>
                                    </div>
                                </template>
                                <template x-if="hasNoCostData()">
                                    <p class="text-muted-foreground text-center py-4">No cost data available for comparison</p>
                                </template>
                            </div>

                            <!-- Conclusion (AC7) -->
                            <template x-if="comparisonView.report.conclusion">
                                <div class="bg-card border border-border rounded-lg p-4">
                                    <h3 class="text-lg font-semibold mb-3">Conclusion</h3>
                                    <p class="text-muted-foreground" x-text="comparisonView.report.conclusion"></p>
                                </div>
                            </template>
                        </div>
                    </template>
                </div>
            </div>

        </main>
    </div>

    <!-- Context Menu - Basecoat dropdown-menu -->
    <div class="dropdown-menu" x-show="contextMenu.show">
        <div data-popover
             x-ref="contextMenuEl"
             data-testid="context-menu"
             role="menu"
             tabindex="-1"
             aria-hidden="false"
             @click.away="contextMenu.show = false"
             @keydown.escape.window="contextMenu.show = false"
             class="fixed min-w-48 z-50"
             :class="contextMenu.ready ? 'opacity-100' : 'opacity-0'"
             :style="`left: ${contextMenu.x}px; top: ${contextMenu.y}px`">
            <template x-for="(action, index) in contextMenu.actions" :key="action.label">
                <div>
                    <hr x-show="action.danger && index > 0 && !contextMenu.actions[index-1]?.danger"
                        role="separator"
                        data-testid="context-menu-separator">
                    <div role="menuitem"
                         :data-testid="action.testId"
                         :class="{
                             'bg-accent text-accent-foreground': action.primary,
                             'text-destructive': action.danger && !action.primary
                         }"
                         @click="executeAction(action)">
                        <i :data-lucide="getActionIcon(action.icon)" class="w-4 h-4"></i>
                        <span x-text="action.label"></span>
                    </div>
                </div>
            </template>
        </div>
    </div>

    <!-- Toast Notification - Sonner style, top center -->
    <div x-show="toast.visible"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0 -translate-y-4"
         x-transition:enter-end="opacity-100 translate-y-0"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100 translate-y-0"
         x-transition:leave-end="opacity-0 -translate-y-4"
         class="fixed top-4 left-1/2 -translate-x-1/2 z-50 bg-popover border border-border px-4 py-3 rounded-lg shadow-2xl flex items-center gap-3 min-w-72"
         style="background-color: hsl(222 47% 16%);">
        <i data-lucide="check-circle" class="w-5 h-5 text-accent flex-shrink-0"></i>
        <span x-text="toast.message" class="text-sm"></span>
    </div>

    <!-- Busy State Modal -->
    <div x-show="busyModal.show"
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-150"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         @keydown.escape.window="if (busyModal.show && !contextMenu.show) busyModal.show = false"
         @keydown.tab="if (busyModal.show) trapFocus($event)"
         data-testid="busy-modal"
         aria-modal="true"
         role="dialog"
         aria-labelledby="busy-modal-title"
         class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <div x-show="busyModal.show"
             x-transition:enter="transition ease-out duration-200"
             x-transition:enter-start="opacity-0 scale-95"
             x-transition:enter-end="opacity-100 scale-100"
             x-transition:leave="transition ease-in duration-150"
             x-transition:leave-start="opacity-100 scale-100"
             x-transition:leave-end="opacity-0 scale-95"
             x-ref="busyModalContent"
             class="card p-6 max-w-md w-full mx-4">
            <h3 id="busy-modal-title" class="text-lg font-semibold mb-4 flex items-center gap-2">
                <i data-lucide="alert-triangle" class="w-5 h-5 text-bp-warning"></i>
                bmad-assist is currently busy
            </h3>

            <p class="text-muted-foreground mb-4">
                Current: <span x-text="queue.current?.workflow" class="text-foreground"></span>
                <span x-text="`${queue.current?.epic_num}.${queue.current?.story_num}`" class="text-foreground tabular-nums"></span>
                (<span x-text="formatElapsedTime(queue.current?.phase_started_at)" class="tabular-nums"></span>)
            </p>

            <p class="mb-4">What should happen with your new task?</p>

            <div class="space-y-3 mb-6">
                <label class="flex items-start gap-3 p-3 rounded border border-border hover:border-primary cursor-pointer"
                       :class="busyModal.priority === 'interrupt' ? 'border-primary bg-primary/10' : ''">
                    <input type="radio" name="priority" value="interrupt" x-model="busyModal.priority"
                           x-ref="priorityInterrupt"
                           data-testid="priority-interrupt"
                           class="input mt-1">
                    <div>
                        <div class="font-medium">Interrupt current and run NOW</div>
                        <div class="text-sm text-destructive flex items-center gap-1">
                            <i data-lucide="alert-triangle" class="w-3 h-3"></i> Current task will be killed!
                        </div>
                    </div>
                </label>

                <label class="flex items-start gap-3 p-3 rounded border border-border hover:border-primary cursor-pointer"
                       :class="busyModal.priority === 'next' ? 'border-primary bg-primary/10' : ''">
                    <input type="radio" name="priority" value="next" x-model="busyModal.priority"
                           data-testid="priority-next"
                           class="input mt-1">
                    <div>
                        <div class="font-medium">Run AFTER current task completes</div>
                        <div class="text-sm text-muted-foreground flex items-center gap-1">
                            <i data-lucide="clock" class="w-3 h-3"></i> Will start when current finishes
                        </div>
                    </div>
                </label>

                <label class="flex items-start gap-3 p-3 rounded border border-border hover:border-primary cursor-pointer"
                       :class="busyModal.priority === 'last' ? 'border-primary bg-primary/10' : ''">
                    <input type="radio" name="priority" value="last" x-model="busyModal.priority"
                           data-testid="priority-last"
                           class="input mt-1">
                    <div>
                        <div class="font-medium">Add to END of queue (default)</div>
                        <div class="text-sm text-muted-foreground flex items-center gap-1">
                            <i data-lucide="clock" class="w-3 h-3"></i>
                            <span x-text="`${queue.queue?.length || 0} tasks ahead`"></span>
                        </div>
                    </div>
                </label>
            </div>

            <!-- Queue Preview (AC: 5) -->
            <div x-show="(queue.queue || []).length > 0"
                 data-testid="queue-preview"
                 class="mb-4 p-3 bg-background rounded border border-border">
                <div class="text-sm text-muted-foreground mb-2">Queue:</div>
                <div class="flex flex-wrap gap-2">
                    <template x-for="task in (queue.queue || []).slice(0, 3)" :key="task.id">
                        <span class="badge-secondary"
                              data-testid="queue-preview-item">
                            [<span x-text="task.workflow"></span>
                            <span x-text="`${task.epic_num}.${task.story_num}`" class="tabular-nums"></span>]
                        </span>
                    </template>
                    <span x-show="(queue.queue || []).length > 3"
                          class="px-2 py-1 text-muted-foreground text-xs"
                          data-testid="queue-preview-overflow">
                        +<span x-text="(queue.queue || []).length - 3"></span> more
                    </span>
                </div>
            </div>

            <div class="flex justify-end gap-3">
                <button class="btn-outline"
                        data-testid="modal-cancel"
                        @click="busyModal.show = false">
                    Cancel
                </button>
                <button class="btn"
                        data-testid="modal-confirm"
                        x-ref="modalConfirm"
                        @click="confirmBusyAction">
                    Confirm
                </button>
            </div>
        </div>
    </div>

    <!-- Content Modal (Story 16.9 - AC 3, 4) -->
    <div x-show="contentModal.show"
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-150"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         @keydown.escape.window="if (contentModal.show && !busyModal.show) { contentModal.show = false; contentModal.browser = null; _cancelPendingShikiHighlights(); }"
         @keydown.tab="if (contentModal.show && !busyModal.show) trapFocus($event, 'contentModalContent')"
         class="fixed inset-0 z-50 flex items-center justify-center bg-black/50"
         data-testid="content-modal">

        <!-- Modal Content -->
        <div class="card shadow-xl p-0 gap-0 overflow-hidden w-4/5 max-h-[80vh] flex flex-col"
             x-show="contentModal.show"
             x-transition:enter="transition ease-out duration-200"
             x-transition:enter-start="opacity-0 scale-95"
             x-transition:enter-end="opacity-100 scale-100"
             x-transition:leave="transition ease-in duration-150"
             x-transition:leave-start="opacity-100 scale-100"
             x-transition:leave-end="opacity-0 scale-95"
             x-ref="contentModalContent"
             role="dialog"
             aria-modal="true"
             aria-labelledby="content-modal-title"
             @click.outside="contentModal.show = false; contentModal.browser = null; _cancelPendingShikiHighlights();">

            <!-- Header -->
            <div class="flex items-center justify-between px-4 py-2 border-b border-border">
                <h2 id="content-modal-title" x-text="contentModal.title" class="text-lg font-semibold"></h2>
                <div class="flex items-center gap-2">
                    <!-- Story 24.5: Raw/Rendered toggle (only shown when browser state is set) -->
                    <template x-if="contentModal.browser">
                        <div class="flex items-center border border-border rounded overflow-hidden mr-2"
                             data-testid="view-toggle">
                            <button @click="contentModal.browser.view = 'rendered'"
                                    class="px-3 py-1 text-xs"
                                    :class="contentModal.browser.view === 'rendered' ? 'bg-accent text-accent-foreground' : 'hover:bg-muted'"
                                    data-testid="view-rendered-btn">
                                Rendered
                            </button>
                            <button @click="contentModal.browser.view = 'raw'"
                                    class="px-3 py-1 text-xs"
                                    :class="contentModal.browser.view === 'raw' ? 'bg-accent text-accent-foreground' : 'hover:bg-muted'"
                                    data-testid="view-raw-btn">
                                Raw
                            </button>
                        </div>
                    </template>
                    <!-- Story 24.5: Copy button uses copyRawContent when browser state exists -->
                    <button @click="contentModal.browser ? window.contentBrowserComponent().copyRawContent(contentModal.content, showToast) : copyToClipboard(contentModal.content)"
                            class="btn-sm-icon-ghost"
                            data-testid="copy-content-btn"
                            :title="contentModal.browser ? 'Copies raw content' : 'Copy to clipboard'"
                            aria-label="Copy content to clipboard">
                        <i data-lucide="clipboard" class="w-4 h-4"></i>
                    </button>
                    <button @click="contentModal.show = false; contentModal.browser = null; _cancelPendingShikiHighlights();"
                            class="btn-sm-icon-ghost"
                            data-testid="close-modal-btn">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>

            <!-- Content - conditional rendering based on type (Story 23.3) and browser state (Story 24.5) -->
            <div class="flex-1 overflow-auto p-4">
                <!-- Story 24.5: Browser-controlled content (Raw/Rendered toggle) -->
                <template x-if="contentModal.type === 'markdown' && contentModal.browser">
                    <div>
                        <!-- Rendered mode -->
                        <template x-if="contentModal.browser.view === 'rendered'">
                            <div class="markdown-content text-sm"
                                 x-html="formatMarkdownContent(contentModal.content)"
                                 x-effect="$nextTick(() => { if (contentModal.show && contentModal.browser?.view === 'rendered') refreshIcons(); })">
                            </div>
                        </template>
                        <!-- Raw mode -->
                        <template x-if="contentModal.browser.view === 'raw'">
                            <pre class="text-sm whitespace-pre-wrap font-mono"><code x-text="contentModal.content"></code></pre>
                        </template>
                    </div>
                </template>
                <!-- Non-browser content: Markdown (existing behavior, backwards compatible) -->
                <template x-if="contentModal.type === 'markdown' && !contentModal.browser">
                    <div class="markdown-content text-sm"
                         x-html="formatMarkdownContent(contentModal.content)"
                         x-effect="$nextTick(() => { if (contentModal.show && contentModal.type === 'markdown') refreshIcons(); })">
                    </div>
                </template>
                <!-- Plain text/XML content (XSS-safe) -->
                <template x-if="contentModal.type !== 'markdown'">
                    <pre class="text-sm whitespace-pre-wrap font-mono"><code x-text="contentModal.content"></code></pre>
                </template>
            </div>
        </div>
    </div>

    <!-- Epic Metrics Modal (Story 24.7) -->
    <div x-show="metricsModal.show"
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-150"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         @keydown.escape.window="if (metricsModal.show && !contentModal.show && !busyModal.show) closeEpicMetrics()"
         class="fixed inset-0 z-50 flex items-center justify-center bg-black/50"
         data-testid="metrics-modal">

        <div class="card shadow-xl p-0 gap-0 overflow-hidden w-3/4 max-w-4xl max-h-[80vh] flex flex-col"
             x-show="metricsModal.show"
             x-transition:enter="transition ease-out duration-200"
             x-transition:enter-start="opacity-0 scale-95"
             x-transition:enter-end="opacity-100 scale-100"
             x-transition:leave="transition ease-in duration-150"
             x-transition:leave-start="opacity-100 scale-100"
             x-transition:leave-end="opacity-0 scale-95"
             role="dialog"
             aria-modal="true"
             aria-labelledby="metrics-modal-title"
             @click.outside="closeEpicMetrics()">

            <!-- Header -->
            <div class="flex items-center justify-between px-4 py-2 border-b border-border">
                <h2 id="metrics-modal-title" class="text-lg font-semibold flex items-center gap-2">
                    <i data-lucide="bar-chart-2" class="w-5 h-5"></i>
                    <span x-text="`Epic ${metricsModal.epicId} Metrics`"></span>
                </h2>
                <button @click="closeEpicMetrics()"
                        class="btn-sm-icon-ghost"
                        aria-label="Close metrics modal"
                        data-testid="close-metrics-btn">
                    <i data-lucide="x" class="w-4 h-4"></i>
                </button>
            </div>

            <!-- Content -->
            <div class="flex-1 overflow-auto p-4 space-y-6">

                <!-- Loading State -->
                <div x-show="metricsModal.loading" class="flex items-center justify-center py-12">
                    <i data-lucide="loader-2" class="w-8 h-8 animate-spin text-primary"></i>
                    <span class="ml-3 text-muted-foreground">Loading metrics...</span>
                </div>

                <!-- Metrics Content (shown when not loading and data exists) -->
                <template x-if="!metricsModal.loading && metricsModal.data">
                    <div class="space-y-6">
                        <!-- Total Duration -->
                        <div class="text-center">
                            <span class="text-muted-foreground">Total:</span>
                            <span class="text-2xl font-bold tabular-nums ml-2"
                                  x-text="formatDuration(metricsModal.data?.total_duration_ms || 0)"></span>
                        </div>

                        <!-- Timeline Bar Chart -->
                        <div class="metrics-timeline relative" data-testid="metrics-timeline">
                            <div class="flex h-8 rounded overflow-hidden border border-border">
                                <template x-for="(story, index) in (metricsModal.data?.stories || [])" :key="story.story_num">
                                    <div class="metrics-segment relative cursor-pointer"
                                         :class="getSegmentColor(index)"
                                         :style="`width: ${getSegmentWidth(story.total_duration_ms, metricsModal.data.total_duration_ms)}%`"
                                         @mouseenter="showSegmentTooltip($event, story)"
                                         @mousemove="showSegmentTooltip($event, story)"
                                         @mouseleave="hideSegmentTooltip()"
                                         :data-testid="`segment-${story.story_num}`">
                                        <!-- Story number label (shown if segment wide enough) -->
                                        <span x-show="getSegmentWidth(story.total_duration_ms, metricsModal.data.total_duration_ms) > 8"
                                              class="absolute inset-0 flex items-center justify-center text-xs text-white font-medium"
                                              x-text="`${metricsModal.epicId}.${story.story_num}`"></span>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <!-- Stories Accordion -->
                        <div class="metrics-accordion space-y-1" data-testid="metrics-accordion">
                            <template x-for="story in (metricsModal.data?.stories || [])" :key="story.story_num">
                                <div class="border border-border rounded">
                                    <!-- Story Header -->
                                    <button @click="toggleMetricsStory(story.story_num)"
                                            @keydown.enter="toggleMetricsStory(story.story_num)"
                                            @keydown.space.prevent="toggleMetricsStory(story.story_num)"
                                            class="w-full flex items-center justify-between px-4 py-2 hover:bg-muted text-left"
                                            :aria-expanded="isMetricsStoryExpanded(story.story_num)"
                                            :data-testid="`accordion-${story.story_num}`">
                                        <div class="flex items-center gap-2">
                                            <i :data-lucide="isMetricsStoryExpanded(story.story_num) ? 'chevron-down' : 'chevron-right'"
                                               class="w-4 h-4 transition-transform"></i>
                                            <span x-text="`${metricsModal.epicId}.${story.story_num} ${story.title}`"></span>
                                        </div>
                                        <span class="tabular-nums text-muted-foreground" x-text="formatDuration(story.total_duration_ms)"></span>
                                    </button>
                                    <!-- Story Details (expanded) -->
                                    <div x-show="isMetricsStoryExpanded(story.story_num)"
                                         x-transition:enter="transition ease-out duration-150"
                                         x-transition:enter-start="opacity-0"
                                         x-transition:enter-end="opacity-100"
                                         class="px-4 py-2 border-t border-border bg-muted/50">
                                        <template x-for="(wdata, workflow) in (story.workflows || {})" :key="workflow">
                                            <div class="flex justify-between py-1 text-sm">
                                                <div class="flex items-center gap-2">
                                                    <span class="text-muted-foreground" x-text="workflow"></span>
                                                    <span class="text-xs text-muted-foreground/60" x-text="`(${(wdata.roles || []).join(', ')})`"></span>
                                                </div>
                                                <span class="tabular-nums" x-text="formatDuration(wdata.duration_ms)"></span>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <!-- Segment Tooltip (positioned fixed, outside modal card) -->
        <div x-show="_hoveredSegment"
             x-transition
             class="metrics-tooltip fixed z-50 bg-popover border border-border px-3 py-2 rounded shadow-lg text-sm pointer-events-none"
             :style="`left: ${_tooltipPosition.x}px; top: ${_tooltipPosition.y}px`"
             data-testid="metrics-tooltip">
            <span x-text="_hoveredSegment?.label || ''"></span>
        </div>
    </div>

    <!-- Prompt Browser Modal (Story 23.5) -->
    <div x-show="promptBrowser.show"
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-150"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         @keydown.escape.window="if (promptBrowser.show && !contentModal.show && !busyModal.show) closePromptBrowser()"
         class="fixed inset-0 z-40 flex items-center justify-center bg-black/50"
         data-testid="prompt-browser-modal">

        <div class="card shadow-xl p-0 gap-0 overflow-hidden w-4/5 max-h-[80vh] flex flex-col"
             x-show="promptBrowser.show"
             x-transition:enter="transition ease-out duration-200"
             x-transition:enter-start="opacity-0 scale-95"
             x-transition:enter-end="opacity-100 scale-100"
             x-transition:leave="transition ease-in duration-150"
             x-transition:leave-start="opacity-100 scale-100"
             x-transition:leave-end="opacity-0 scale-95"
             role="dialog"
             aria-modal="true"
             @click.outside="closePromptBrowser()">

            <!-- Header -->
            <div class="flex items-center justify-between px-4 py-2 border-b border-border">
                <h2 class="text-lg font-semibold flex items-center gap-2">
                    <i data-lucide="file-code" class="w-5 h-5"></i>
                    <span x-text="promptBrowser.title"></span>
                </h2>
                <div class="flex items-center gap-2">
                    <button @click="copyToClipboard(promptBrowser.content)"
                            class="btn-sm-icon-ghost"
                            title="Copy raw XML"
                            aria-label="Copy raw XML to clipboard">
                        <i data-lucide="clipboard" class="w-4 h-4"></i>
                    </button>
                    <button @click="closePromptBrowser()"
                            class="btn-sm-icon-ghost"
                            data-testid="close-prompt-browser">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>

            <!-- Content -->
            <div class="flex-1 overflow-auto p-4">

                <!-- Loading State -->
                <div x-show="promptBrowser.loading" class="flex items-center justify-center py-12">
                    <i data-lucide="loader-2" class="w-8 h-8 animate-spin text-primary"></i>
                    <span class="ml-3 text-muted-foreground">Parsing prompt structure...</span>
                </div>

                <!-- Error State -->
                <div x-show="promptBrowser.parseError && !promptBrowser.loading" class="space-y-4">
                    <div class="bg-destructive/10 border border-destructive/30 rounded p-4">
                        <div class="flex items-center gap-2 text-destructive mb-2">
                            <i data-lucide="alert-circle" class="w-5 h-5"></i>
                            <span class="font-medium">Unable to parse prompt structure</span>
                        </div>
                        <p class="text-sm text-muted-foreground" x-text="promptBrowser.parseError"></p>
                    </div>
                    <button @click="contentModal.title = promptBrowser.title; contentModal.content = promptBrowser.content; contentModal.type = 'xml'; contentModal.show = true; closePromptBrowser();"
                            class="btn-outline"
                            data-testid="view-raw-xml">
                        <i data-lucide="code" class="w-4 h-4 mr-2"></i>
                        View Raw XML
                    </button>
                </div>

                <!-- Parsed Content -->
                <div x-show="promptBrowser.parsed && !promptBrowser.loading && !promptBrowser.parseError" class="space-y-3">

                    <!-- Mission Section (collapsible, starts expanded) - Story 23.6: Content type detection, Story 24.4: Collapsible -->
                    <div class="prompt-section" data-testid="section-mission">
                        <div class="prompt-section-header"
                             :class="{ 'expanded': isExpanded('mission') }"
                             @click="toggleSection('mission')"
                             @keydown.enter="toggleSection('mission')"
                             @keydown.space.prevent="toggleSection('mission')"
                             tabindex="0"
                             role="button"
                             :aria-expanded="isExpanded('mission')">
                            <i :data-lucide="getChevronIcon('mission')" class="w-4 h-4 chevron"></i>
                            <i data-lucide="target" class="w-4 h-4 text-primary"></i>
                            <span class="font-medium">Mission</span>
                        </div>
                        <div x-show="isExpanded('mission')"
                             x-transition:enter="transition ease-out duration-150"
                             x-transition:enter-start="opacity-0"
                             x-transition:enter-end="opacity-100"
                             class="prompt-section-content">
                            <!-- Mission content with cached type detection (typically markdown) -->
                            <template x-if="promptBrowser.parsed?.missionContentType === 'markdown'">
                                <div class="markdown-content text-sm"
                                     x-html="renderMarkdownContent(promptBrowser.parsed?.mission || '', 'mission')"></div>
                            </template>
                            <template x-if="promptBrowser.parsed?.missionContentType !== 'markdown'">
                                <pre class="text-sm whitespace-pre-wrap font-mono" x-text="promptBrowser.parsed?.mission || ''"></pre>
                            </template>
                        </div>
                    </div>

                    <!-- File Index Section (collapsed by default) -->
                    <template x-if="promptBrowser.parsed?.fileIndex?.length > 0">
                        <div class="prompt-section" data-testid="section-file-index">
                            <div class="prompt-section-header"
                                 :class="{ 'expanded': isExpanded('file-index') }"
                                 @click="toggleSection('file-index')"
                                 @keydown.enter="toggleSection('file-index')"
                                 @keydown.space.prevent="toggleSection('file-index')"
                                 tabindex="0"
                                 role="button"
                                 :aria-expanded="isExpanded('file-index')">
                                <i :data-lucide="getChevronIcon('file-index')" class="w-4 h-4 chevron"></i>
                                <i data-lucide="list" class="w-4 h-4 text-muted-foreground"></i>
                                <span>File Index</span>
                                <span class="text-xs text-muted-foreground ml-auto" x-text="`${promptBrowser.parsed?.fileIndex?.length || 0} files`"></span>
                            </div>
                            <div x-show="isExpanded('file-index')"
                                 x-transition:enter="transition ease-out duration-150"
                                 x-transition:enter-start="opacity-0"
                                 x-transition:enter-end="opacity-100"
                                 class="prompt-section-content">
                                <div class="space-y-1">
                                    <template x-for="entry in promptBrowser.parsed?.fileIndex || []" :key="entry.id">
                                        <div class="flex items-center gap-2 text-sm font-mono">
                                            <span class="text-muted-foreground w-20 truncate" x-text="entry.id"></span>
                                            <span x-text="entry.path"></span>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </template>

                    <!-- Context Files Section -->
                    <template x-if="promptBrowser.parsed?.context?.files?.length > 0">
                        <div class="prompt-section" data-testid="section-context">
                            <div class="prompt-section-header expanded">
                                <i data-lucide="folder-open" class="w-4 h-4 text-accent"></i>
                                <span class="font-medium">Context Files</span>
                                <span class="text-xs text-muted-foreground ml-auto" x-text="`${promptBrowser.parsed?.context?.files?.length || 0} files`"></span>
                            </div>
                            <div class="prompt-section-content p-0">
                                <div class="space-y-1">
                                    <template x-for="(file, index) in promptBrowser.parsed?.context?.files || []" :key="file.id || index">
                                        <div class="prompt-file-section"
                                             :data-section-id="`file-${file.id || index}`">
                                            <div class="prompt-section-header"
                                                 :class="{ 'expanded': isExpanded(`file-${file.id || index}`) }"
                                                 @click="toggleFileSection(`file-${file.id || index}`, file.content, getFileLanguage(file.path))"
                                                 @keydown.enter="toggleFileSection(`file-${file.id || index}`, file.content, getFileLanguage(file.path))"
                                                 @keydown.space.prevent="toggleFileSection(`file-${file.id || index}`, file.content, getFileLanguage(file.path))"
                                                 tabindex="0"
                                                 role="button"
                                                 :aria-expanded="isExpanded(`file-${file.id || index}`)">
                                                <i :data-lucide="getChevronIcon(`file-${file.id || index}`)" class="w-4 h-4 chevron"></i>
                                                <i data-lucide="file" class="w-4 h-4 text-muted-foreground"></i>
                                                <span class="text-sm font-mono truncate" x-text="getFilenameWithMapping(file.path)" :title="getPathWithMapping(file.path)"></span>
                                                <!-- CDATA indicator (Story 23.6 AC1, Story 24.4: package icon) -->
                                                <span x-show="file.hasCdata"
                                                      class="cdata-indicator ml-1"
                                                      title="Content wrapped in CDATA"
                                                      x-effect="if (file.hasCdata) $nextTick(() => refreshIcons())">
                                                    <i data-lucide="package" class="w-3 h-3"></i>
                                                </span>
                                                <span class="text-xs text-muted-foreground ml-auto opacity-60" x-text="estimateTokens(file.content)"></span>
                                            </div>
                                            <div x-show="isExpanded(`file-${file.id || index}`)"
                                                 x-transition:enter="transition ease-out duration-150"
                                                 x-transition:enter-start="opacity-0"
                                                 x-transition:enter-end="opacity-100"
                                                 class="prompt-section-content file-content-wrapper">
                                                <div class="text-xs text-muted-foreground mb-2 font-mono truncate" x-text="getPathWithMapping(file.path)"></div>
                                                <!-- Content type based rendering (Story 23.6 AC2-AC5) -->
                                                <div class="file-content-code">
                                                    <!-- Markdown content -->
                                                    <template x-if="file.contentType === 'markdown'">
                                                        <div class="markdown-content text-sm"
                                                             x-html="renderMarkdownContent(file.content, `file-${file.id || index}`)"></div>
                                                    </template>
                                                    <!-- XML content -->
                                                    <template x-if="file.contentType === 'xml'">
                                                        <div class="xml-content"
                                                             x-html="renderXmlContent(file.content, `file-${file.id || index}`)"></div>
                                                    </template>
                                                    <!-- Plain text fallback -->
                                                    <template x-if="file.contentType === 'text' || !file.contentType">
                                                        <pre class="shiki shiki-loading text-sm"><code x-text="file.content"></code></pre>
                                                    </template>
                                                </div>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </template>

                    <!-- Variables Section (Story 23.7 - Enhanced with view toggle) -->
                    <template x-if="promptBrowser.parsed?.variables?.length > 0">
                        <div class="prompt-section" data-testid="section-variables">
                            <div class="prompt-section-header"
                                 :class="{ 'expanded': isExpanded('variables') }"
                                 @click="toggleSection('variables')"
                                 @keydown.enter="toggleSection('variables')"
                                 @keydown.space.prevent="toggleSection('variables')"
                                 tabindex="0"
                                 role="button"
                                 :aria-expanded="isExpanded('variables')">
                                <i :data-lucide="getChevronIcon('variables')" class="w-4 h-4 chevron"></i>
                                <i data-lucide="variable" class="w-4 h-4 text-chart-3"></i>
                                <span>Variables</span>
                                <span class="text-xs text-muted-foreground ml-auto mr-2" x-text="`${promptBrowser.parsed?.variables?.length || 0} vars`"></span>
                                <!-- View toggle buttons (Story 23.7 AC1) -->
                                <div class="variables-view-toggle" @click.stop data-testid="variables-view-toggle">
                                    <button @click="variablesView = 'rendered'"
                                            :class="{'active': variablesView === 'rendered'}"
                                            class="flex items-center gap-1 px-2 py-0.5 text-xs rounded"
                                            title="Rendered view"
                                            data-testid="variables-view-rendered">
                                        <i data-lucide="layout-grid" class="w-3 h-3"></i>
                                    </button>
                                    <button @click="variablesView = 'raw'"
                                            :class="{'active': variablesView === 'raw'}"
                                            class="flex items-center gap-1 px-2 py-0.5 text-xs rounded"
                                            title="Raw XML"
                                            data-testid="variables-view-raw">
                                        <i data-lucide="code" class="w-3 h-3"></i>
                                    </button>
                                </div>
                            </div>
                            <div x-show="isExpanded('variables')"
                                 x-transition:enter="transition ease-out duration-150"
                                 x-transition:enter-start="opacity-0"
                                 x-transition:enter-end="opacity-100"
                                 class="prompt-section-content">
                                <!-- Rendered view (Story 23.7 AC2) -->
                                <template x-if="variablesView === 'rendered'">
                                    <div class="variables-rendered-view" data-testid="variables-rendered">
                                        <template x-for="categoryName in getVariableCategoryOrder()" :key="categoryName">
                                            <div class="variables-category">
                                                <div class="variables-category-header" x-text="categoryName"></div>
                                                <div class="variables-grid">
                                                    <template x-for="v in getVariablesForCategory(categoryName)" :key="v.name">
                                                        <div class="variable-item">
                                                            <span class="variable-name" x-text="v.name"></span>
                                                            <span class="text-muted-foreground">=</span>
                                                            <!-- FIX: Show tooltip for all values (paths or long values get truncated at 200px) -->
                                                            <span class="variable-value"
                                                                  :class="{'cursor-help': isPathShortened(v) || (v.fullValue && v.fullValue.length > 30)}"
                                                                  :title="v.fullValue"
                                                                  x-text="v.displayValue"></span>
                                                            <span x-show="v.fileId" class="text-xs text-muted-foreground opacity-60" x-text="`[${v.fileId}]`"></span>
                                                        </div>
                                                    </template>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </template>
                                <!-- Raw XML view (Story 23.7 AC4) -->
                                <template x-if="variablesView === 'raw'">
                                    <div class="xml-content" data-testid="variables-raw"
                                         x-html="renderXmlContent(getVariablesRawXml(), 'variables-raw')"></div>
                                </template>
                            </div>
                        </div>
                    </template>

                    <!-- Instructions Section (expanded by default) - Story 23.6: Content type detection, Story 24.4: Default via JS -->
                    <div class="prompt-section" data-testid="section-instructions">
                        <div class="prompt-section-header"
                             :class="{ 'expanded': isExpanded('instructions') }"
                             @click="toggleSection('instructions')"
                             @keydown.enter="toggleSection('instructions')"
                             @keydown.space.prevent="toggleSection('instructions')"
                             tabindex="0"
                             role="button"
                             :aria-expanded="isExpanded('instructions')">
                            <i :data-lucide="getChevronIcon('instructions')" class="w-4 h-4 chevron"></i>
                            <i data-lucide="list-checks" class="w-4 h-4 text-primary"></i>
                            <span class="font-medium">Instructions</span>
                        </div>
                        <div x-show="isExpanded('instructions')"
                             x-transition:enter="transition ease-out duration-150"
                             x-transition:enter-start="opacity-0"
                             x-transition:enter-end="opacity-100"
                             class="prompt-section-content">
                            <!-- Instructions content with cached type detection (typically XML) -->
                            <template x-if="promptBrowser.parsed?.instructionsContentType === 'xml'">
                                <div class="xml-content"
                                     x-html="renderXmlContent(promptBrowser.parsed?.instructions || '', 'instructions')"></div>
                            </template>
                            <template x-if="promptBrowser.parsed?.instructionsContentType !== 'xml'">
                                <pre class="text-sm whitespace-pre-wrap font-mono overflow-x-auto" x-text="promptBrowser.parsed?.instructions || ''"></pre>
                            </template>
                        </div>
                    </div>

                    <!-- Output Template Section (collapsed by default) - Story 23.6: Content type detection -->
                    <template x-if="promptBrowser.parsed?.output">
                        <div class="prompt-section" data-testid="section-output">
                            <div class="prompt-section-header"
                                 :class="{ 'expanded': isExpanded('output') }"
                                 @click="toggleSection('output')"
                                 @keydown.enter="toggleSection('output')"
                                 @keydown.space.prevent="toggleSection('output')"
                                 tabindex="0"
                                 role="button"
                                 :aria-expanded="isExpanded('output')">
                                <i :data-lucide="getChevronIcon('output')" class="w-4 h-4 chevron"></i>
                                <i data-lucide="file-output" class="w-4 h-4 text-bp-warning"></i>
                                <span>Output Template</span>
                            </div>
                            <div x-show="isExpanded('output')"
                                 x-transition:enter="transition ease-out duration-150"
                                 x-transition:enter-start="opacity-0"
                                 x-transition:enter-end="opacity-100"
                                 class="prompt-section-content">
                                <!-- Output content with cached type detection (typically markdown) -->
                                <template x-if="promptBrowser.parsed?.outputContentType === 'markdown'">
                                    <div class="markdown-content text-sm"
                                         x-html="renderMarkdownContent(promptBrowser.parsed?.output || '', 'output')"></div>
                                </template>
                                <template x-if="promptBrowser.parsed?.outputContentType !== 'markdown'">
                                    <pre class="text-sm whitespace-pre-wrap font-mono" x-text="promptBrowser.parsed?.output || ''"></pre>
                                </template>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </div>

    <!-- Report List Modal (Story 16.9 - AC 4) - Updated for both Validation and Code Review -->
    <div x-show="reportModal.show"
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-150"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         @keydown.escape.window="if (reportModal.show && !contentModal.show && !busyModal.show) reportModal.show = false"
         class="fixed inset-0 z-40 flex items-center justify-center bg-black/50"
         data-testid="report-modal">

        <div class="card shadow-xl p-0 gap-0 overflow-hidden w-[480px] max-h-[70vh] flex flex-col"
             x-show="reportModal.show"
             x-transition:enter="transition ease-out duration-200"
             x-transition:enter-start="opacity-0 scale-95"
             x-transition:enter-end="opacity-100 scale-100"
             x-transition:leave="transition ease-in duration-150"
             x-transition:leave-start="opacity-100 scale-100"
             x-transition:leave-end="opacity-0 scale-95"
             role="dialog"
             aria-modal="true"
             @click.outside="reportModal.show = false">

            <!-- Header -->
            <div class="px-4 py-2 border-b border-border">
                <h2 class="text-lg font-semibold flex items-center gap-2">
                    <i data-lucide="file-text" class="w-5 h-5"></i>
                    Review Reports
                    <span class="text-muted-foreground text-sm" x-text="`${reportModal.epic}.${reportModal.story}`"></span>
                </h2>
            </div>

            <!-- Report List -->
            <div class="flex-1 overflow-auto p-3 space-y-4">

                <!-- Validation Section -->
                <div class="space-y-2">
                    <h3 class="text-sm font-medium text-muted-foreground flex items-center gap-2">
                        <i data-lucide="check-circle" class="w-4 h-4 text-bp-warning"></i>
                        Validation Reports
                    </h3>

                    <!-- Validation Synthesis -->
                    <template x-if="reportModal.validation?.synthesis">
                        <button @click="loadReportContent(reportModal.validation.synthesis)"
                                class="w-full text-left px-3 py-2 rounded bg-bp-warning/10 hover:bg-bp-warning/20 focus:ring-2 focus:ring-ring focus:outline-none flex items-center gap-2"
                                data-testid="validation-synthesis">
                            <i data-lucide="edit" class="w-4 h-4 text-bp-warning"></i>
                            <span class="text-bp-warning font-medium">Validation Synthesis</span>
                        </button>
                    </template>

                    <!-- Validation Individual Reports (Story 24.8: Show mapped model names) -->
                    <template x-for="report in (reportModal.validation?.reports || [])" :key="report.path">
                        <button @click="loadReportContent(report)"
                                class="w-full text-left px-3 py-2 rounded hover:bg-secondary focus:ring-2 focus:ring-ring focus:outline-none flex items-center gap-2"
                                data-testid="validation-report-item">
                            <i data-lucide="file" class="w-4 h-4"></i>
                            <span x-text="getReportDisplayName(report)"></span>
                        </button>
                    </template>

                    <!-- Validation Empty State -->
                    <div x-show="(reportModal.validation?.reports || []).length === 0 && !reportModal.validation?.synthesis"
                         class="text-muted-foreground text-center py-2 text-sm">
                        No validation reports
                    </div>
                </div>

                <!-- Code Review Section -->
                <div class="space-y-2 pt-2 border-t border-border">
                    <h3 class="text-sm font-medium text-muted-foreground flex items-center gap-2">
                        <i data-lucide="code" class="w-4 h-4 text-destructive"></i>
                        Code Review Reports
                    </h3>

                    <!-- Code Review Synthesis -->
                    <template x-if="reportModal.code_review?.synthesis">
                        <button @click="loadReportContent(reportModal.code_review.synthesis)"
                                class="w-full text-left px-3 py-2 rounded bg-destructive/10 hover:bg-destructive/20 focus:ring-2 focus:ring-ring focus:outline-none flex items-center gap-2"
                                data-testid="code-review-synthesis">
                            <i data-lucide="edit" class="w-4 h-4 text-destructive"></i>
                            <span class="text-destructive font-medium">Code Review Synthesis</span>
                        </button>
                    </template>

                    <!-- Code Review Individual Reports (Story 24.8: Show mapped model names) -->
                    <template x-for="report in (reportModal.code_review?.reports || [])" :key="report.path">
                        <button @click="loadReportContent(report)"
                                class="w-full text-left px-3 py-2 rounded hover:bg-secondary focus:ring-2 focus:ring-ring focus:outline-none flex items-center gap-2"
                                data-testid="code-review-report-item">
                            <i data-lucide="file" class="w-4 h-4"></i>
                            <span x-text="getReportDisplayName(report)"></span>
                        </button>
                    </template>

                    <!-- Code Review Empty State -->
                    <div x-show="(reportModal.code_review?.reports || []).length === 0 && !reportModal.code_review?.synthesis"
                         class="text-muted-foreground text-center py-2 text-sm">
                        No code review reports
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="px-4 py-3 border-t border-border">
                <button @click="reportModal.show = false"
                        class="btn-outline w-full"
                        data-testid="close-report-modal">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Import Preview Modal (Story 17.12 AC6) -->
    <div x-show="importView.modalOpen"
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         @keydown.escape.window="if (importView.modalOpen && !busyModal.show) closeImportModal()"
         class="fixed inset-0 z-50 flex items-center justify-center bg-black/50"
         data-testid="import-modal">

        <div class="card shadow-xl p-0 gap-0 overflow-hidden w-[600px] max-h-[80vh] flex flex-col"
             x-show="importView.modalOpen"
             x-transition:enter="transition ease-out duration-200"
             x-transition:enter-start="opacity-0 scale-95"
             x-transition:enter-end="opacity-100 scale-100">

            <!-- Header -->
            <div class="flex items-center justify-between px-4 py-2 border-b border-border">
                <h2 class="text-lg font-semibold flex items-center gap-2">
                    <i data-lucide="file-up" class="w-5 h-5"></i>
                    Import Preview
                    <span class="text-muted-foreground text-sm" x-text="importView.filename"></span>
                </h2>
                <button @click="closeImportModal()"
                        class="btn-sm-icon-ghost">
                    <i data-lucide="x" class="w-4 h-4"></i>
                </button>
            </div>

            <!-- Scope Selector (disabled while loading) -->
            <div class="px-4 py-2 border-b border-border flex items-center gap-4">
                <span class="text-sm text-muted-foreground">Import to:</span>
                <label class="flex items-center gap-2 cursor-pointer" :class="{'opacity-50': importView.loading}">
                    <input type="radio" value="global" x-model="importView.scope"
                           :disabled="importView.loading"
                           @change="refreshImportPreview()"
                           class="form-radio text-primary">
                    <span>Global</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer" :class="{'opacity-50': importView.loading}">
                    <input type="radio" value="project" x-model="importView.scope"
                           :disabled="importView.loading"
                           @change="refreshImportPreview()"
                           class="form-radio text-primary">
                    <span>Project</span>
                </label>
            </div>

            <!-- Content -->
            <div class="flex-1 overflow-auto p-4 space-y-4">

                <!-- Loading -->
                <div x-show="importView.loading" class="flex items-center justify-center py-8">
                    <i data-lucide="loader-2" class="w-6 h-6 animate-spin text-primary"></i>
                    <span class="ml-2">Validating import...</span>
                </div>

                <!-- Errors -->
                <div x-show="importView.errors && !importView.loading"
                     class="bg-destructive/10 border border-destructive/30 rounded p-4">
                    <div class="flex items-center gap-2 text-destructive mb-2">
                        <i data-lucide="alert-circle" class="w-5 h-5"></i>
                        <span class="font-medium">Import Validation Failed</span>
                    </div>
                    <div x-show="importView.errors === 'validation'" class="space-y-2">
                        <template x-for="(msg, path) in validationErrors" :key="path">
                            <div class="text-sm">
                                <span class="font-mono text-xs" x-text="path"></span>:
                                <span class="text-destructive" x-text="msg"></span>
                            </div>
                        </template>
                    </div>
                    <div x-show="typeof importView.errors === 'string'" class="text-sm" x-text="importView.errors"></div>
                </div>

                <!-- Diff Preview -->
                <div x-show="importView.diff && !importView.loading && !importView.errors" class="space-y-4">

                    <!-- No Changes -->
                    <div x-show="!hasImportChanges()"
                         class="text-center py-8 text-muted-foreground">
                        <i data-lucide="check-circle" class="w-8 h-8 mx-auto mb-2 text-accent"></i>
                        <p>No changes detected.</p>
                        <p class="text-sm">Import matches current <span x-text="importView.scope"></span> config.</p>
                    </div>

                    <!-- Added Fields -->
                    <div x-show="Object.keys(importView.diff?.added || {}).length > 0">
                        <h4 class="text-sm font-medium text-accent mb-2 flex items-center gap-2">
                            <i data-lucide="plus-circle" class="w-4 h-4"></i>
                            Added (<span x-text="Object.keys(importView.diff?.added || {}).length"></span>)
                        </h4>
                        <div class="space-y-1">
                            <template x-for="(value, path) in importView.diff?.added || {}" :key="path">
                                <div class="flex items-center gap-2 px-3 py-2 bg-accent/10 rounded text-sm">
                                    <span class="font-mono text-xs flex-1" x-text="path"></span>
                                    <span class="text-accent truncate max-w-[200px]" x-text="JSON.stringify(value)"></span>
                                    <i x-show="importView.riskyFields?.includes(path)"
                                       data-lucide="alert-triangle" class="w-4 h-4 text-bp-warning" title="Risky field"></i>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- Modified Fields -->
                    <div x-show="Object.keys(importView.diff?.modified || {}).length > 0">
                        <h4 class="text-sm font-medium text-bp-warning mb-2 flex items-center gap-2">
                            <i data-lucide="edit" class="w-4 h-4"></i>
                            Modified (<span x-text="Object.keys(importView.diff?.modified || {}).length"></span>)
                        </h4>
                        <div class="space-y-1">
                            <template x-for="(change, path) in importView.diff?.modified || {}" :key="path">
                                <div class="flex items-center gap-2 px-3 py-2 bg-bp-warning/10 rounded text-sm">
                                    <span class="font-mono text-xs" x-text="path"></span>
                                    <span class="text-muted-foreground line-through truncate max-w-[100px]" x-text="JSON.stringify(change.old)"></span>
                                    <i data-lucide="arrow-right" class="w-3 h-3"></i>
                                    <span class="text-bp-warning truncate max-w-[100px]" x-text="JSON.stringify(change.new)"></span>
                                    <i x-show="importView.riskyFields?.includes(path)"
                                       data-lucide="alert-triangle" class="w-4 h-4 text-bp-warning ml-auto" title="Risky field"></i>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- Removed Fields -->
                    <div x-show="(importView.diff?.removed || []).length > 0">
                        <h4 class="text-sm font-medium text-destructive mb-2 flex items-center gap-2">
                            <i data-lucide="minus-circle" class="w-4 h-4"></i>
                            Removed (<span x-text="(importView.diff?.removed || []).length"></span>)
                        </h4>
                        <div class="space-y-1">
                            <template x-for="path in importView.diff?.removed || []" :key="path">
                                <div class="flex items-center gap-2 px-3 py-2 bg-destructive/10 rounded text-sm">
                                    <span class="font-mono text-xs text-destructive" x-text="path"></span>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="flex justify-end gap-3 px-4 py-3 border-t border-border">
                <button class="btn-outline" @click="closeImportModal()">
                    Cancel
                </button>
                <button class="btn"
                        :disabled="importView.loading || importView.errors || !importView.diff || !hasImportChanges()"
                        @click="applyImport()">
                    <template x-if="importView.loading">
                        <i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i>
                    </template>
                    Apply Import
                </button>
            </div>
        </div>
    </div>

    <!-- Run Trigger Modal (Story 19.6) -->
    <div x-show="runTrigger.modalOpen"
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-150"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         @keydown.escape.window="if (runTrigger.modalOpen) closeRunTriggerModal()"
         class="fixed inset-0 z-50 flex items-center justify-center bg-black/50"
         data-testid="run-trigger-modal">

        <div class="card shadow-xl p-0 gap-0 overflow-hidden w-full max-w-md"
             x-show="runTrigger.modalOpen"
             x-transition:enter="transition ease-out duration-200"
             x-transition:enter-start="opacity-0 scale-95"
             x-transition:enter-end="opacity-100 scale-100"
             x-transition:leave="transition ease-in duration-150"
             x-transition:leave-start="opacity-100 scale-100"
             x-transition:leave-end="opacity-0 scale-95"
             @click.outside="closeRunTriggerModal()">

            <!-- Header -->
            <div class="flex items-center justify-between px-4 py-2 border-b border-border">
                <h2 class="text-lg font-semibold flex items-center gap-2">
                    <i data-lucide="play-circle" class="w-5 h-5"></i>
                    Start Experiment Run
                </h2>
                <button @click="closeRunTriggerModal()" class="btn-sm-icon-ghost">
                    <i data-lucide="x" class="w-4 h-4"></i>
                </button>
            </div>

            <!-- Form -->
            <div class="p-4 space-y-4">
                <!-- Error -->
                <div x-show="runTrigger.error"
                     class="bg-destructive/10 border border-destructive/30 rounded p-3 text-sm text-destructive">
                    <i data-lucide="alert-circle" class="w-4 h-4 inline-block mr-1"></i>
                    <span x-text="runTrigger.error"></span>
                </div>

                <!-- Fixture -->
                <div>
                    <label class="block text-sm font-medium mb-1">Fixture</label>
                    <select x-model="runTrigger.fixture"
                            class="input w-full"
                            data-testid="run-trigger-fixture">
                        <template x-for="f in runTrigger.fixtures" :key="f.name">
                            <option :value="f.name" x-text="f.name"></option>
                        </template>
                    </select>
                    <p x-show="runTrigger.fixtures.length === 0" class="text-sm text-muted-foreground mt-1">
                        No fixtures found
                    </p>
                </div>

                <!-- Config -->
                <div>
                    <label class="block text-sm font-medium mb-1">Config</label>
                    <select x-model="runTrigger.config"
                            class="input w-full"
                            data-testid="run-trigger-config">
                        <template x-for="c in runTrigger.configs" :key="c.name">
                            <option :value="c.name" x-text="c.name"></option>
                        </template>
                    </select>
                    <p x-show="runTrigger.configs.length === 0" class="text-sm text-muted-foreground mt-1">
                        No configs found
                    </p>
                </div>

                <!-- Patch-Set -->
                <div>
                    <label class="block text-sm font-medium mb-1">Patch-Set</label>
                    <select x-model="runTrigger.patchSet"
                            class="input w-full"
                            data-testid="run-trigger-patchset">
                        <template x-for="p in runTrigger.patchSets" :key="p.name">
                            <option :value="p.name" x-text="p.name"></option>
                        </template>
                    </select>
                    <p x-show="runTrigger.patchSets.length === 0" class="text-sm text-muted-foreground mt-1">
                        No patch-sets found
                    </p>
                </div>

                <!-- Loop -->
                <div>
                    <label class="block text-sm font-medium mb-1">Loop</label>
                    <select x-model="runTrigger.loop"
                            class="input w-full"
                            data-testid="run-trigger-loop">
                        <template x-for="l in runTrigger.loops" :key="l.name">
                            <option :value="l.name" x-text="l.name"></option>
                        </template>
                    </select>
                    <p x-show="runTrigger.loops.length === 0" class="text-sm text-muted-foreground mt-1">
                        No loops found
                    </p>
                </div>
            </div>

            <!-- Footer -->
            <div class="flex justify-end gap-3 px-4 py-3 border-t border-border">
                <button class="btn-outline" @click="closeRunTriggerModal()">
                    Cancel
                </button>
                <button class="btn"
                        :disabled="runTrigger.loading || !runTrigger.fixture || !runTrigger.config || !runTrigger.patchSet || !runTrigger.loop"
                        @click="submitRunTrigger()"
                        data-testid="run-trigger-submit">
                    <template x-if="runTrigger.loading">
                        <i data-lucide="loader-2" class="w-4 h-4 animate-spin mr-1"></i>
                    </template>
                    <i x-show="!runTrigger.loading" data-lucide="play" class="w-4 h-4 mr-1"></i>
                    Start Run
                </button>
            </div>
        </div>
    </div>

    <!-- Active Experiment Progress (Story 19.6) - Fixed position floating card -->
    <div x-show="activeExperiment.runId"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0 translate-y-4"
         x-transition:enter-end="opacity-100 translate-y-0"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100 translate-y-0"
         x-transition:leave-end="opacity-0 translate-y-4"
         class="fixed bottom-4 right-4 z-40 w-80"
         data-testid="active-experiment-progress">

        <div class="card shadow-xl p-0 gap-0 overflow-hidden border border-border">
            <!-- Header -->
            <div class="flex items-center justify-between px-3 py-2 border-b border-border bg-card">
                <div class="flex items-center gap-2">
                    <i data-lucide="flask-conical" class="w-4 h-4 text-primary"></i>
                    <span class="text-sm font-medium truncate max-w-[140px]" x-text="activeExperiment.runId"></span>
                </div>
                <div class="flex items-center gap-1">
                    <span :class="getExperimentStatusClass()" class="px-2 py-0.5 text-xs rounded-full"
                          x-text="activeExperiment.status"></span>
                    <button @click="clearActiveExperiment()"
                            class="btn-sm-icon-ghost"
                            title="Dismiss">
                        <i data-lucide="x" class="w-3 h-3"></i>
                    </button>
                </div>
            </div>

            <!-- Progress -->
            <div class="px-3 py-3 space-y-2">
                <!-- Progress Bar -->
                <div class="w-full bg-muted rounded-full h-2 overflow-hidden">
                    <div class="bg-primary h-2 rounded-full transition-all duration-300"
                         :style="`width: ${activeExperiment.percent}%`"></div>
                </div>

                <!-- Stats -->
                <div class="flex items-center justify-between text-xs text-muted-foreground">
                    <span>
                        <span x-text="activeExperiment.storiesCompleted"></span>/<span x-text="activeExperiment.storiesTotal"></span> stories
                    </span>
                    <span x-text="`${activeExperiment.percent}%`"></span>
                </div>

                <!-- Current Phase/Story -->
                <div x-show="activeExperiment.phase || activeExperiment.story" class="text-xs text-muted-foreground truncate">
                    <span x-show="activeExperiment.phase" x-text="activeExperiment.phase"></span>
                    <span x-show="activeExperiment.story">
                        - <span x-text="activeExperiment.story"></span>
                    </span>
                </div>

                <!-- Cancel Button -->
                <button x-show="hasActiveExperiment()"
                        @click="cancelExperiment()"
                        class="btn-outline btn-destructive w-full text-sm"
                        data-testid="cancel-experiment-btn">
                    <i data-lucide="square" class="w-3 h-3 mr-1"></i>
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Component scripts (load before alpine-init.js orchestrator) -->
    <script src="/js/utils.js"></script>
    <!-- Shiki highlighter - ESM module for CDN imports (Story 23.3) -->
    <script src="/js/shiki-highlighter.js" type="module"></script>
    <script src="/js/components/tree-view.js"></script>
    <script src="/js/components/terminal.js"></script>
    <script src="/js/components/settings.js"></script>
    <script src="/js/components/experiments.js"></script>
    <script src="/js/components/context-menu.js"></script>
    <script src="/js/components/modals.js"></script>
    <!-- Shared content browser utilities (Story 24.1) - must load BEFORE prompt-browser.js which uses it -->
    <script src="/js/components/content-browser.js"></script>
    <!-- Epic metrics browser (Story 24.7) -->
    <script src="/js/components/epic-metrics.js"></script>
    <script src="/js/components/prompt-browser.js"></script>
    <script src="/js/components/sse-connection.js"></script>
    <script src="/js/components/loop-control.js"></script>
    <!-- Orchestrator that combines all components -->
    <script src="/js/alpine-init.js"></script>
</body>
</html>
